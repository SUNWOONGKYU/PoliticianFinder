# V40 전체 프로세스 가이드

**작성일**: 2026-02-01
**최종 업데이트**: 2026-02-06
**버전**: V40
**목적**: 정치인 정보 준비부터 상세평가보고서 생성까지 완전한 프로세스

---

## 1. V40 개요

### 핵심 변경사항

| 항목 | V30 | V40 |
|------|-----|-----|
| 수집 AI | 2개 (Gemini, Perplexity) | **2개 (Gemini, Naver)** |
| 평가 AI | 4개 | **4개 (Claude, ChatGPT, Gemini, Grok)** |
| 수집 방식 | 웹검색 필수 | **웹검색 필수** |
| 수집 개수 | 50개/카테고리 | **100개/카테고리 (버퍼 20% 포함 최대 120개)** |
| 데이터 유형 | OFFICIAL/PUBLIC 분리 | **OFFICIAL/PUBLIC 분리** |
| 평가 방식 | 풀링 평가 | **풀링 평가** |

### 수집 배분

```
Gemini  50% = OFFICIAL 30개 (30%) + PUBLIC 20개 (20%)
Naver   50% = OFFICIAL 10개 (10%) + PUBLIC 40개 (40%)
─────────────────────────────────────────
합계   100% = 100개/카테고리 (버퍼 20% 포함 최대 120개)

📌 OFFICIAL vs PUBLIC:
- OFFICIAL (40개): 객관적 사실
  Gemini 30개 (30%) + Naver 10개 (10%)

- PUBLIC (60개): 의견/평가
  Gemini 20개 (20%) + Naver 40개 (40%)

⚠️ Claude/ChatGPT/Grok = 수집 제외 → 평가만 담당
```

### AI별 수집/평가 역할

| AI | 수집 | 평가 | 비고 |
|---|---|---|---|
| **Gemini** | ✅ 50% | ✅ | Google Search **무료** ✅ |
| **Naver** | ✅ 50% | ❌ | Naver Search **무료** ✅ |
| **Claude** | ❌ | ✅ | **$0** (Subscription Mode) |
| **ChatGPT** | ❌ | ✅ | 평가만 |
| **Grok** | ❌ | ✅ | 평가만 |

---

## 2. 사전 준비

### 2.1 API 키 설정

`.env` 파일에 다음 키 설정:

```bash
# 수집용 (2개)
GEMINI_API_KEY=AIza...           # Gemini (50% 수집 + 평가) - 무료
NAVER_CLIENT_ID=...              # Naver (50% 수집) - 무료
NAVER_CLIENT_SECRET=...          # Naver (50% 수집) - 무료

# 평가용 (3개) - 수집 제외
ANTHROPIC_API_KEY=sk-ant-...     # Claude (평가만, Subscription Mode)
OPENAI_API_KEY=sk-...            # ChatGPT (평가만)
XAI_API_KEY=xai-...              # Grok (평가만)

# Supabase
SUPABASE_URL=https://...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
```

### 2.2 데이터베이스 테이블 생성

```sql
-- V40 수집 데이터 테이블
CREATE TABLE IF NOT EXISTS collected_data_v40 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL,
    politician_name TEXT NOT NULL,
    category TEXT NOT NULL,
    data_type TEXT NOT NULL,           -- 'official' or 'public'
    collector_ai TEXT NOT NULL,        -- 'Gemini', 'Naver'
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    source_url TEXT NOT NULL,
    source_name TEXT,
    published_date DATE,
    sentiment TEXT,                    -- 'positive', 'negative', 'neutral', 'free'
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- V40 평가 테이블
CREATE TABLE IF NOT EXISTS evaluations_v40 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL,
    politician_name TEXT NOT NULL,
    category TEXT NOT NULL,
    collected_data_id UUID NOT NULL,
    evaluator_ai TEXT NOT NULL,        -- 'Claude', 'ChatGPT', 'Gemini', 'Grok'
    rating TEXT NOT NULL,              -- '+4' ~ '-4'
    score INTEGER NOT NULL,            -- -8 ~ +8
    reasoning TEXT,
    evaluated_at TIMESTAMPTZ DEFAULT NOW()
);

-- V40 카테고리 점수 테이블
CREATE TABLE IF NOT EXISTS ai_category_scores_v40 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL,
    politician_name TEXT NOT NULL,
    category TEXT NOT NULL,
    score INTEGER NOT NULL,
    ai_details JSONB,
    calculated_at TIMESTAMPTZ DEFAULT NOW()
);

-- V40 최종 점수 테이블
CREATE TABLE IF NOT EXISTS ai_final_scores_v40 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL,
    politician_name TEXT NOT NULL,
    final_score INTEGER NOT NULL,
    grade TEXT NOT NULL,
    category_scores JSONB,
    calculated_at TIMESTAMPTZ DEFAULT NOW(),
    version TEXT DEFAULT 'V40'
);

-- 인덱스
CREATE INDEX IF NOT EXISTS idx_v40_collected_politician ON collected_data_v40(politician_id);
CREATE INDEX IF NOT EXISTS idx_v40_collected_category ON collected_data_v40(category);
CREATE INDEX IF NOT EXISTS idx_v40_eval_politician ON evaluations_v40(politician_id);
```

### 2.3 의존성 설치

```bash
pip install anthropic openai google-generativeai supabase python-dotenv json-repair
```

---

## 3. 전체 프로세스 (7단계)

### 📊 프로세스 개요

```
정치인 정보 작성 (MD) → DB 등록 → 데이터 수집 (1,000개)
→ 검증 → AI 평가 (4,000개) → 평가 검증 → 점수 계산 → 보고서 생성
```

### 상세 프로세스

```
┌─────────────────────────────────────────────────────────────┐
│ [Phase 1] 준비 - 정치인 정보 작성 및 DB 등록                │
│                                                             │
│ 1. instructions/1_politicians/{정치인명}.md 작성            │
│    - 이름, 생년월일, 직위, 정당, 학력, 경력 등              │
│                                                             │
│ 2. politicians 테이블에 INSERT                              │
│    - id (TEXT, 8자리 hex), name, party, position 등        │
│                     ↓                                       │
├─────────────────────────────────────────────────────────────┤
│ [Phase 2] 수집 - collect_v40.py (2개 AI)                    │
│                                                             │
│ Gemini      ──┬── OFFICIAL 30개 (Google Search 무료)       │
│               └── PUBLIC 20개 (Google Search 기반)         │
│                                                             │
│ Naver       ──┬── OFFICIAL 10개 (Naver Search 무료)        │
│               └── PUBLIC 40개 (Naver Search 기반)          │
│                                                             │
│ ⚠️ Claude/ChatGPT/Grok = 수집 제외 (평가만)               │
│                     ↓                                       │
│            collected_data_v40 저장                          │
├─────────────────────────────────────────────────────────────┤
│ [Phase 3] 검증 & 재수집 - validate_v40.py                   │
│                                                             │
│ 검증 항목:                                                  │
│ ✓ URL 실제 존재 여부 (HEAD/GET 요청)                       │
│ ✓ data_type 규칙 (OFFICIAL/PUBLIC 도메인 매칭)             │
│ ✓ 필수 필드 검증 (title, content, source_url)              │
│ ✓ 기간 제한 검증 (공식 4년, 공개 2년)                      │
│ ✓ 가짜 URL 패턴 탐지                                       │
│                     ↓                                       │
│ 검증 실패 → 삭제 → 해당 AI로 재수집 (최대 5회 반복)        │
├─────────────────────────────────────────────────────────────┤
│ [Phase 3-2] 풀링 & 고급 중복 제거 ✨                        │
│                                                             │
│ 2개 AI 수집 데이터 통합                                     │
│                                                             │
│ 🔥 고급 중복 검사 (URL + 제목):                             │
│ 1. URL 정규화 (파라미터, 앵커 제거)                         │
│    - https://namu.wiki/w/XX?rev=456 → https://namu.wiki/w/XX│
│    - https://news.com/art#s-1 → https://news.com/art        │
│                                                             │
│ 2. 제목 정규화 (공백, 특수문자 제거)                        │
│    - "김민석/비판 및 논란" → "김민석비판및논란"             │
│                                                             │
│ 3. 중복 판단 기준:                                          │
│    - 같은 AI + (같은 URL OR 제목 95% 유사) → 중복 제거     │
│    - 다른 AI + 같은 URL/제목 → 모두 유지 (자연 가중치)     │
├─────────────────────────────────────────────────────────────┤
│ [Phase 4] 평가 - evaluate_v40.py (4개 AI)                   │
│                                                             │
│ Claude     ──┬── 풀링된 전체 데이터 평가                   │
│ ChatGPT    ──┤  (Subscription Mode: API 비용 $0)          │
│ Gemini     ──┤                                             │
│ Grok       ──┘                                             │
│                     ↓                                       │
│            evaluations_v40 저장                             │
│            (collected_data_id로 수집 데이터와 연결)         │
├─────────────────────────────────────────────────────────────┤
│ [Phase 5] 평가 검증 - 자동 처리                             │
│                                                             │
│ 평가 완성도 확인:                                            │
│ ✓ 기준: 97% 이상 (4,000개 중 3,880개 이상)                  │
│ ✓ 계산: (평가 개수 / 4,000) × 100                           │
│ ✓ 미달 시: 누락 평가 재실행 (자동)                          │
│                     ↓                                       │
├─────────────────────────────────────────────────────────────┤
│ [Phase 6] 점수 계산 - calculate_v40_scores.py               │
│                                                             │
│ 4개 AI 평가 결과 종합 → 카테고리 점수 → 최종 점수          │
│                     ↓                                       │
│   ai_category_scores_v40, ai_final_scores_v40 저장         │
│   (AI별 점수 JSONB 저장)                                    │
├─────────────────────────────────────────────────────────────┤
│ [Phase 7] 보고서 생성 - generate_report_v40.py              │
│                                                             │
│ 1. 4개 테이블 조인 (politicians + collected_data_v40 +      │
│    evaluations_v40 + ai_final_scores_v40)                   │
│                                                             │
│ 2. AI별 통계 계산                                            │
│    - AI별 평균 등급, X 비율, 긍정/부정 비율                 │
│    - AI별 평가 성향 분석                                     │
│                                                             │
│ 3. 카테고리별 분석 (10개)                                    │
│    - AI별 점수 비교                                          │
│    - 대표 긍정/부정 평가 사례                                │
│                                                             │
│ 4. 마크다운 보고서 생성                                      │
│    - 종합 개요 (최종 점수, AI별 점수, 카테고리 점수)        │
│    - AI별 비교 분석                                          │
│    - 카테고리별 상세 평가                                    │
│    - 데이터 출처 분석                                        │
│                     ↓                                       │
│ 5. 파일 저장                                                 │
│    AI_기반_정치인_상세평가보고서_{정치인명}_{날짜}.md       │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 실행 방법

### 4.1 수집 (collect_v40.py)

```bash
# 전체 수집 (Gemini + Naver)
python collect_v40.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --parallel

# 특정 AI만
python collect_v40.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --ai=Gemini

python collect_v40.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --ai=Naver

# 특정 카테고리만
python collect_v40.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --category=1  # 1=expertise

# 미니 테스트 (카테고리당 10개)
python collect_v40.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --test
```

### 4.2 평가 (Claude Subscription Mode)

#### 방법 1: evaluate_claude_auto.py (권장)

```bash
# 1. 평가 작업 생성
python evaluate_claude_auto.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --category=communication \
  --output=eval_communication.md

# 2. 평가 수행 (Claude Code에게 요청)
"eval_communication.md 파일의 평가 작업을 수행해주세요"

# 3. DB 저장
python evaluate_claude_auto.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --category=communication \
  --import_results=eval_communication_result.json
```

#### 방법 2: evaluate_v40.py (기존 방식)

```bash
# 4개 AI 평가 (병렬)
python evaluate_v40.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --parallel
```

### 4.3 점수 계산 (calculate_v40_scores.py)

```bash
python calculate_v40_scores.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희"
```

### 4.4 결과 확인 (check_v40_results.py)

```bash
# 전체 결과 확인
python check_v40_results.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희"
```

---

## 5. 수집 상세

### 5.1 OFFICIAL vs PUBLIC 분담

#### OFFICIAL (40개) - Gemini 30 + Naver 10

**특징**:
- 객관적 사실 (누가 수집하든 동일)
- 편향 발생 여지 없음
- .go.kr 도메인 등 공식 사이트

**소스 예시**:
- 국회 의안정보 (assembly.go.kr)
- 정부 보도자료 (korea.kr)
- 선거관리위원회 (nec.go.kr)
- 정당 공식 사이트

#### PUBLIC (60개) - Gemini 20 + Naver 40

**특징**:
- 의견/평가 (출처마다 시각 다름)
- 편향 발생 가능
- 다양성 필요

**Gemini PUBLIC (20개)**:
- Google Search 기반
- 모든 PUBLIC 소스 자유

**Naver PUBLIC (40개)**:
- Naver Search 기반
- 모든 PUBLIC 소스 자유

**⚠️ 소스 제한 원칙**:
제한은 딱 2개만:
1. OFFICIAL은 OFFICIAL 소스만
2. PUBLIC은 PUBLIC 소스만

그 외 소스 제한/차단/금지 일체 없음

### 5.2 센티멘트 배분 (OFFICIAL 10-10-80 / PUBLIC 20-20-60)

```python
SENTIMENT_DISTRIBUTION = {
    "Gemini": {
        "official": {"negative": 3, "positive": 3, "free": 24},    # 30개 (10-10-80)
        "public": {"negative": 4, "positive": 4, "free": 12}       # 20개 (20-20-60)
    },
    "Naver": {
        "official": {"negative": 1, "positive": 1, "free": 8},     # 10개 (10-10-80)
        "public": {"negative": 8, "positive": 8, "free": 24}       # 40개 (20-20-60)
    }
}

# OFFICIAL 데이터 (40개):
# 부정: 3+1 = 4개 (10%)
# 긍정: 3+1 = 4개 (10%)
# 자유: 24+8 = 32개 (80%)

# PUBLIC 데이터 (60개):
# 부정: 4+8 = 12개 (20%)
# 긍정: 4+8 = 12개 (20%)
# 자유: 12+24 = 36개 (60%)

# 전체 균형 (100개):
# 부정: 4+12 = 16개 (16%)
# 긍정: 4+12 = 16개 (16%)
# 자유: 32+36 = 68개 (68%)
```

---

## 6. 평가 상세

### 6.1 풀링 평가 방식

```
[수집 단계]
Gemini 50개 (50%) + Naver 50개 (50%) = 100개 풀 (버퍼 20% 포함 최대 120개)
(중복 제거 안 함, 그대로 합침)

[평가 단계]
4개 AI × 100개 = 400개 평가
- Claude: 100개 평가 ($0, Subscription Mode)
- ChatGPT: 100개 평가
- Grok: 100개 평가
- Gemini: 100개 평가
```

### 6.2 평가 등급 체계

| 등급 | 판단 기준 | 점수 |
|------|-----------|------|
| +4 | 탁월함 - 해당 분야 모범 사례 | +8 |
| +3 | 우수함 - 긍정적 평가 | +6 |
| +2 | 양호함 - 기본 충족 | +4 |
| +1 | 보통 - 평균 수준 | +2 |
| -1 | 미흡함 - 개선 필요 | -2 |
| -2 | 부족함 - 문제 있음 | -4 |
| -3 | 매우 부족 - 심각한 문제 | -6 |
| -4 | 극히 부족 - 정치인 부적합 | -8 |

### 6.3 자연 가중치

- 4개 AI가 동일 뉴스 수집 → 풀에 4번 포함 → 4배 영향
- 별도 가중치 계산 불필요
- 자연스럽게 반영됨

---

## 7. 비용 분석

### 수집 비용

| AI | 카테고리당 | 정치인당 (10개) | 100명 |
|----|------------|----------------|-------|
| Gemini | $0 | $0 | **$0** |
| Naver | $0 | $0 | **$0** |
| **합계** | **$0** | **$0** | **$0** |

### 평가 비용

| AI | 항목당 | 정치인당 (1,000개) | 100명 |
|----|--------|-------------------|-------|
| Claude | $0 | **$0** | **$0** (Subscription Mode) |
| ChatGPT | TBD | TBD | TBD |
| Grok | TBD | TBD | TBD |
| Gemini | TBD | TBD | TBD |

### 총 비용

```
수집: $0/100명 (Gemini + Naver 모두 무료)
평가: $0/100명 (Claude Subscription Mode)
총: $0/100명

100% 무료 ✅
```

---

## 8. 예상 작업량

### 1명 정치인 기준

```
수집:
- Gemini: 500개 (10개 카테고리 × 50개)
- Naver: 500개 (10개 카테고리 × 50개)
- 총 1,000개 (버퍼 20% 포함 최대 1,200개)

평가:
- Claude: 1,000개 (Subscription Mode, $0)
- ChatGPT: 1,000개
- Grok: 1,000개
- Gemini: 1,000개
- 총 4,000개 평가

점수 계산:
- 10개 카테고리 점수 산출
- 최종 종합 점수 산출
```

### 100명 기준

```
수집: 100,000개 (10만개, 버퍼 20% 포함 최대 120,000개)
평가: 400,000개 (40만개)
비용: $0 (완전 무료)
```

---

## 9. 주의사항

### 9.1 수집 시

- ✅ 실제 URL 필수 (example.com 금지)
- ✅ OFFICIAL은 OFFICIAL 소스만
- ✅ PUBLIC은 PUBLIC 소스만
- ✅ 그 외 소스 제한 일체 없음
- ✅ OFFICIAL 10-10-80 / PUBLIC 20-20-60 균형 유지

### 9.2 평가 시

- ✅ Claude Subscription Mode 활용 (API 비용 $0)
- ✅ 수집 시점 ≠ 평가 시점 (세션 분리)
- ✅ 4개 AI 모두 전체 데이터 평가
- ✅ 등급 체계 준수 (+4 ~ -4)

### 9.3 비용 최적화

- ✅ Gemini 무료 (Google Search)
- ✅ Naver 무료 (Naver Search API)
- ✅ Claude Subscription Mode ($0)
- ✅ 완전 무료 시스템

---

## 10. 데이터베이스 테이블 관계

```
politicians (정치인 기본 정보)
    ↓ 1:N
collected_data_v40 (수집 데이터, rating 없음)
    ↓ 1:N (collected_data_id로 연결)
evaluations_v40 (평가 결과, rating 있음)

politicians
    ↓ 1:1
ai_final_scores_v40 (최종 점수, JSONB)
```

**핵심:**
- `collected_data_v40.id` → `evaluations_v40.collected_data_id` (FK)
- 수집 데이터 1개 → 4개 AI 평가 (4개 레코드)
- 수집 테이블: rating 없음 (수집만)
- 평가 테이블: rating 있음 (평가만)

---

## 11. 참고 문서

- `V40_기본방침.md` - 핵심 지침
- `V40_오케스트레이션_가이드.md` - 자동화 가이드
- `V40_완전한_프로세스_플로우차트.md` - 전체 프로세스 시각화 ⭐
- `AI_기반_정치인_상세평가보고서_생성_가이드_V40.md` - 보고서 생성
- `Claude_Subscription_Mode_평가_적용방법.md` - 평가 방법

---

**최종 업데이트**: 2026-02-06
**버전**: V40
