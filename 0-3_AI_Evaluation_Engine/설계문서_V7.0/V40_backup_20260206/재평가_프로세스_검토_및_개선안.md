# V40 ì¬í‰ê°€ í”„ë¡œì„¸ìŠ¤ ê²€í†  ë° ê°œì„ ì•ˆ

**ì‘ì„±ì¼**: 2026-01-25
**ëŒ€ìƒ**: 1,000ê°œ ë°ì´í„° Ã— 4ê°œ AI = 4,000ê°œ í‰ê°€
**í˜„ì¬ ë²„ì „**: run_v40_workflow.py + evaluate_v40.py

---

## ëª©ì°¨

1. [í˜„ì¬ í”„ë¡œì„¸ìŠ¤ ë¶„ì„](#1-í˜„ì¬-í”„ë¡œì„¸ìŠ¤-ë¶„ì„)
2. [ë¬¸ì œì  ì‹ë³„](#2-ë¬¸ì œì -ì‹ë³„)
3. [1000ê°œ ëŒ€ì‘ ê²€ì¦](#3-1000ê°œ-ëŒ€ì‘-ê²€ì¦)
4. [ê°œì„ ì•ˆ (ìš°ì„ ìˆœìœ„ë³„)](#4-ê°œì„ ì•ˆ-ìš°ì„ ìˆœìœ„ë³„)
5. [Claude Subscription Mode ì¬í‰ê°€](#5-claude-subscription-mode-ì¬í‰ê°€)
6. [ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ì½”ë“œ](#6-ì¦‰ì‹œ-ì ìš©-ê°€ëŠ¥í•œ-ì½”ë“œ)

---

## 1. í˜„ì¬ í”„ë¡œì„¸ìŠ¤ ë¶„ì„

### 1.1 ì „ì²´ ì›Œí¬í”Œë¡œìš° íë¦„ë„

```
[run_v40_workflow.py]

ë‹¨ê³„ 1: ìˆ˜ì§‘ (collect_v40.py)
â”œâ”€ 4ê°œ AI Ã— 10ê°œ ì¹´í…Œê³ ë¦¬ Ã— 100ê°œ = 4,000ê°œ ìˆ˜ì§‘ ëª©í‘œ
â””â”€ ì‹¤ì œ: ~1,000ê°œ (ì¤‘ë³µ ì œê±° í›„)

ë‹¨ê³„ 2: ìˆ˜ì§‘ í’ˆì§ˆ ê²€ì¦ (check_collection_quality)
â”œâ”€ ìˆ˜ì§‘ ê°œìˆ˜ í™•ì¸: SELECT COUNT(*) FROM collected_data_v40
â”œâ”€ í’ˆì§ˆ ê¸°ì¤€: 110% ì´ë‚´ (1,100ê°œ ì´í•˜)
â””â”€ ìµœì†Œ ê¸°ì¤€: 100ê°œ ì´ìƒ

ë‹¨ê³„ 3: ë°ì´í„° ê²€ì¦ ë° ì¬ìˆ˜ì§‘ (validate_v40.py)
â”œâ”€ URL ì¡´ì¬ ì—¬ë¶€ í™•ì¸
â”œâ”€ ë„ë©”ì¸ ìœ íš¨ì„± ê²€ì‚¬
â”œâ”€ ê¸°ê°„ ì œí•œ ê²€ì¦
â”œâ”€ ì¤‘ë³µ ì œê±° (ê°™ì€ AI + ê°™ì€ URL)
â””â”€ ê²€ì¦ ì‹¤íŒ¨ ì‹œ ìë™ ì¬ìˆ˜ì§‘

ë‹¨ê³„ 4: í‰ê°€ (evaluate_v40.py)
â”œâ”€ 4ê°œ AIê°€ ê°ê° 1,000ê°œ ì „ì²´ í‰ê°€
â”œâ”€ Claude: Subscription Mode (ìˆ˜ë™ ë°°ì¹˜)
â”œâ”€ ChatGPT/Gemini/Grok: API ìë™ í‰ê°€
â””â”€ ê²°ê³¼: evaluations_v40 í…Œì´ë¸”ì— ì €ì¥

ë‹¨ê³„ 5: í‰ê°€ í’ˆì§ˆ ê²€ì¦ (check_evaluation_quality) âš ï¸ í•µì‹¬
â”œâ”€ ìˆ˜ì§‘ ê°œìˆ˜ ì¡°íšŒ: collected_count
â”œâ”€ í‰ê°€ ê°œìˆ˜ ì¡°íšŒ: eval_count
â”œâ”€ ê¸°ëŒ€ í‰ê°€: expected = collected_count Ã— 4
â”œâ”€ ì™„ì„±ë„: completion = eval_count / expected Ã— 100
â””â”€ í’ˆì§ˆ ê¸°ì¤€: 97% ì´ìƒ

ë‹¨ê³„ 6: ì¬í‰ê°€ (reevaluate_missing) âš ï¸ í•µì‹¬
â”œâ”€ ëˆ„ë½ í‰ê°€ ì°¾ê¸° (get_missing_evaluations)
â”‚  â”œâ”€ ëª¨ë“  collected_data ì¡°íšŒ (í˜ì´ì§•: 1000ê°œì”©)
â”‚  â”œâ”€ ëª¨ë“  evaluations ì¡°íšŒ (í˜ì´ì§•: 1000ê°œì”©)
â”‚  â”œâ”€ collected_data_idë³„ í‰ê°€ AI ë§¤í•‘
â”‚  â””â”€ 4ê°œ AI ì¤‘ ëˆ„ë½ëœ ê²ƒ ì°¾ê¸°
â”‚
â”œâ”€ evaluate_v40.py ì¬ì‹¤í–‰
â”‚  â””â”€ check_already_evaluatedë¡œ ëˆ„ë½ ìë™ ê°ì§€
â”‚
â””â”€ ì¬í™•ì¸ (get_missing_evaluations)
   â””â”€ ë‚¨ì€ ëˆ„ë½ > 0 â†’ ê²½ê³ 

ë‹¨ê³„ 7: ì ìˆ˜ ê³„ì‚° (calculate_v40_scores.py)
â””â”€ ì¹´í…Œê³ ë¦¬ë³„/ìµœì¢… ì ìˆ˜ ê³„ì‚°
```

### 1.2 í•µì‹¬ í•¨ìˆ˜ ìƒì„¸ ë¶„ì„

#### check_evaluation_quality (Line 105-133)

**ì…ë ¥**: politician_id
**ì¶œë ¥**: True/False (97% ê¸°ì¤€)

```python
def check_evaluation_quality(politician_id):
    # ìˆ˜ì§‘ ë°ì´í„° ê°œìˆ˜
    collected_result = supabase.table('collected_data_v40')
        .select('id', count='exact')
        .eq('politician_id', politician_id)
        .execute()
    collected_count = collected_result.count  # ì˜ˆ: 1,000ê°œ

    # í‰ê°€ ë°ì´í„° ê°œìˆ˜
    eval_result = supabase.table('evaluations_v40')
        .select('id', count='exact')
        .eq('politician_id', politician_id)
        .execute()
    eval_count = eval_result.count  # ì˜ˆ: 3,880ê°œ

    # ê¸°ëŒ€ í‰ê°€ ê°œìˆ˜
    expected = collected_count * 4  # ì˜ˆ: 4,000ê°œ

    completion = eval_count / expected * 100  # ì˜ˆ: 97%

    return completion >= 97
```

**ì„±ëŠ¥ ë¶„ì„**:
- COUNT ì¿¼ë¦¬: O(1) - ì¸ë±ìŠ¤ ì‚¬ìš©, ë§¤ìš° ë¹ ë¦„
- ë„¤íŠ¸ì›Œí¬ ì™•ë³µ: 2ë²ˆ (collected_data_v40, evaluations_v40)
- **ì˜ˆìƒ ì†Œìš” ì‹œê°„**: ~1ì´ˆ

**ë¬¸ì œì **:
- âŒ **ì •í™•ë„ ì´ìŠˆ**: 97% ê¸°ì¤€ì´ ì• ë§¤í•¨
  - ì˜ˆ: 3,880/4,000 = 97% â†’ í†µê³¼
  - í•˜ì§€ë§Œ íŠ¹ì • AIê°€ ì™„ì „íˆ ëˆ„ë½ë˜ì–´ë„ í†µê³¼ ê°€ëŠ¥
  - ì˜ˆ: Claude 0ê°œ, ChatGPT 1,000ê°œ, Gemini 1,000ê°œ, Grok 1,880ê°œ = 97%

#### get_missing_evaluations (Line 136-191)

**ì…ë ¥**: politician_id
**ì¶œë ¥**: missing ë¦¬ìŠ¤íŠ¸ [{item, ai}, ...]

```python
def get_missing_evaluations(politician_id):
    # 1. ëª¨ë“  ìˆ˜ì§‘ ë°ì´í„° ì¡°íšŒ (í˜ì´ì§•)
    all_collected = []
    offset = 0
    while True:
        result = supabase.table('collected_data_v40')
            .select('*')
            .eq('politician_id', politician_id)
            .range(offset, offset + 999)
            .execute()

        if not result.data:
            break

        all_collected.extend(result.data)
        offset += 1000

        if len(result.data) < 1000:
            break
    # ì˜ˆ: 1,000ê°œ ìˆ˜ì§‘ â†’ 2ë²ˆ ì¿¼ë¦¬ (0-999, 1000-1999ëŠ” ì—†ìŒ)

    # 2. ëª¨ë“  í‰ê°€ ë°ì´í„° ì¡°íšŒ (í˜ì´ì§•)
    all_evals = []
    offset = 0
    while True:
        result = supabase.table('evaluations_v40')
            .select('collected_data_id, evaluator_ai')
            .eq('politician_id', politician_id)
            .range(offset, offset + 999)
            .execute()

        if not result.data:
            break

        all_evals.extend(result.data)
        offset += 1000

        if len(result.data) < 1000:
            break
    # ì˜ˆ: 3,880ê°œ í‰ê°€ â†’ 4ë²ˆ ì¿¼ë¦¬ (0-999, 1000-1999, 2000-2999, 3000-3879)

    # 3. collected_data_idë³„ í‰ê°€ AI ë§¤í•‘
    from collections import defaultdict
    cid_to_ais = defaultdict(set)
    for ev in all_evals:  # 3,880ë²ˆ ìˆœíšŒ
        cid = ev.get('collected_data_id')
        ai = ev.get('evaluator_ai')
        if cid and ai:
            cid_to_ais[cid].add(ai)

    # 4. ëˆ„ë½ ì°¾ê¸°
    missing = []
    for item in all_collected:  # 1,000ë²ˆ ìˆœíšŒ
        cid = item.get('id')
        evaluated_by = cid_to_ais.get(cid, set())

        for ai in EVALUATION_AIS:  # 4ë²ˆ ìˆœíšŒ
            if ai not in evaluated_by:
                missing.append({
                    'item': item,
                    'ai': ai
                })

    return missing  # ì˜ˆ: 120ê°œ
```

**ì„±ëŠ¥ ë¶„ì„**:
- ì¿¼ë¦¬ íšŸìˆ˜: ìˆ˜ì§‘ 2ë²ˆ + í‰ê°€ 4ë²ˆ = **6ë²ˆ**
- ë°ì´í„° ì „ì†¡ëŸ‰: 1,000ê°œ Ã— ì „ì²´ ì»¬ëŸ¼ + 3,880ê°œ Ã— 2ê°œ ì»¬ëŸ¼ = **~5MB**
- ë©”ëª¨ë¦¬ ì‚¬ìš©: 1,000ê°œ + 3,880ê°œ = **~10MB**
- ìˆœíšŒ íšŸìˆ˜: 3,880 + (1,000 Ã— 4) = **7,880ë²ˆ**
- **ì˜ˆìƒ ì†Œìš” ì‹œê°„**: ~5ì´ˆ

**ë¬¸ì œì **:
- âš ï¸ **ë¹„íš¨ìœ¨**: ì „ì²´ ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œ
- âš ï¸ **í™•ì¥ì„±**: 10,000ê°œ ë°ì´í„°ë¼ë©´ 40,000ê°œ í‰ê°€ ì¡°íšŒ â†’ 40ë²ˆ ì¿¼ë¦¬, 50MB ì „ì†¡

#### reevaluate_missing (Line 194-229)

**ì…ë ¥**: politician_id, politician_name, parallel
**ì¶œë ¥**: True/False

```python
def reevaluate_missing(politician_id, politician_name, parallel=False):
    # 1. ëˆ„ë½ ì°¾ê¸°
    missing = get_missing_evaluations(politician_id)

    if not missing:
        return True

    # 2. evaluate_v40.py ì¬ì‹¤í–‰
    parallel_flag = "--parallel" if parallel else ""
    cmd = f'python evaluate_v40.py --politician_id={politician_id} --politician_name="{politician_name}" {parallel_flag}'

    success = run_command(cmd, "evaluate_v40.py ì¬ì‹¤í–‰")

    if not success:
        return False

    # 3. ì¬í™•ì¸
    remaining = get_missing_evaluations(politician_id)

    return len(remaining) == 0
```

**í”„ë¡œì„¸ìŠ¤**:
1. `get_missing_evaluations` í˜¸ì¶œ â†’ 120ê°œ ëˆ„ë½ ë°œê²¬ (~5ì´ˆ)
2. `evaluate_v40.py` ì¬ì‹¤í–‰ â†’ ì „ì²´ í‰ê°€ ë‹¤ì‹œ ì²´í¬ (~10ë¶„)
3. `get_missing_evaluations` ì¬í˜¸ì¶œ â†’ 0ê°œ í™•ì¸ (~5ì´ˆ)

**ë¬¸ì œì **:
- âŒ **ì¤‘ë³µ ì‘ì—…**: evaluate_v40.pyê°€ ë‚´ë¶€ì ìœ¼ë¡œ check_already_evaluated í˜¸ì¶œ
  - reevaluate_missingì´ ì´ë¯¸ ëˆ„ë½ì„ ì°¾ì•˜ëŠ”ë°
  - evaluate_v40.pyê°€ ë‹¤ì‹œ ì „ì²´ ì²´í¬
- âŒ **ë¹„íš¨ìœ¨**: 120ê°œë§Œ í‰ê°€í•˜ë©´ ë˜ëŠ”ë° ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰

---

## 2. ë¬¸ì œì  ì‹ë³„

### 2.1 ì„±ëŠ¥ ë¬¸ì œ

#### ë¬¸ì œ 1: ëŒ€ëŸ‰ ë°ì´í„° ì¡°íšŒ ë¹„íš¨ìœ¨

**í˜„ìƒ**:
```python
# get_missing_evaluationsê°€ ì „ì²´ ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œ
all_collected = []  # 1,000ê°œ
all_evals = []      # 3,880ê°œ
```

**ì˜í–¥**:
- 1,000ê°œ ë°ì´í„°: ~5ì´ˆ ì†Œìš”
- 10,000ê°œ ë°ì´í„°: ~50ì´ˆ ì†Œìš” (10ë°° ì¦ê°€)
- 100,000ê°œ ë°ì´í„°: ~8ë¶„ ì†Œìš” (100ë°° ì¦ê°€)

**ê·¼ë³¸ ì›ì¸**:
- í˜ì´ì§• ì¿¼ë¦¬ ë°˜ë³µ (1,000ê°œì”©)
- ì „ì²´ ì»¬ëŸ¼ ì¡°íšŒ (`SELECT *`)
- ë©”ëª¨ë¦¬ ë‚´ ì¤‘ì²© ìˆœíšŒ

#### ë¬¸ì œ 2: ì¤‘ë³µ ì²´í¬ ì˜¤ë²„í—¤ë“œ

**í˜„ìƒ**:
```python
# reevaluate_missing ì‹¤í–‰ ì‹œ
get_missing_evaluations()  # 1íšŒ: 5ì´ˆ
evaluate_v40.py ì¬ì‹¤í–‰      # ë‚´ë¶€ì—ì„œ check_already_evaluated Ã— 40íšŒ: 10ì´ˆ
get_missing_evaluations()  # 2íšŒ: 5ì´ˆ
ì´ 20ì´ˆ + í‰ê°€ ì‹œê°„
```

**ì˜í–¥**:
- ì¬í‰ê°€ ì‹œì‘ ì „ 5ì´ˆ ëŒ€ê¸°
- ì¬í‰ê°€ ì¤‘ 10ì´ˆ ì²´í¬ (evaluate_v40.py)
- ì¬í‰ê°€ í›„ 5ì´ˆ ì¬í™•ì¸
- **ì´ 20ì´ˆì˜ ë¶ˆí•„ìš”í•œ ì˜¤ë²„í—¤ë“œ**

#### ë¬¸ì œ 3: evaluate_v40.py ì „ì²´ ì¬ì‹¤í–‰

**í˜„ìƒ**:
```python
# 120ê°œë§Œ ëˆ„ë½ë˜ì–´ë„ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
cmd = f'python evaluate_v40.py --politician_id={id} --politician_name="{name}"'
# evaluate_v40.pyê°€ 10ê°œ ì¹´í…Œê³ ë¦¬ Ã— 4ê°œ AI = 40ë²ˆ check_already_evaluated ì‹¤í–‰
```

**ì˜í–¥**:
- ëˆ„ë½ëœ 120ê°œë§Œ í‰ê°€í•˜ë©´ ë˜ëŠ”ë°
- ì „ì²´ 40ë²ˆ ì²´í¬ í›„ 120ê°œ í‰ê°€
- **10ë°° ì´ìƒì˜ ë¶ˆí•„ìš”í•œ ì‘ì—…**

### 2.2 ë…¼ë¦¬ì  ë¬¸ì œ

#### ë¬¸ì œ 4: 97% ê¸°ì¤€ì˜ í—ˆì 

**í˜„ìƒ**:
```python
completion = eval_count / expected * 100
if completion < 97:
    ì¬í‰ê°€ í•„ìš”
```

**ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤**:
```
Case 1: ê³¨ê³ ë£¨ ëˆ„ë½ (ì •ìƒ)
- Claude: 970/1000 (97%)
- ChatGPT: 970/1000 (97%)
- Gemini: 970/1000 (97%)
- Grok: 970/1000 (97%)
â†’ 3,880/4,000 = 97% â†’ í†µê³¼ âœ…

Case 2: íŠ¹ì • AI ì™„ì „ ëˆ„ë½ (ë¹„ì •ìƒ)
- Claude: 0/1000 (0%)
- ChatGPT: 1000/1000 (100%)
- Gemini: 1000/1000 (100%)
- Grok: 1880/1000 (188% - ì˜¤ë¥˜?)
â†’ 3,880/4,000 = 97% â†’ í†µê³¼ âœ… (ë¬¸ì œ!)

Case 3: íŠ¹ì • ì¹´í…Œê³ ë¦¬ ì™„ì „ ëˆ„ë½ (ë¹„ì •ìƒ)
- expertise: 0/1000 (0%)
- ë‚˜ë¨¸ì§€ 9ê°œ: ê° 430/1000 (43%)
â†’ 3,880/4,000 = 97% â†’ í†µê³¼ âœ… (ë¬¸ì œ!)
```

**ê°œì„  í•„ìš”**:
- AIë³„ ì™„ì„±ë„ ì²´í¬
- ì¹´í…Œê³ ë¦¬ë³„ ì™„ì„±ë„ ì²´í¬
- ìµœì†Œ ì„ê³„ê°’ ì„¤ì • (ì˜ˆ: ê° AI 90% ì´ìƒ)

#### ë¬¸ì œ 5: check_already_evaluatedì˜ ë¶ˆì™„ì „ì„±

**í˜„ì¬ ë¡œì§** (evaluate_v40.py Line 627-666):
```python
def check_already_evaluated(politician_id, evaluator_ai, category_name):
    # í‰ê°€ëœ ê°œìˆ˜
    evaluated_count = COUNT(*) FROM evaluations_v40
        WHERE politician_id = X AND evaluator_ai = Y AND category = Z

    # ìˆ˜ì§‘ëœ ê°œìˆ˜
    collected_count = COUNT(*) FROM collected_data_v40
        WHERE politician_id = X AND category = Z

    # ì •í™•íˆ ì¼ì¹˜í•´ì•¼ ì™„ë£Œ
    return evaluated_count == collected_count
```

**ë¬¸ì œ**:
```
Scenario: Grokì´ expertiseë¥¼ 120/100ê°œ í‰ê°€ (ì¤‘ë³µ í‰ê°€)
- collected_count = 100
- evaluated_count = 120
- 120 == 100 â†’ False â†’ ì¬í‰ê°€ ì‹œë„
â†’ í•˜ì§€ë§Œ ì´ë¯¸ 100ê°œ ëª¨ë‘ í‰ê°€ë¨ (ì¤‘ë³µë§Œ ìˆìŒ)
â†’ ì¬í‰ê°€í•´ë„ ì¤‘ë³µë§Œ ì¶”ê°€ë¨

Scenario: Claudeê°€ expertiseë¥¼ 80/100ê°œ í‰ê°€ (ë¶€ë¶„ ì™„ë£Œ)
- collected_count = 100
- evaluated_count = 80
- 80 == 100 â†’ False â†’ ì¬í‰ê°€ í•„ìš” âœ…
â†’ ì •ìƒ ê°ì§€
```

**ê°œì„  í•„ìš”**:
- ì¤‘ë³µ í‰ê°€ ê°ì§€
- ëˆ„ë½ í‰ê°€ë§Œ ì¬í‰ê°€ (ì „ì²´ ì¬í‰ê°€ X)

### 2.3 í™•ì¥ì„± ë¬¸ì œ

#### ë¬¸ì œ 6: 1,000ê°œ â†’ 10,000ê°œ ìŠ¤ì¼€ì¼ì—… ì‹œ

**ì˜ˆìƒ ì„±ëŠ¥**:

| ì‘ì—… | 1,000ê°œ | 10,000ê°œ | ì¦ê°€ìœ¨ |
|------|---------|----------|--------|
| check_evaluation_quality | 1ì´ˆ | 1ì´ˆ | 1Ã— (OK) |
| get_missing_evaluations | 5ì´ˆ | 50ì´ˆ | 10Ã— (ë¬¸ì œ) |
| evaluate_v40.py ì¬ì‹¤í–‰ | 10ë¶„ | 100ë¶„ | 10Ã— (ë¬¸ì œ) |
| **ì´ ì¬í‰ê°€ ì‹œê°„** | **10ë¶„** | **102ë¶„** | **10Ã—** |

**ê·¼ë³¸ ì›ì¸**:
- O(n) ë³µì¡ë„: ë°ì´í„° ê°œìˆ˜ì— ë¹„ë¡€
- ë©”ëª¨ë¦¬ ë‚´ ì „ì²´ ë¡œë“œ
- ë°˜ë³µì ì¸ DB ì¿¼ë¦¬

---

## 3. 1000ê°œ ëŒ€ì‘ ê²€ì¦

### 3.1 í˜„ì¬ ì½”ë“œ ê²€ì¦

#### âœ… check_collection_quality (ì •ìƒ)

```python
target = 1000  # âœ… 1,000ê°œ ê¸°ì¤€
collect_pct = (collected_count / target) * 100
if collect_pct > 110:  # âœ… 1,100ê°œ ì´í•˜ í—ˆìš©
    ê²½ê³ 
```

**ê²°ë¡ **: 1,000ê°œ ëŒ€ì‘ ì™„ë£Œ

#### âœ… check_evaluation_quality (ì •ìƒ)

```python
expected = collected_count * 4  # âœ… ë™ì  ê³„ì‚°
# 1,000ê°œë©´ 4,000ê°œ, 10,000ê°œë©´ 40,000ê°œ
```

**ê²°ë¡ **: 1,000ê°œ ëŒ€ì‘ ì™„ë£Œ

#### âš ï¸ get_missing_evaluations (ì„±ëŠ¥ ì €í•˜)

```python
# í˜ì´ì§•: 1,000ê°œì”©
while True:
    result = supabase.table('collected_data_v40')
        .select('*')
        .eq('politician_id', politician_id)
        .range(offset, offset + 999)
        .execute()
```

**ì˜ˆìƒ ì„±ëŠ¥**:
- 1,000ê°œ: 2ë²ˆ ì¿¼ë¦¬ (0-999, 1000-1999ëŠ” ë¹ˆ ì‘ë‹µ)
- 10,000ê°œ: 11ë²ˆ ì¿¼ë¦¬ (0-999, 1000-1999, ..., 10000-10999ëŠ” ë¹ˆ ì‘ë‹µ)

**ê²°ë¡ **: ê¸°ëŠ¥ì ìœ¼ë¡œëŠ” ë™ì‘í•˜ì§€ë§Œ ì„±ëŠ¥ ì €í•˜

#### âš ï¸ reevaluate_missing (ë§¤ìš° ëŠë¦¼)

```python
# evaluate_v40.py ì¬ì‹¤í–‰ â†’ ì „ì²´ ì²´í¬
cmd = f'python evaluate_v40.py ...'
```

**ì˜ˆìƒ ì‹œê°„**:
- 1,000ê°œ: 10ë¶„
- 10,000ê°œ: 100ë¶„ (1ì‹œê°„ 40ë¶„)

**ê²°ë¡ **: 1,000ê°œëŠ” ê°ë‹¹ ê°€ëŠ¥, 10,000ê°œëŠ” ë¹„í˜„ì‹¤ì 

### 3.2 ë³‘ëª© ì§€ì  ë¶„ì„

```
[ì¬í‰ê°€ í”„ë¡œì„¸ìŠ¤ íƒ€ì„ë¼ì¸ - 1,000ê°œ ê¸°ì¤€]

0:00  ì‹œì‘
0:01  check_evaluation_quality (1ì´ˆ) âœ… ë¹ ë¦„
0:05  get_missing_evaluations (5ì´ˆ) âš ï¸ ì¤‘ê°„
10:00 evaluate_v40.py ì¬ì‹¤í–‰ (10ë¶„) âŒ ëŠë¦¼
10:05 get_missing_evaluations (5ì´ˆ) âš ï¸ ì¤‘ê°„
10:05 ì™„ë£Œ

ì´ ì†Œìš” ì‹œê°„: 10ë¶„ 5ì´ˆ
ì‹¤ì œ í‰ê°€ ì‹œê°„: 9ë¶„ 50ì´ˆ
ì˜¤ë²„í—¤ë“œ: 15ì´ˆ (2.5%)
```

**ê²°ë¡ **:
- 1,000ê°œëŠ” ê°ë‹¹ ê°€ëŠ¥ (10ë¶„)
- í•˜ì§€ë§Œ ì˜¤ë²„í—¤ë“œ 15ì´ˆëŠ” ê°œì„  ê°€ëŠ¥
- 10,000ê°œëŠ” ë¹„í˜„ì‹¤ì  (100ë¶„ ì´ìƒ)

---

## 4. ê°œì„ ì•ˆ (ìš°ì„ ìˆœìœ„ë³„)

### 4.1 ìš°ì„ ìˆœìœ„ 1: ì¦‰ì‹œ ì ìš© (ì„±ëŠ¥ 2ë°° í–¥ìƒ)

#### ê°œì„  1: get_missing_evaluations ìµœì í™”

**í˜„ì¬**:
```python
# SELECT * â†’ ì „ì²´ ì»¬ëŸ¼ ì¡°íšŒ
all_collected = supabase.table('collected_data_v40').select('*').execute()
```

**ê°œì„ **:
```python
# í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì¡°íšŒ
all_collected = supabase.table('collected_data_v40')
    .select('id, category, collector_ai')  # âœ… í•„ìˆ˜ ì»¬ëŸ¼ë§Œ
    .eq('politician_id', politician_id)
    .execute()
```

**íš¨ê³¼**:
- ë°ì´í„° ì „ì†¡ëŸ‰: 5MB â†’ 1MB (5ë°° ê°ì†Œ)
- ì†Œìš” ì‹œê°„: 5ì´ˆ â†’ 2ì´ˆ (2.5ë°° í–¥ìƒ)

#### ê°œì„  2: AIë³„/ì¹´í…Œê³ ë¦¬ë³„ ì™„ì„±ë„ ì²´í¬

**í˜„ì¬**:
```python
completion = eval_count / expected * 100
return completion >= 97  # âŒ ì „ì²´ë§Œ ì²´í¬
```

**ê°œì„ **:
```python
def check_evaluation_quality_detailed(politician_id):
    # 1. ì „ì²´ ì™„ì„±ë„
    overall = check_overall_completion(politician_id)

    # 2. AIë³„ ì™„ì„±ë„
    ai_completion = {}
    for ai in EVALUATION_AIS:
        count = COUNT(*) FROM evaluations_v40 WHERE evaluator_ai = ai
        ai_completion[ai] = count / collected_count

    # 3. ì¹´í…Œê³ ë¦¬ë³„ ì™„ì„±ë„
    cat_completion = {}
    for cat in CATEGORIES:
        count = COUNT(*) FROM evaluations_v40 WHERE category = cat
        cat_completion[cat] = count / (collected_count_per_cat * 4)

    # 4. ê²€ì¦
    issues = []

    if overall < 0.97:
        issues.append("ì „ì²´ ì™„ì„±ë„ 97% ë¯¸ë§Œ")

    for ai, comp in ai_completion.items():
        if comp < 0.90:  # âœ… AIë³„ 90% ìµœì†Œ ê¸°ì¤€
            issues.append(f"{ai} ì™„ì„±ë„ {comp*100:.1f}% (90% ë¯¸ë§Œ)")

    for cat, comp in cat_completion.items():
        if comp < 0.90:  # âœ… ì¹´í…Œê³ ë¦¬ë³„ 90% ìµœì†Œ ê¸°ì¤€
            issues.append(f"{cat} ì™„ì„±ë„ {comp*100:.1f}% (90% ë¯¸ë§Œ)")

    return len(issues) == 0, issues
```

**íš¨ê³¼**:
- íŠ¹ì • AI ëˆ„ë½ ê°ì§€ âœ…
- íŠ¹ì • ì¹´í…Œê³ ë¦¬ ëˆ„ë½ ê°ì§€ âœ…
- ì˜¤ì§„ë¥  ê°ì†Œ âœ…

### 4.2 ìš°ì„ ìˆœìœ„ 2: ì¤‘ê¸° ê°œì„  (ì„±ëŠ¥ 10ë°° í–¥ìƒ)

#### ê°œì„  3: SQL ì§‘ê³„ ì¿¼ë¦¬ í™œìš©

**í˜„ì¬**:
```python
# Python ë©”ëª¨ë¦¬ì—ì„œ ì§‘ê³„
cid_to_ais = defaultdict(set)
for ev in all_evals:  # 3,880ë²ˆ ìˆœíšŒ
    cid_to_ais[cid].add(ai)
```

**ê°œì„ **:
```python
# SQLì—ì„œ ì§ì ‘ ì§‘ê³„
missing_query = """
SELECT cd.id, cd.category, cd.collector_ai
FROM collected_data_v40 cd
WHERE cd.politician_id = %s
  AND (
    SELECT COUNT(DISTINCT evaluator_ai)
    FROM evaluations_v40 ev
    WHERE ev.collected_data_id = cd.id
  ) < 4
"""
result = supabase.rpc('get_missing_evaluations_sql', {
    'p_politician_id': politician_id
}).execute()
```

**íš¨ê³¼**:
- ì¿¼ë¦¬ íšŸìˆ˜: 6ë²ˆ â†’ 1ë²ˆ
- ë°ì´í„° ì „ì†¡ëŸ‰: 5MB â†’ 0.1MB (50ë°° ê°ì†Œ)
- ì†Œìš” ì‹œê°„: 5ì´ˆ â†’ 0.5ì´ˆ (10ë°° í–¥ìƒ)

#### ê°œì„  4: ì¦ë¶„ ì¬í‰ê°€ (ì „ì²´ ì¬ì‹¤í–‰ X)

**í˜„ì¬**:
```python
# ì „ì²´ ì¬ì‹¤í–‰
cmd = f'python evaluate_v40.py --politician_id={id} --politician_name="{name}"'
```

**ê°œì„ **:
```python
def reevaluate_missing_incremental(politician_id, politician_name):
    # 1. ëˆ„ë½ í‰ê°€ ì°¾ê¸° (SQL ì§‘ê³„)
    missing = get_missing_evaluations_sql(politician_id)

    if not missing:
        return True

    # 2. ëˆ„ë½ëœ ê²ƒë§Œ í‰ê°€ (ì „ì²´ ì¬ì‹¤í–‰ X)
    for item in missing:
        cid = item['id']
        missing_ais = item['missing_ais']  # ['Claude', 'Grok']

        # ëˆ„ë½ëœ AIë§Œ í‰ê°€
        for ai in missing_ais:
            evaluate_single(politician_id, politician_name, cid, ai)

    return True
```

**íš¨ê³¼**:
- 120ê°œ ëˆ„ë½ â†’ 120ê°œë§Œ í‰ê°€ (ì „ì²´ 1,000ê°œ ì²´í¬ X)
- ì†Œìš” ì‹œê°„: 10ë¶„ â†’ 1ë¶„ (10ë°° í–¥ìƒ)

### 4.3 ìš°ì„ ìˆœìœ„ 3: ì¥ê¸° ìµœì í™” (í™•ì¥ì„± í™•ë³´)

#### ê°œì„  5: ë°°ì¹˜ë³„ ì¬í‰ê°€

**ì•„ì´ë””ì–´**:
```python
# ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì¬í‰ê°€ (10ê°œ ì¹´í…Œê³ ë¦¬)
for category in CATEGORIES:
    missing = get_missing_evaluations_for_category(politician_id, category)
    reevaluate_category(politician_id, politician_name, category, missing)
```

**íš¨ê³¼**:
- ë©”ëª¨ë¦¬ ì‚¬ìš©: 10MB â†’ 1MB (ì¹´í…Œê³ ë¦¬ë‹¹)
- ì‹¤íŒ¨ ì‹œ ì˜í–¥ ë²”ìœ„: ì „ì²´ â†’ 1ê°œ ì¹´í…Œê³ ë¦¬
- ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥ (10ê°œ ì¹´í…Œê³ ë¦¬ ë™ì‹œ)

#### ê°œì„  6: ì¬í‰ê°€ í ì‹œìŠ¤í…œ

**ì•„ì´ë””ì–´**:
```python
# ì¬í‰ê°€ í í…Œì´ë¸”
CREATE TABLE reevaluation_queue_v40 (
    id UUID PRIMARY KEY,
    politician_id TEXT NOT NULL,
    collected_data_id UUID NOT NULL,
    evaluator_ai TEXT NOT NULL,
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT NOW()
);

# 1. ëˆ„ë½ ë°œê²¬ ì‹œ íì— ì¶”ê°€
INSERT INTO reevaluation_queue_v40 (politician_id, collected_data_id, evaluator_ai)
SELECT ...(ëˆ„ë½ëœ í‰ê°€);

# 2. ì›Œì»¤ê°€ íì—ì„œ êº¼ë‚´ì„œ ì²˜ë¦¬
while True:
    task = SELECT * FROM reevaluation_queue_v40 WHERE status = 'pending' LIMIT 1;
    if task:
        evaluate_single(task);
        UPDATE reevaluation_queue_v40 SET status = 'completed' WHERE id = task.id;
```

**íš¨ê³¼**:
- ë¹„ë™ê¸° ì²˜ë¦¬ âœ…
- ì‹¤íŒ¨ ì¶”ì  âœ…
- ì¬ì‹œë„ ê´€ë¦¬ âœ…
- í™•ì¥ì„± í™•ë³´ (ì›Œì»¤ ì¶”ê°€ ê°€ëŠ¥) âœ…

---

## 5. Claude Subscription Mode ì¬í‰ê°€

### 5.1 í˜„ì¬ ìƒí™©

**Claude í‰ê°€ ë°©ì‹**:
```python
def call_claude_direct_evaluation(prompt):
    # API ì‚¬ìš© X
    # Subscription Mode (ìˆ˜ë™ ë°°ì¹˜)
    print("âš ï¸ Claude í‰ê°€ëŠ” ë³„ë„ ë°°ì¹˜ í”„ë¡œì„¸ìŠ¤ë¡œ ì§„í–‰ë©ë‹ˆë‹¤")
    print("ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ Claude í‰ê°€ë¥¼ ì§„í–‰í•˜ì„¸ìš”:")
    print("  python evaluate_claude_auto.py --category=CATEGORY --output=eval_CATEGORY.md")

    return json.dumps({'evaluations': []}, ensure_ascii=False)
```

**í”„ë¡œì„¸ìŠ¤**:
1. `evaluate_claude_auto.py`ê°€ ì‘ì—… íŒŒì¼ ìƒì„± (data.json)
2. Claude Code ì„¸ì…˜ì´ ë°°ì¹˜ë³„ë¡œ íŒŒì¼ ì½ê³  í‰ê°€
3. `evaluate_claude_auto.py`ê°€ ê²°ê³¼ë¥¼ DBì— import

### 5.2 ì¬í‰ê°€ ì‹œ ë¬¸ì œì 

**ì‹œë‚˜ë¦¬ì˜¤**:
```
1. ì´ˆê¸° í‰ê°€
   - Claude: 970/1000 í‰ê°€ (30ê°œ ëˆ„ë½)
   - ChatGPT/Gemini/Grok: 1000/1000 í‰ê°€

2. check_evaluation_quality
   - 3,970/4,000 = 99.25% â†’ í†µê³¼ (97% ì´ìƒ)
   - í•˜ì§€ë§Œ Claude AIë³„ ì²´í¬: 970/1000 = 97% â†’ í†µê³¼ (90% ì´ìƒ)

3. ì¬í‰ê°€ í•„ìš” ì—†ìŒ â†’ í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” 30ê°œ ëˆ„ë½
```

**í˜„ì¬ ì¬í‰ê°€ ë°©ì‹**:
```python
# run_v40_workflow.py
if needs_reevaluation:
    reevaluate_missing()  # evaluate_v40.py ì¬ì‹¤í–‰
    # â†’ ClaudeëŠ” API í˜¸ì¶œ X, ë¹ˆ ì‘ë‹µë§Œ ë°˜í™˜
    # â†’ ì‹¤ì œë¡œëŠ” ì¬í‰ê°€ ì•ˆ ë¨
```

### 5.3 í•´ê²° ë°©ì•ˆ

#### ë°©ì•ˆ 1: ìˆ˜ë™ ì¬í‰ê°€ (í˜„ì‹¤ì )

**í”„ë¡œì„¸ìŠ¤**:
```python
def reevaluate_claude_manual(politician_id, politician_name):
    # 1. Claude ëˆ„ë½ í‰ê°€ ì°¾ê¸°
    missing = get_missing_evaluations_sql(politician_id, evaluator_ai='Claude')

    if not missing:
        print("âœ… Claude í‰ê°€ ì™„ë£Œ")
        return True

    # 2. ì‘ì—… íŒŒì¼ ìƒì„±
    create_claude_reevaluation_batch(missing)
    # â†’ eval_claude_missing.md ìƒì„±

    # 3. ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
    print(f"""
    âš ï¸ Claude ì¬í‰ê°€ í•„ìš”: {len(missing)}ê°œ

    ë‹¤ìŒ ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”:

    1. Claude Code ì„¸ì…˜ ì—´ê¸°
    2. ë‹¤ìŒ íŒŒì¼ í™•ì¸:
       - eval_claude_missing.md (í‰ê°€í•  ë°ì´í„° ëª©ë¡)

    3. Claude Codeì—ì„œ ì‹¤í–‰:
       - íŒŒì¼ì„ ì½ê³  í‰ê°€ ìˆ˜í–‰
       - ê²°ê³¼ë¥¼ eval_claude_missing_result.jsonìœ¼ë¡œ ì €ì¥

    4. ìŠ¤í¬ë¦½íŠ¸ ì¬ì‹¤í–‰:
       python import_claude_reevaluation.py

    ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n)
    """)

    user_input = input()
    if user_input.lower() != 'y':
        return False

    # 4. ê²°ê³¼ import ëŒ€ê¸°
    print("â³ ê²°ê³¼ íŒŒì¼ ëŒ€ê¸° ì¤‘...")
    wait_for_file('eval_claude_missing_result.json', timeout=3600)

    # 5. ê²°ê³¼ import
    import_claude_results('eval_claude_missing_result.json')

    return True
```

**ì¥ì **:
- í˜„ì¬ ì‹œìŠ¤í…œê³¼ í˜¸í™˜ âœ…
- ì¶”ê°€ API ë¹„ìš© ì—†ìŒ âœ…

**ë‹¨ì **:
- ìˆ˜ë™ ì‘ì—… í•„ìš” âŒ
- ìë™í™” ë¶ˆê°€ âŒ

#### ë°©ì•ˆ 2: Claude API ì‚¬ìš© (ë¹„ìš© ë°œìƒ)

**í”„ë¡œì„¸ìŠ¤**:
```python
def reevaluate_claude_api(politician_id, politician_name):
    # 1. Claude ëˆ„ë½ í‰ê°€ ì°¾ê¸°
    missing = get_missing_evaluations_sql(politician_id, evaluator_ai='Claude')

    if not missing:
        return True

    # 2. API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    from anthropic import Anthropic
    client = Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))

    # 3. ë°°ì¹˜ í‰ê°€
    for batch in chunks(missing, 10):
        evaluations = evaluate_batch_api(client, batch, ...)
        save_evaluations(evaluations)

    return True
```

**ì¥ì **:
- ì™„ì „ ìë™í™” âœ…
- ë¹ ë¥¸ ì²˜ë¦¬ âœ…

**ë‹¨ì **:
- API ë¹„ìš© ë°œìƒ âŒ
- Subscription Mode ì¥ì  ìƒì‹¤ âŒ

#### ë°©ì•ˆ 3: í•˜ì´ë¸Œë¦¬ë“œ (ì¶”ì²œ)

**ì•„ì´ë””ì–´**:
```python
def reevaluate_claude_hybrid(politician_id, politician_name, auto=False):
    missing = get_missing_evaluations_sql(politician_id, evaluator_ai='Claude')

    if not missing:
        return True

    missing_count = len(missing)

    # ì†ŒëŸ‰ ëˆ„ë½ (30ê°œ ì´í•˜): API ì‚¬ìš© (ë¹ ë¥´ê²Œ)
    if missing_count <= 30 and auto:
        print(f"âš¡ Claude ì¬í‰ê°€ (API): {missing_count}ê°œ")
        return reevaluate_claude_api(politician_id, politician_name)

    # ëŒ€ëŸ‰ ëˆ„ë½ (30ê°œ ì´ˆê³¼): ìˆ˜ë™ ë°°ì¹˜ (ë¹„ìš© ì ˆê°)
    else:
        print(f"ğŸ“‹ Claude ì¬í‰ê°€ (ìˆ˜ë™): {missing_count}ê°œ")
        return reevaluate_claude_manual(politician_id, politician_name)
```

**ì¥ì **:
- ì†ŒëŸ‰: ë¹ ë¥´ê³  ìë™ âœ…
- ëŒ€ëŸ‰: ë¹„ìš© ì ˆê° âœ…
- ìœ ì—°ì„± âœ…

**ë¹„ìš© ë¶„ì„**:
```
Claude API ë¹„ìš© (Haiku 4.5):
- Input: $0.25 / 1M tokens
- Output: $1.25 / 1M tokens

ì¬í‰ê°€ ë¹„ìš© (30ê°œ ê¸°ì¤€):
- Input: 30ê°œ Ã— 500 tokens = 15,000 tokens
- Output: 30ê°œ Ã— 100 tokens = 3,000 tokens
- ì´ ë¹„ìš©: (15,000 Ã— 0.25 + 3,000 Ã— 1.25) / 1,000,000
         = (3.75 + 3.75) / 1,000,000
         = $0.0000075
         â‰ˆ $0.008 (1ì„¼íŠ¸ ë¯¸ë§Œ)

â†’ 30ê°œ ì¬í‰ê°€: 1ì„¼íŠ¸ ë¯¸ë§Œ (ë§¤ìš° ì €ë ´)
â†’ 300ê°œ ì¬í‰ê°€: 10ì„¼íŠ¸ (í—ˆìš© ê°€ëŠ¥)
â†’ 3000ê°œ ì¬í‰ê°€: $1 (ê³ ë ¤ í•„ìš”)
```

### 5.4 ìµœì¢… ê¶Œì¥ ë°©ì•ˆ

**ì¦‰ì‹œ ì ìš©**:
- í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ (ë°©ì•ˆ 3)
- ì„ê³„ê°’: 30ê°œ
- 30ê°œ ì´í•˜: API ìë™ ì¬í‰ê°€ (ë¹„ìš© ë¬´ì‹œ ê°€ëŠ¥)
- 30ê°œ ì´ˆê³¼: ìˆ˜ë™ ë°°ì¹˜ ì¬í‰ê°€ (ë¹„ìš© ì ˆê°)

**ì¥ê¸° ê°œì„ **:
- Claude API Batch ê¸°ëŠ¥ í™œìš© (50% í• ì¸)
- ë¹„ìš© ì¶”ì  ë° ëª¨ë‹ˆí„°ë§
- ì˜ˆì‚° ê¸°ë°˜ ìë™/ìˆ˜ë™ ì „í™˜

---

## 6. ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ì½”ë“œ

### 6.1 get_missing_evaluations_optimized.py

```python
# -*- coding: utf-8 -*-
"""
V40 ëˆ„ë½ í‰ê°€ ì¡°íšŒ ìµœì í™” ìŠ¤í¬ë¦½íŠ¸

ê°œì„ ì‚¬í•­:
1. SELECT * â†’ SELECT id, category, collector_ai (ì „ì†¡ëŸ‰ 5ë°° ê°ì†Œ)
2. AIë³„/ì¹´í…Œê³ ë¦¬ë³„ ì™„ì„±ë„ ì²´í¬ ì¶”ê°€
3. SQL ì§‘ê³„ ì¿¼ë¦¬ ì˜µì…˜ ì œê³µ
"""

import os
from collections import defaultdict
from supabase import create_client
from dotenv import load_dotenv

load_dotenv(override=True)

supabase = create_client(
    os.getenv('SUPABASE_URL'),
    os.getenv('SUPABASE_SERVICE_ROLE_KEY')
)

EVALUATION_AIS = ["Claude", "ChatGPT", "Gemini", "Grok"]


def get_missing_evaluations_optimized(politician_id):
    """ëˆ„ë½ëœ í‰ê°€ ì°¾ê¸° (ìµœì í™” ë²„ì „)

    ê°œì„ ì‚¬í•­:
    - í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì¡°íšŒ (ì „ì†¡ëŸ‰ 80% ê°ì†Œ)
    - AIë³„/ì¹´í…Œê³ ë¦¬ë³„ í†µê³„ ì œê³µ
    """
    print("ëˆ„ë½ëœ í‰ê°€ ì¡°íšŒ ì¤‘ (ìµœì í™”)...")

    # 1. ìˆ˜ì§‘ ë°ì´í„° ì¡°íšŒ (í•„ìˆ˜ ì»¬ëŸ¼ë§Œ)
    all_collected = []
    offset = 0
    while True:
        result = supabase.table('collected_data_v40')\
            .select('id, category, collector_ai')\
            .eq('politician_id', politician_id)\
            .range(offset, offset + 999)\
            .execute()

        if not result.data:
            break

        all_collected.extend(result.data)
        offset += 1000

        if len(result.data) < 1000:
            break

    # 2. í‰ê°€ ë°ì´í„° ì¡°íšŒ (í•„ìˆ˜ ì»¬ëŸ¼ë§Œ)
    all_evals = []
    offset = 0
    while True:
        result = supabase.table('evaluations_v40')\
            .select('collected_data_id, evaluator_ai, category')\
            .eq('politician_id', politician_id)\
            .range(offset, offset + 999)\
            .execute()

        if not result.data:
            break

        all_evals.extend(result.data)
        offset += 1000

        if len(result.data) < 1000:
            break

    # 3. collected_data_idë³„ í‰ê°€ AI ë§¤í•‘
    cid_to_ais = defaultdict(set)
    for ev in all_evals:
        cid = ev.get('collected_data_id')
        ai = ev.get('evaluator_ai')
        if cid and ai:
            cid_to_ais[cid].add(ai)

    # 4. ëˆ„ë½ ì°¾ê¸°
    missing = []
    missing_by_ai = defaultdict(int)
    missing_by_category = defaultdict(int)

    for item in all_collected:
        cid = item.get('id')
        category = item.get('category')
        evaluated_by = cid_to_ais.get(cid, set())

        for ai in EVALUATION_AIS:
            if ai not in evaluated_by:
                missing.append({
                    'item': item,
                    'ai': ai,
                    'category': category
                })
                missing_by_ai[ai] += 1
                missing_by_category[category] += 1

    # 5. í†µê³„ ì¶œë ¥
    print(f"  ì´ ìˆ˜ì§‘ ë°ì´í„°: {len(all_collected)}ê°œ")
    print(f"  ì´ í‰ê°€: {len(all_evals)}ê°œ")
    print(f"  ëˆ„ë½ í‰ê°€: {len(missing)}ê°œ\n")

    if missing:
        print("  AIë³„ ëˆ„ë½:")
        for ai in EVALUATION_AIS:
            count = missing_by_ai.get(ai, 0)
            print(f"    {ai}: {count}ê°œ")

        print("\n  ì¹´í…Œê³ ë¦¬ë³„ ëˆ„ë½:")
        for cat, count in sorted(missing_by_category.items()):
            print(f"    {cat}: {count}ê°œ")

    return missing


def check_evaluation_quality_detailed(politician_id):
    """í‰ê°€ í’ˆì§ˆ ìƒì„¸ í™•ì¸ (AIë³„/ì¹´í…Œê³ ë¦¬ë³„)

    ê°œì„ ì‚¬í•­:
    - AIë³„ ì™„ì„±ë„ ì²´í¬ (ìµœì†Œ 90%)
    - ì¹´í…Œê³ ë¦¬ë³„ ì™„ì„±ë„ ì²´í¬ (ìµœì†Œ 90%)
    """
    print("\ní‰ê°€ í’ˆì§ˆ ìƒì„¸ í™•ì¸ ì¤‘...")

    # 1. ì „ì²´ ì™„ì„±ë„
    collected_result = supabase.table('collected_data_v40')\
        .select('id', count='exact')\
        .eq('politician_id', politician_id)\
        .execute()
    collected_count = collected_result.count or 0

    eval_result = supabase.table('evaluations_v40')\
        .select('id', count='exact')\
        .eq('politician_id', politician_id)\
        .execute()
    eval_count = eval_result.count or 0

    expected = collected_count * 4
    overall_completion = eval_count / expected * 100 if expected > 0 else 0

    print(f"\n  ì „ì²´ ì™„ì„±ë„: {overall_completion:.2f}% ({eval_count}/{expected})")

    # 2. AIë³„ ì™„ì„±ë„
    print("\n  AIë³„ ì™„ì„±ë„:")
    issues = []

    for ai in EVALUATION_AIS:
        ai_result = supabase.table('evaluations_v40')\
            .select('id', count='exact')\
            .eq('politician_id', politician_id)\
            .eq('evaluator_ai', ai)\
            .execute()

        ai_count = ai_result.count or 0
        ai_completion = ai_count / collected_count * 100 if collected_count > 0 else 0

        status = "âœ…" if ai_completion >= 90 else "âš ï¸"
        print(f"    {status} {ai}: {ai_completion:.2f}% ({ai_count}/{collected_count})")

        if ai_completion < 90:
            issues.append(f"{ai} ì™„ì„±ë„ {ai_completion:.1f}% (90% ë¯¸ë§Œ)")

    # 3. ì¹´í…Œê³ ë¦¬ë³„ ì™„ì„±ë„
    print("\n  ì¹´í…Œê³ ë¦¬ë³„ ì™„ì„±ë„:")

    categories = [
        'expertise', 'leadership', 'vision', 'integrity', 'ethics',
        'accountability', 'transparency', 'communication', 'responsiveness', 'publicinterest'
    ]

    for cat in categories:
        cat_collected = supabase.table('collected_data_v40')\
            .select('id', count='exact')\
            .eq('politician_id', politician_id)\
            .eq('category', cat)\
            .execute()

        cat_collected_count = cat_collected.count or 0

        cat_eval = supabase.table('evaluations_v40')\
            .select('id', count='exact')\
            .eq('politician_id', politician_id)\
            .eq('category', cat)\
            .execute()

        cat_eval_count = cat_eval.count or 0
        cat_expected = cat_collected_count * 4
        cat_completion = cat_eval_count / cat_expected * 100 if cat_expected > 0 else 0

        status = "âœ…" if cat_completion >= 90 else "âš ï¸"
        print(f"    {status} {cat}: {cat_completion:.2f}% ({cat_eval_count}/{cat_expected})")

        if cat_completion < 90:
            issues.append(f"{cat} ì™„ì„±ë„ {cat_completion:.1f}% (90% ë¯¸ë§Œ)")

    # 4. ê²°ê³¼
    print("\n" + "="*60)
    if overall_completion >= 97 and len(issues) == 0:
        print("âœ… í‰ê°€ í’ˆì§ˆ ê²€ì¦ í†µê³¼")
        print("="*60)
        return True, []
    else:
        print("âš ï¸ í‰ê°€ í’ˆì§ˆ ê²€ì¦ ì‹¤íŒ¨")
        if overall_completion < 97:
            print(f"  - ì „ì²´ ì™„ì„±ë„ {overall_completion:.2f}% (97% ë¯¸ë§Œ)")
        for issue in issues:
            print(f"  - {issue}")
        print("="*60)
        return False, issues


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(description='V40 ëˆ„ë½ í‰ê°€ ì¡°íšŒ (ìµœì í™”)')
    parser.add_argument('--politician_id', required=True, help='ì •ì¹˜ì¸ ID')

    args = parser.parse_args()

    # 1. ëˆ„ë½ í‰ê°€ ì¡°íšŒ
    missing = get_missing_evaluations_optimized(args.politician_id)

    # 2. ìƒì„¸ í’ˆì§ˆ í™•ì¸
    quality_ok, issues = check_evaluation_quality_detailed(args.politician_id)

    if not quality_ok:
        print("\nâš ï¸ ì¬í‰ê°€ í•„ìš”")
```

### 6.2 reevaluate_claude_hybrid.py

```python
# -*- coding: utf-8 -*-
"""
Claude ì¬í‰ê°€ í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤í¬ë¦½íŠ¸

ì „ëµ:
- 30ê°œ ì´í•˜ ëˆ„ë½: API ìë™ ì¬í‰ê°€ (ë¹ ë¥´ê³  ì €ë ´)
- 30ê°œ ì´ˆê³¼ ëˆ„ë½: ìˆ˜ë™ ë°°ì¹˜ ì¬í‰ê°€ (ë¹„ìš© ì ˆê°)
"""

import os
import json
from datetime import datetime
from supabase import create_client
from dotenv import load_dotenv

load_dotenv(override=True)

supabase = create_client(
    os.getenv('SUPABASE_URL'),
    os.getenv('SUPABASE_SERVICE_ROLE_KEY')
)

THRESHOLD_AUTO = 30  # 30ê°œ ì´í•˜ëŠ” API ìë™


def get_claude_missing_evaluations(politician_id):
    """Claude ëˆ„ë½ í‰ê°€ ì°¾ê¸°"""
    from get_missing_evaluations_optimized import get_missing_evaluations_optimized

    all_missing = get_missing_evaluations_optimized(politician_id)

    # Claudeë§Œ í•„í„°ë§
    claude_missing = [m for m in all_missing if m['ai'] == 'Claude']

    return claude_missing


def reevaluate_claude_api(politician_id, politician_name, missing):
    """Claude APIë¡œ ì¬í‰ê°€ (ì†ŒëŸ‰ ëˆ„ë½ ì‹œ)"""
    from anthropic import Anthropic

    print(f"\nâš¡ Claude API ì¬í‰ê°€ ì‹œì‘: {len(missing)}ê°œ")

    client = Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))

    # ë°°ì¹˜ í‰ê°€ (10ê°œì”©)
    total_evaluated = 0

    for i in range(0, len(missing), 10):
        batch = missing[i:i+10]

        # í‰ê°€ í”„ë¡¬í”„íŠ¸ ìƒì„±
        items_text = ""
        for idx, m in enumerate(batch, 1):
            item = m['item']
            items_text += f"""
[í•­ëª© {idx}]
- ID: {item.get('id')}
- ì œëª©: {item.get('title', 'N/A')}
- ë‚´ìš©: {item.get('content', 'N/A')[:300]}...
- ì¶œì²˜: {item.get('source_name', 'N/A')}
- ë‚ ì§œ: {item.get('published_date', 'N/A')}
"""

        prompt = f"""ë‹¹ì‹ ì€ ì •ì¹˜ì¸ í‰ê°€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**ëŒ€ìƒ ì •ì¹˜ì¸**: {politician_name}

ì•„ë˜ ë°ì´í„°ë¥¼ **ê°ê´€ì ìœ¼ë¡œ í‰ê°€**í•˜ì—¬ ë“±ê¸‰ì„ ë¶€ì—¬í•˜ì„¸ìš”.

**ë“±ê¸‰ ì²´ê³„** (+4 ~ -4):
| ë“±ê¸‰ | íŒë‹¨ ê¸°ì¤€ | ì ìˆ˜ |
|------|-----------|------|
| +4 | íƒì›”í•¨ - í•´ë‹¹ ë¶„ì•¼ ëª¨ë²” ì‚¬ë¡€ | +8 |
| +3 | ìš°ìˆ˜í•¨ - ê¸ì •ì  í‰ê°€ | +6 |
| +2 | ì–‘í˜¸í•¨ - ê¸°ë³¸ ì¶©ì¡± | +4 |
| +1 | ë³´í†µ ê¸ì • - í‰ê·  ì´ìƒ | +2 |
| -1 | ë¯¸í¡í•¨ - ê°œì„  í•„ìš” | -2 |
| -2 | ë¶€ì¡±í•¨ - ë¬¸ì œ ìˆìŒ | -4 |
| -3 | ë§¤ìš° ë¶€ì¡± - ì‹¬ê°í•œ ë¬¸ì œ | -6 |
| -4 | ê·¹íˆ ë¶€ì¡± - ì •ì¹˜ì¸ ë¶€ì í•© | -8 |

**í‰ê°€í•  ë°ì´í„°**:
{items_text}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜:
```json
{{
  "evaluations": [
    {{
      "id": "ë°ì´í„° ID",
      "rating": "+4, +3, +2, +1, -1, -2, -3, -4 ì¤‘ í•˜ë‚˜",
      "rationale": "í‰ê°€ ê·¼ê±° (1ë¬¸ì¥)"
    }}
  ]
}}
```
"""

        # API í˜¸ì¶œ
        try:
            response = client.messages.create(
                model="claude-3-5-haiku-20241022",
                max_tokens=4096,
                messages=[{"role": "user", "content": prompt}]
            )

            content = response.content[0].text

            # JSON íŒŒì‹±
            json_start = content.find('{')
            json_end = content.rfind('}') + 1
            json_str = content[json_start:json_end]

            data = json.loads(json_str)
            evaluations = data.get('evaluations', [])

            # DB ì €ì¥
            for idx, ev in enumerate(evaluations):
                if idx >= len(batch):
                    break

                item = batch[idx]['item']

                record = {
                    'politician_id': politician_id,
                    'politician_name': politician_name,
                    'category': item['category'],
                    'evaluator_ai': 'Claude',
                    'collected_data_id': item['id'],
                    'rating': ev.get('rating'),
                    'score': {
                        '+4': 8, '+3': 6, '+2': 4, '+1': 2,
                        '-1': -2, '-2': -4, '-3': -6, '-4': -8
                    }.get(ev.get('rating'), 0),
                    'reasoning': ev.get('rationale', '')[:1000],
                    'evaluated_at': datetime.now().isoformat()
                }

                supabase.table('evaluations_v40').insert(record).execute()
                total_evaluated += 1

            print(f"  âœ… ë°°ì¹˜ {i//10 + 1} ì™„ë£Œ ({len(evaluations)}ê°œ)")

        except Exception as e:
            print(f"  âŒ ë°°ì¹˜ {i//10 + 1} ì‹¤íŒ¨: {e}")

    print(f"\nâœ… Claude API ì¬í‰ê°€ ì™„ë£Œ: {total_evaluated}ê°œ")
    return total_evaluated


def reevaluate_claude_manual(politician_id, politician_name, missing):
    """Claude ìˆ˜ë™ ì¬í‰ê°€ (ëŒ€ëŸ‰ ëˆ„ë½ ì‹œ)"""
    print(f"\nğŸ“‹ Claude ìˆ˜ë™ ì¬í‰ê°€ ì¤€ë¹„: {len(missing)}ê°œ")

    # ì‘ì—… íŒŒì¼ ìƒì„±
    output_file = f"eval_claude_missing_{politician_id}.md"

    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(f"""# Claude ì¬í‰ê°€ ì‘ì—…

**ì •ì¹˜ì¸**: {politician_name} ({politician_id})
**ëˆ„ë½ í‰ê°€**: {len(missing)}ê°œ
**ìƒì„± ì‹œê°„**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

---

## í‰ê°€ ëŒ€ìƒ ë°ì´í„°

""")

        for idx, m in enumerate(missing, 1):
            item = m['item']
            f.write(f"""
### [{idx}] {item.get('category')} - {item.get('title', 'N/A')}

- **ID**: `{item.get('id')}`
- **ì¹´í…Œê³ ë¦¬**: {item.get('category')}
- **ì œëª©**: {item.get('title', 'N/A')}
- **ë‚´ìš©**: {item.get('content', 'N/A')[:500]}...
- **ì¶œì²˜**: {item.get('source_name', item.get('source_url', 'N/A'))}
- **ë‚ ì§œ**: {item.get('published_date', 'N/A')}

**í‰ê°€ ë“±ê¸‰ (+4 ~ -4)**:
- +4: íƒì›”í•¨
- +3: ìš°ìˆ˜í•¨
- +2: ì–‘í˜¸í•¨
- +1: ë³´í†µ ê¸ì •
- -1: ë¯¸í¡í•¨
- -2: ë¶€ì¡±í•¨
- -3: ë§¤ìš° ë¶€ì¡±
- -4: ê·¹íˆ ë¶€ì¡±

**í‰ê°€ ê·¼ê±°**:

---
""")

    print(f"\nâœ… ì‘ì—… íŒŒì¼ ìƒì„±: {output_file}")
    print(f"""
ë‹¤ìŒ ë‹¨ê³„ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”:

1. Claude Code ì„¸ì…˜ ì—´ê¸°

2. íŒŒì¼ í™•ì¸:
   - {output_file}

3. Claude Codeì—ì„œ í‰ê°€ ìˆ˜í–‰:
   - ê° ë°ì´í„°ì— ëŒ€í•´ ë“±ê¸‰ ë° ê·¼ê±° ì‘ì„±
   - ê²°ê³¼ë¥¼ eval_claude_missing_{politician_id}_result.jsonìœ¼ë¡œ ì €ì¥

4. ê²°ê³¼ import:
   python import_claude_reevaluation.py --politician_id={politician_id} --file=eval_claude_missing_{politician_id}_result.json

ì‘ì—…ì„ ì™„ë£Œí•˜ì‹  í›„ ìœ„ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”.
""")

    return 0


def reevaluate_claude_hybrid(politician_id, politician_name, auto=False):
    """Claude í•˜ì´ë¸Œë¦¬ë“œ ì¬í‰ê°€

    Args:
        politician_id: ì •ì¹˜ì¸ ID
        politician_name: ì •ì¹˜ì¸ ì´ë¦„
        auto: Trueë©´ ìë™ ëª¨ë“œ (API ì‚¬ìš©), Falseë©´ ì‚¬ìš©ì ì„ íƒ
    """
    # 1. Claude ëˆ„ë½ í‰ê°€ ì°¾ê¸°
    missing = get_claude_missing_evaluations(politician_id)

    if not missing:
        print("âœ… Claude í‰ê°€ ì™„ë£Œ (ëˆ„ë½ ì—†ìŒ)")
        return True

    missing_count = len(missing)
    print(f"\nâš ï¸ Claude ëˆ„ë½ í‰ê°€ ë°œê²¬: {missing_count}ê°œ")

    # 2. ì¬í‰ê°€ ë°©ì‹ ê²°ì •
    if missing_count <= THRESHOLD_AUTO:
        # ì†ŒëŸ‰: API ìë™ ì¬í‰ê°€
        if auto:
            print(f"  â†’ ì†ŒëŸ‰ ëˆ„ë½ ({missing_count} â‰¤ {THRESHOLD_AUTO}): API ìë™ ì¬í‰ê°€")
            reevaluate_claude_api(politician_id, politician_name, missing)
            return True
        else:
            print(f"\nì¬í‰ê°€ ë°©ì‹ ì„ íƒ:")
            print(f"  1. API ìë™ ì¬í‰ê°€ (ë¹ ë¥´ê³  ê°„í¸, ë¹„ìš© ~1ì„¼íŠ¸)")
            print(f"  2. ìˆ˜ë™ ë°°ì¹˜ ì¬í‰ê°€ (ë¹„ìš© $0, ì‹œê°„ ì†Œìš”)")

            choice = input("\nì„ íƒ (1/2): ")

            if choice == '1':
                reevaluate_claude_api(politician_id, politician_name, missing)
                return True
            else:
                reevaluate_claude_manual(politician_id, politician_name, missing)
                return False

    else:
        # ëŒ€ëŸ‰: ìˆ˜ë™ ë°°ì¹˜ ì¬í‰ê°€ ê¶Œì¥
        print(f"  â†’ ëŒ€ëŸ‰ ëˆ„ë½ ({missing_count} > {THRESHOLD_AUTO}): ìˆ˜ë™ ë°°ì¹˜ ì¬í‰ê°€ ê¶Œì¥")

        if auto:
            print("  âš ï¸ ìë™ ëª¨ë“œì´ì§€ë§Œ ëŒ€ëŸ‰ ëˆ„ë½ìœ¼ë¡œ ì¸í•´ ìˆ˜ë™ ì¬í‰ê°€ë¡œ ì „í™˜")

        print(f"\nì¬í‰ê°€ ë°©ì‹ ì„ íƒ:")
        print(f"  1. API ìë™ ì¬í‰ê°€ (ë¹ ë¥´ì§€ë§Œ ë¹„ìš© ~${missing_count * 0.01:.2f})")
        print(f"  2. ìˆ˜ë™ ë°°ì¹˜ ì¬í‰ê°€ (ë¹„ìš© $0, ì‹œê°„ ì†Œìš”)")

        choice = input("\nì„ íƒ (1/2): ")

        if choice == '1':
            confirm = input(f"ë¹„ìš© ì•½ ${missing_count * 0.01:.2f} ë°œìƒí•©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
            if confirm.lower() == 'y':
                reevaluate_claude_api(politician_id, politician_name, missing)
                return True
            else:
                print("ì¬í‰ê°€ ì·¨ì†Œ")
                return False
        else:
            reevaluate_claude_manual(politician_id, politician_name, missing)
            return False


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(description='Claude í•˜ì´ë¸Œë¦¬ë“œ ì¬í‰ê°€')
    parser.add_argument('--politician_id', required=True, help='ì •ì¹˜ì¸ ID')
    parser.add_argument('--politician_name', required=True, help='ì •ì¹˜ì¸ ì´ë¦„')
    parser.add_argument('--auto', action='store_true', help='ìë™ ëª¨ë“œ (30ê°œ ì´í•˜ëŠ” API ì‚¬ìš©)')

    args = parser.parse_args()

    reevaluate_claude_hybrid(args.politician_id, args.politician_name, args.auto)
```

### 6.3 run_v40_workflow_improved.py

```python
# -*- coding: utf-8 -*-
"""
V40 ì „ì²´ ì›Œí¬í”Œë¡œìš° ìë™ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (ê°œì„  ë²„ì „)

ê°œì„ ì‚¬í•­:
1. get_missing_evaluations_optimized ì‚¬ìš© (5ë°° ë¹ ë¦„)
2. AIë³„/ì¹´í…Œê³ ë¦¬ë³„ ì™„ì„±ë„ ì²´í¬
3. Claude í•˜ì´ë¸Œë¦¬ë“œ ì¬í‰ê°€
"""

import os
import sys
import subprocess
import argparse
from datetime import datetime
from supabase import create_client
from dotenv import load_dotenv

# UTF-8 ì¶œë ¥ ì„¤ì •
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv(override=True)

# Supabase í´ë¼ì´ì–¸íŠ¸
supabase = create_client(
    os.getenv('SUPABASE_URL'),
    os.getenv('SUPABASE_SERVICE_ROLE_KEY')
)

# ê°œì„ ëœ í•¨ìˆ˜ import
from get_missing_evaluations_optimized import (
    get_missing_evaluations_optimized,
    check_evaluation_quality_detailed
)
from reevaluate_claude_hybrid import reevaluate_claude_hybrid


def print_step(step_num, title):
    """ë‹¨ê³„ ì¶œë ¥"""
    print(f"\n{'='*60}")
    print(f"[ë‹¨ê³„ {step_num}] {title}")
    print(f"{'='*60}\n")


def run_command(cmd, description):
    """ëª…ë ¹ì–´ ì‹¤í–‰"""
    print(f"â–¶ {description}")
    print(f"  ëª…ë ¹ì–´: {cmd}\n")

    env = os.environ.copy()
    env['PYTHONIOENCODING'] = 'utf-8'

    result = subprocess.run(cmd, shell=True, capture_output=False, text=True, env=env)

    if result.returncode != 0:
        print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: ëª…ë ¹ì–´ ì‹¤í–‰ ì‹¤íŒ¨ (exit code: {result.returncode})")
        return False

    print(f"\nâœ… ì™„ë£Œ\n")
    return True


def reevaluate_missing_improved(politician_id, politician_name, parallel=False):
    """ê°œì„ ëœ ì¬í‰ê°€ í”„ë¡œì„¸ìŠ¤

    ê°œì„ ì‚¬í•­:
    1. Claude: í•˜ì´ë¸Œë¦¬ë“œ ì¬í‰ê°€ (ì†ŒëŸ‰ API, ëŒ€ëŸ‰ ìˆ˜ë™)
    2. ChatGPT/Gemini/Grok: evaluate_v40.py ì¬ì‹¤í–‰
    3. ìƒì„¸ ì§„í–‰ ìƒí™© í‘œì‹œ
    """
    print_step("6", "ì¬í‰ê°€ (ê°œì„  ë²„ì „)")

    # 1. ëˆ„ë½ í‰ê°€ ì°¾ê¸° (ìµœì í™”)
    missing = get_missing_evaluations_optimized(politician_id)

    if not missing:
        print("âœ… ëˆ„ë½ëœ í‰ê°€ ì—†ìŒ\n")
        return True

    # 2. AIë³„ ë¶„ë¥˜
    claude_missing = [m for m in missing if m['ai'] == 'Claude']
    other_missing = [m for m in missing if m['ai'] != 'Claude']

    print(f"\nëˆ„ë½ í‰ê°€ ë¶„ë¥˜:")
    print(f"  Claude: {len(claude_missing)}ê°œ")
    print(f"  ChatGPT/Gemini/Grok: {len(other_missing)}ê°œ")

    # 3. Claude ì¬í‰ê°€ (í•˜ì´ë¸Œë¦¬ë“œ)
    if claude_missing:
        print(f"\n{'='*60}")
        print(f"[3-1] Claude ì¬í‰ê°€")
        print(f"{'='*60}")

        success = reevaluate_claude_hybrid(politician_id, politician_name, auto=True)

        if not success:
            print("âš ï¸ Claude ì¬í‰ê°€ ìˆ˜ë™ ì‘ì—… í•„ìš”")
            user_input = input("ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
            if user_input.lower() != 'y':
                return False

    # 4. ChatGPT/Gemini/Grok ì¬í‰ê°€ (evaluate_v40.py)
    if other_missing:
        print(f"\n{'='*60}")
        print(f"[3-2] ChatGPT/Gemini/Grok ì¬í‰ê°€")
        print(f"{'='*60}")

        parallel_flag = "--parallel" if parallel else ""
        cmd = f'python evaluate_v40.py --politician_id={politician_id} --politician_name="{politician_name}" {parallel_flag}'

        success = run_command(cmd, "evaluate_v40.py ì¬ì‹¤í–‰")

        if not success:
            print("âŒ ì¬í‰ê°€ ì‹¤íŒ¨\n")
            return False

    # 5. ì¬í™•ì¸ (ìƒì„¸)
    print(f"\n{'='*60}")
    print(f"[3-3] ì¬í‰ê°€ ê²°ê³¼ í™•ì¸")
    print(f"{'='*60}")

    quality_ok, issues = check_evaluation_quality_detailed(politician_id)

    if not quality_ok:
        print("\nâš ï¸ ì¼ë¶€ í‰ê°€ê°€ ì—¬ì „íˆ ëˆ„ë½ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
        for issue in issues:
            print(f"  - {issue}")
        return False

    print("\nâœ… ëª¨ë“  ëˆ„ë½ í‰ê°€ ì™„ë£Œ")
    return True


def main():
    parser = argparse.ArgumentParser(description='V40 ì „ì²´ ì›Œí¬í”Œë¡œìš° ìë™ ì‹¤í–‰ (ê°œì„ )')
    parser.add_argument('--politician_id', required=True, help='ì •ì¹˜ì¸ ID')
    parser.add_argument('--politician_name', required=True, help='ì •ì¹˜ì¸ ì´ë¦„')
    parser.add_argument('--skip_collect', action='store_true', help='ìˆ˜ì§‘ ë‹¨ê³„ ê±´ë„ˆë›°ê¸°')
    parser.add_argument('--skip_evaluate', action='store_true', help='í‰ê°€ ë‹¨ê³„ ê±´ë„ˆë›°ê¸°')
    parser.add_argument('--parallel', action='store_true', help='ë³‘ë ¬ ì‹¤í–‰')

    args = parser.parse_args()

    print(f"\n{'#'*60}")
    print(f"# V40 ì „ì²´ ì›Œí¬í”Œë¡œìš° ìë™ ì‹¤í–‰ (ê°œì„  ë²„ì „)")
    print(f"# ì •ì¹˜ì¸: {args.politician_name} ({args.politician_id})")
    print(f"# ì‹œì‘ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"{'#'*60}\n")

    # 1. ìˆ˜ì§‘ (ê¸°ì¡´ê³¼ ë™ì¼)
    if not args.skip_collect:
        print_step("1", "ë°ì´í„° ìˆ˜ì§‘")
        parallel_flag = "--parallel" if args.parallel else ""
        cmd = f'python collect_v40.py --politician_id={args.politician_id} --politician_name="{args.politician_name}" {parallel_flag}'
        if not run_command(cmd, "ë°ì´í„° ìˆ˜ì§‘ ì‹¤í–‰"):
            print("âŒ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: ìˆ˜ì§‘ ì‹¤íŒ¨")
            return

    # 2. ìˆ˜ì§‘ ê²€ì¦ (ê¸°ì¡´ê³¼ ë™ì¼)
    # ... (ìƒëµ)

    # 3. ë°ì´í„° ê²€ì¦ (ê¸°ì¡´ê³¼ ë™ì¼)
    # ... (ìƒëµ)

    # 4. í‰ê°€ (ê¸°ì¡´ê³¼ ë™ì¼)
    if not args.skip_evaluate:
        print_step("4", "ë°ì´í„° í‰ê°€")
        parallel_flag = "--parallel" if args.parallel else ""
        cmd = f'python evaluate_v40.py --politician_id={args.politician_id} --politician_name="{args.politician_name}" {parallel_flag}'
        if not run_command(cmd, "ë°ì´í„° í‰ê°€ ì‹¤í–‰"):
            print("âŒ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: í‰ê°€ ì‹¤íŒ¨")
            return

    # 5. í‰ê°€ ê²€ì¦ (ê°œì„ : ìƒì„¸ ê²€ì¦)
    print_step("5", "í‰ê°€ ê²€ì¦ (ìƒì„¸)")

    quality_ok, issues = check_evaluation_quality_detailed(args.politician_id)
    needs_reevaluation = not quality_ok

    # 6. ì¬í‰ê°€ (ê°œì„ : í•˜ì´ë¸Œë¦¬ë“œ)
    if needs_reevaluation:
        if not reevaluate_missing_improved(args.politician_id, args.politician_name, args.parallel):
            print("âš ï¸ ì¬í‰ê°€ ì¤‘ ì¼ë¶€ ì‹¤íŒ¨")
            user_input = input("ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
            if user_input.lower() != 'y':
                print("ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨")
                return

        # ì¬í‰ê°€ í›„ ë‹¤ì‹œ ê²€ì¦
        quality_ok, issues = check_evaluation_quality_detailed(args.politician_id)
        if not quality_ok:
            print("âš ï¸ ì¬í‰ê°€ í›„ì—ë„ í’ˆì§ˆ ê¸°ì¤€ ë¯¸ë‹¬")

    # 7. ì ìˆ˜ ê³„ì‚° (ê¸°ì¡´ê³¼ ë™ì¼)
    print_step("7", "ì ìˆ˜ ê³„ì‚°")
    cmd = f'python calculate_v40_scores.py --politician_id={args.politician_id} --politician_name="{args.politician_name}"'
    if not run_command(cmd, "ì ìˆ˜ ê³„ì‚° ì‹¤í–‰"):
        print("âŒ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨: ì ìˆ˜ ê³„ì‚° ì‹¤íŒ¨")
        return

    # ì™„ë£Œ
    print(f"\n{'='*60}")
    print(f"âœ… V40 ì „ì²´ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!")
    print(f"ì¢…ë£Œ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"{'='*60}\n")


if __name__ == "__main__":
    main()
```

---

## 7. ì ìš© ê³„íš

### 7.1 ì¦‰ì‹œ ì ìš© (1ì¼ ì´ë‚´)

1. **get_missing_evaluations_optimized.py** ì ìš©
   - ê¸°ì¡´ ì½”ë“œ ë°±ì—…
   - ìƒˆ ìŠ¤í¬ë¦½íŠ¸ ë°°í¬
   - í…ŒìŠ¤íŠ¸ (1ëª… ì •ì¹˜ì¸)

2. **check_evaluation_quality_detailed** ì ìš©
   - run_v40_workflow.py ìˆ˜ì •
   - AIë³„/ì¹´í…Œê³ ë¦¬ë³„ ì²´í¬ ì¶”ê°€

3. **reevaluate_claude_hybrid.py** ì ìš©
   - Claude ì¬í‰ê°€ ë¡œì§ ë¶„ë¦¬
   - í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ êµ¬í˜„

### 7.2 ì¤‘ê¸° ì ìš© (1ì£¼ ì´ë‚´)

1. **run_v40_workflow_improved.py** ì „ì²´ ë°°í¬
   - ê¸°ì¡´ ì›Œí¬í”Œë¡œìš° ë°±ì—…
   - ê°œì„  ë²„ì „ ë°°í¬
   - ì „ì²´ í…ŒìŠ¤íŠ¸ (3ëª… ì •ì¹˜ì¸)

2. **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**
   - ì¬í‰ê°€ ì‹œê°„ ì¸¡ì •
   - API ë¹„ìš© ì¶”ì 
   - ì˜¤ë¥˜ìœ¨ í™•ì¸

### 7.3 ì¥ê¸° ì ìš© (1ê°œì›” ì´ë‚´)

1. **SQL ì§‘ê³„ ì¿¼ë¦¬ êµ¬í˜„**
   - PostgreSQL í•¨ìˆ˜ ì‘ì„±
   - Supabase RPC ì—°ë™
   - ì„±ëŠ¥ ë¹„êµ í…ŒìŠ¤íŠ¸

2. **ì¬í‰ê°€ í ì‹œìŠ¤í…œ**
   - í í…Œì´ë¸” ìƒì„±
   - ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ êµ¬í˜„
   - ë¹„ë™ê¸° ì¬í‰ê°€ ì ìš©

---

## 8. ê²°ë¡ 

### 8.1 í•µì‹¬ ë¬¸ì œì 

1. **ì„±ëŠ¥**: get_missing_evaluationsê°€ 1,000ê°œì—ì„œ 5ì´ˆ â†’ 10,000ê°œì—ì„œ 50ì´ˆ
2. **ì •í™•ë„**: 97% ì „ì²´ ê¸°ì¤€ìœ¼ë¡œ íŠ¹ì • AI/ì¹´í…Œê³ ë¦¬ ëˆ„ë½ ê°ì§€ ëª»í•¨
3. **ë¹„íš¨ìœ¨**: 120ê°œ ëˆ„ë½ì¸ë° ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì¬ì‹¤í–‰

### 8.2 ì¦‰ì‹œ ê°œì„  íš¨ê³¼

| í•­ëª© | ê¸°ì¡´ | ê°œì„  | íš¨ê³¼ |
|------|------|------|------|
| get_missing_evaluations | 5ì´ˆ | 2ì´ˆ | 2.5ë°° í–¥ìƒ |
| AIë³„/ì¹´í…Œê³ ë¦¬ë³„ ì²´í¬ | ì—†ìŒ | ì¶”ê°€ | ì˜¤ì§„ë¥  ê°ì†Œ |
| Claude ì¬í‰ê°€ | ìˆ˜ë™ë§Œ | í•˜ì´ë¸Œë¦¬ë“œ | 30ê°œ ì´í•˜ ìë™í™” |
| ì¬í‰ê°€ ì‹œê°„ (120ê°œ) | 10ë¶„ | 1ë¶„ | 10ë°° í–¥ìƒ (ì¥ê¸°) |

### 8.3 ìµœì¢… ê¶Œì¥ì‚¬í•­

**ì¦‰ì‹œ ì ìš©**:
1. get_missing_evaluations_optimized.py
2. check_evaluation_quality_detailed
3. reevaluate_claude_hybrid.py

**ì¤‘ê¸° ì ìš©**:
1. run_v40_workflow_improved.py ì „ì²´ ë°°í¬
2. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ìµœì í™”

**ì¥ê¸° ì ìš©**:
1. SQL ì§‘ê³„ ì¿¼ë¦¬ (10ë°° í–¥ìƒ)
2. ì¬í‰ê°€ í ì‹œìŠ¤í…œ (ë¹„ë™ê¸°)

---

**ì‘ì„±ì¼**: 2026-01-25
**ì‘ì„±ì**: Claude Code
**ë²„ì „**: V40 ì¬í‰ê°€ í”„ë¡œì„¸ìŠ¤ ê°œì„ ì•ˆ v1.0
