# AI별 점수 산출 및 종합 로직

**작성일**: 2025-10-26
**버전**: 1.0
**상태**: ✅ 확정

---

## 🎯 핵심 개념

### 각 AI가 독립적으로 최종 점수 산출

```
정치인 1명당:

Claude AI → 100개 항목 평가 → 10개 분야 점수 → 최종 92.0점
ChatGPT AI → 100개 항목 평가 → 10개 분야 점수 → 최종 90.0점
Gemini AI → 100개 항목 평가 → 10개 분야 점수 → 최종 88.0점
Grok AI → 100개 항목 평가 → 10개 분야 점수 → 최종 91.0점
Perplexity AI → 100개 항목 평가 → 10개 분야 점수 → 최종 89.0점

종합 점수 = (92.0 + 90.0 + 88.0 + 91.0 + 89.0) / 5 = 90.0점
```

---

## 📊 점수 산출 흐름

### 단계별 프로세스

```
[Step 1] 각 AI별 항목 점수 계산 (Bayesian Prior 7.0)
  Claude:
    항목 1-1: 7.67점
    항목 1-2: 8.35점
    ...
    항목 10-10: 7.90점

[Step 2] 각 AI별 분야 점수 계산
  Claude:
    분야 1 (청렴성): 7.98점
    분야 2 (전문성): 8.20점
    ...
    분야 10 (공익추구): 7.90점

[Step 3] 각 AI별 최종 점수 계산
  Claude: 7.98 + 8.20 + ... + 7.90 = 92.0점
  ChatGPT: 90.0점
  Gemini: 88.0점
  Grok: 91.0점
  Perplexity: 89.0점

[Step 4] 종합 점수 계산
  종합 점수 = (92.0 + 90.0 + 88.0 + 91.0 + 89.0) / 5 = 90.0점
```

---

## 🗄️ 데이터베이스 구조

### 테이블 1: ai_item_scores (AI별 항목 점수)

```sql
CREATE TABLE ai_item_scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  politician_id UUID REFERENCES politicians(id),
  ai_name VARCHAR(50) NOT NULL,  -- Claude, ChatGPT, Gemini, Grok, Perplexity
  category_num INT NOT NULL,     -- 1~10
  item_num INT NOT NULL,         -- 1~10
  item_score DECIMAL(4,2),       -- 7.67 (소수점 둘째자리)
  data_count INT DEFAULT 0,
  last_updated TIMESTAMP DEFAULT NOW(),
  UNIQUE(politician_id, ai_name, category_num, item_num)
);
```

### 테이블 2: ai_category_scores (AI별 분야 점수)

```sql
CREATE TABLE ai_category_scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  politician_id UUID REFERENCES politicians(id),
  ai_name VARCHAR(50) NOT NULL,
  category_num INT NOT NULL,
  category_score DECIMAL(4,2),   -- 7.98 (소수점 둘째자리)
  items_completed INT DEFAULT 0,
  last_updated TIMESTAMP DEFAULT NOW(),
  UNIQUE(politician_id, ai_name, category_num)
);
```

### 테이블 3: ai_final_scores (AI별 최종 점수)

```sql
CREATE TABLE ai_final_scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  politician_id UUID REFERENCES politicians(id),
  ai_name VARCHAR(50) NOT NULL,
  total_score DECIMAL(4,1),      -- 92.0 (소수점 첫째자리)
  grade_code VARCHAR(1),         -- M, D, E, P, G, S, B, I
  grade_name VARCHAR(20),
  grade_emoji VARCHAR(10),
  categories_completed INT DEFAULT 0,
  items_completed INT DEFAULT 0,
  total_data_count INT DEFAULT 0,
  last_updated TIMESTAMP DEFAULT NOW(),
  UNIQUE(politician_id, ai_name)
);
```

### 테이블 4: combined_final_scores (종합 최종 점수)

```sql
CREATE TABLE combined_final_scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  politician_id UUID REFERENCES politicians(id) UNIQUE,
  combined_score DECIMAL(4,1),   -- 90.0 (5개 AI 평균)
  grade_code VARCHAR(1),
  grade_name VARCHAR(20),
  grade_emoji VARCHAR(10),
  ai_count INT DEFAULT 0,        -- 몇 개 AI가 평가했는지 (초기: 1개 Claude만)
  last_updated TIMESTAMP DEFAULT NOW()
);
```

---

## 🔄 트리거 로직

### 트리거 1: AI별 항목 점수 계산

```sql
CREATE OR REPLACE FUNCTION calculate_ai_item_score()
RETURNS TRIGGER AS $$
DECLARE
  v_ai_score DECIMAL(4,3);
  v_data_count INT;
  v_final_score DECIMAL(4,3);
  v_prior_score CONSTANT DECIMAL(3,1) := 7.0;
  v_prior_weight CONSTANT INT := 10;
BEGIN
  -- 해당 AI의 데이터만 계산
  SELECT AVG(data_score), COUNT(*)
  INTO v_ai_score, v_data_count
  FROM collected_data
  WHERE politician_id = NEW.politician_id
    AND category_num = NEW.category_num
    AND item_num = NEW.item_num
    AND collected_by = NEW.collected_by;  -- AI 이름으로 필터링

  -- Bayesian Prior 7.0 적용
  v_final_score := (v_ai_score * v_data_count + v_prior_score * v_prior_weight)
                   / (v_data_count + v_prior_weight);

  -- AI별 항목 점수 저장
  INSERT INTO ai_item_scores (politician_id, ai_name, category_num, item_num, item_score, data_count)
  VALUES (NEW.politician_id, NEW.collected_by, NEW.category_num, NEW.item_num, v_final_score, v_data_count)
  ON CONFLICT (politician_id, ai_name, category_num, item_num)
  DO UPDATE SET
    item_score = v_final_score,
    data_count = v_data_count,
    last_updated = NOW();

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 트리거 2: AI별 분야 점수 계산

```sql
CREATE OR REPLACE FUNCTION calculate_ai_category_score()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO ai_category_scores (politician_id, ai_name, category_num, category_score, items_completed)
  SELECT
    NEW.politician_id,
    NEW.ai_name,
    NEW.category_num,
    AVG(item_score),  -- 항목 평균 (소수점 둘째자리)
    COUNT(*)
  FROM ai_item_scores
  WHERE politician_id = NEW.politician_id
    AND ai_name = NEW.ai_name
    AND category_num = NEW.category_num
  GROUP BY politician_id, ai_name, category_num
  ON CONFLICT (politician_id, ai_name, category_num)
  DO UPDATE SET
    category_score = EXCLUDED.category_score,
    items_completed = EXCLUDED.items_completed,
    last_updated = NOW();

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 트리거 3: AI별 최종 점수 계산

```sql
CREATE OR REPLACE FUNCTION calculate_ai_final_score()
RETURNS TRIGGER AS $$
DECLARE
  v_total_score DECIMAL(4,1);
  v_grade_code VARCHAR(1);
  v_grade_name VARCHAR(20);
  v_grade_emoji VARCHAR(10);
BEGIN
  -- AI별 분야 점수 합산
  SELECT SUM(category_score)
  INTO v_total_score
  FROM ai_category_scores
  WHERE politician_id = NEW.politician_id
    AND ai_name = NEW.ai_name;

  -- 8단계 등급 계산
  IF v_total_score >= 93 THEN
    v_grade_code := 'M'; v_grade_name := 'Mugunghwa'; v_grade_emoji := '🌺';
  ELSIF v_total_score >= 86 THEN
    v_grade_code := 'D'; v_grade_name := 'Diamond'; v_grade_emoji := '💎';
  ELSIF v_total_score >= 79 THEN
    v_grade_code := 'E'; v_grade_name := 'Emerald'; v_grade_emoji := '💚';
  ELSIF v_total_score >= 72 THEN
    v_grade_code := 'P'; v_grade_name := 'Platinum'; v_grade_emoji := '🥇';
  ELSIF v_total_score >= 65 THEN
    v_grade_code := 'G'; v_grade_name := 'Gold'; v_grade_emoji := '🥇';
  ELSIF v_total_score >= 58 THEN
    v_grade_code := 'S'; v_grade_name := 'Silver'; v_grade_emoji := '🥈';
  ELSIF v_total_score >= 51 THEN
    v_grade_code := 'B'; v_grade_name := 'Bronze'; v_grade_emoji := '🥉';
  ELSIF v_total_score >= 44 THEN
    v_grade_code := 'I'; v_grade_name := 'Iron'; v_grade_emoji := '⚫';
  ELSE
    v_grade_code := 'F'; v_grade_name := 'Fail'; v_grade_emoji := '❌';
  END IF;

  -- AI별 최종 점수 저장
  INSERT INTO ai_final_scores (
    politician_id, ai_name, total_score, grade_code, grade_name, grade_emoji
  )
  VALUES (
    NEW.politician_id, NEW.ai_name, v_total_score, v_grade_code, v_grade_name, v_grade_emoji
  )
  ON CONFLICT (politician_id, ai_name)
  DO UPDATE SET
    total_score = v_total_score,
    grade_code = v_grade_code,
    grade_name = v_grade_name,
    grade_emoji = v_grade_emoji,
    last_updated = NOW();

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 트리거 4: 종합 최종 점수 계산

```sql
CREATE OR REPLACE FUNCTION calculate_combined_final_score()
RETURNS TRIGGER AS $$
DECLARE
  v_combined_score DECIMAL(4,1);
  v_ai_count INT;
  v_grade_code VARCHAR(1);
  v_grade_name VARCHAR(20);
  v_grade_emoji VARCHAR(10);
BEGIN
  -- 모든 AI 점수 평균 계산
  SELECT AVG(total_score), COUNT(*)
  INTO v_combined_score, v_ai_count
  FROM ai_final_scores
  WHERE politician_id = NEW.politician_id;

  -- 8단계 등급 계산
  IF v_combined_score >= 93 THEN
    v_grade_code := 'M'; v_grade_name := 'Mugunghwa'; v_grade_emoji := '🌺';
  ELSIF v_combined_score >= 86 THEN
    v_grade_code := 'D'; v_grade_name := 'Diamond'; v_grade_emoji := '💎';
  ELSIF v_combined_score >= 79 THEN
    v_grade_code := 'E'; v_grade_name := 'Emerald'; v_grade_emoji := '💚';
  ELSIF v_combined_score >= 72 THEN
    v_grade_code := 'P'; v_grade_name := 'Platinum'; v_grade_emoji := '🥇';
  ELSIF v_combined_score >= 65 THEN
    v_grade_code := 'G'; v_grade_name := 'Gold'; v_grade_emoji := '🥇';
  ELSIF v_combined_score >= 58 THEN
    v_grade_code := 'S'; v_grade_name := 'Silver'; v_grade_emoji := '🥈';
  ELSIF v_combined_score >= 51 THEN
    v_grade_code := 'B'; v_grade_name := 'Bronze'; v_grade_emoji := '🥉';
  ELSIF v_combined_score >= 44 THEN
    v_grade_code := 'I'; v_grade_name := 'Iron'; v_grade_emoji := '⚫';
  ELSE
    v_grade_code := 'F'; v_grade_name := 'Fail'; v_grade_emoji := '❌';
  END IF;

  -- 종합 점수 저장
  INSERT INTO combined_final_scores (
    politician_id, combined_score, grade_code, grade_name, grade_emoji, ai_count
  )
  VALUES (
    NEW.politician_id, v_combined_score, v_grade_code, v_grade_name, v_grade_emoji, v_ai_count
  )
  ON CONFLICT (politician_id)
  DO UPDATE SET
    combined_score = v_combined_score,
    grade_code = v_grade_code,
    grade_name = v_grade_name,
    grade_emoji = v_grade_emoji,
    ai_count = v_ai_count,
    last_updated = NOW();

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## 🚀 단계별 구현 전략

### Phase 1: Claude 단독 평가 (초기) ⭐

**비용 절감을 위해 Claude만 먼저 운영**

```
Claude AI → 100개 항목 평가 → 최종 92.0점

종합 점수 = Claude 점수 = 92.0점
```

**UI 표시**:
```
종합 점수: 92.0점
  ├─ Claude: 92.0점
  └─ (다른 AI는 추후 추가 예정)
```

**DB 상태**:
```sql
-- ai_final_scores
| politician_id | ai_name | total_score |
|--------------|---------|-------------|
| 오세훈        | Claude  | 92.0        |

-- combined_final_scores
| politician_id | combined_score | ai_count |
|--------------|----------------|----------|
| 오세훈        | 92.0           | 1        |
```

---

### Phase 2: 5개 AI 전체 평가 (추후)

**비용 여유 생기면 확장**

```
Claude AI → 92.0점
ChatGPT AI → 90.0점
Gemini AI → 88.0점
Grok AI → 91.0점
Perplexity AI → 89.0점

종합 점수 = (92.0 + 90.0 + 88.0 + 91.0 + 89.0) / 5 = 90.0점
```

**UI 표시**:
```
종합 점수: 90.0점
  ├─ Claude: 92.0점
  ├─ ChatGPT: 90.0점
  ├─ Gemini: 88.0점
  ├─ Grok: 91.0점
  └─ Perplexity: 89.0점
```

---

## 📱 UI 구현 예시

### 정치인 카드

```html
<div class="politician-card">
  <!-- 종합 점수 -->
  <div class="combined-score">
    <div class="score-label">종합 점수</div>
    <div class="score-value">92.0</div>
    <div class="grade">🥇 Platinum (P)</div>
  </div>

  <!-- AI별 점수 (초기: Claude만) -->
  <div class="ai-scores">
    <div class="ai-score-item">
      <img src="claude-logo.png" alt="Claude">
      <span>Claude</span>
      <span class="score">92.0</span>
    </div>
    <!-- 추후 추가
    <div class="ai-score-item">
      <img src="chatgpt-logo.png" alt="ChatGPT">
      <span>ChatGPT</span>
      <span class="score">90.0</span>
    </div>
    -->
  </div>

  <!-- 회원 평점 -->
  <div class="user-rating">
    <div>회원평점</div>
    <div>★★★★★ (234명)</div>
  </div>
</div>
```

---

## 📊 View (실시간 조회)

### View: 종합 순위

```sql
CREATE VIEW v_combined_rankings AS
SELECT
  p.name,
  p.job_type,
  p.party,
  c.combined_score,
  c.grade_code,
  c.grade_name,
  c.grade_emoji,
  c.ai_count,
  CONCAT(c.grade_emoji, ' ', c.grade_name, ' (', c.grade_code, ')') as grade_display,
  RANK() OVER (ORDER BY c.combined_score DESC) as rank
FROM politicians p
JOIN combined_final_scores c ON p.id = c.politician_id
ORDER BY c.combined_score DESC;
```

### View: AI별 점수 상세

```sql
CREATE VIEW v_ai_scores_detail AS
SELECT
  p.name,
  a.ai_name,
  a.total_score,
  a.grade_code,
  a.grade_name,
  a.grade_emoji
FROM politicians p
JOIN ai_final_scores a ON p.id = a.politician_id
ORDER BY p.name, a.ai_name;
```

---

## 🎯 핵심 정리

### 점수 체계:
1. ✅ **각 AI가 독립적으로 100점 만점 점수 산출**
2. ✅ **종합 점수 = AI별 점수의 평균**
3. ✅ **초기에는 Claude만 운영** (비용 절감)
4. ✅ **추후 5개 AI로 확장** (비용 여유 시)

### 점수 표시:
- AI별 점수: 소수점 첫째자리 (92.0점)
- 종합 점수: 소수점 첫째자리 (90.0점)

### DB 구조:
- `ai_item_scores`: AI별 항목 점수
- `ai_category_scores`: AI별 분야 점수
- `ai_final_scores`: AI별 최종 점수
- `combined_final_scores`: 종합 최종 점수

---

**작성일**: 2025-10-26
**작성자**: PoliticianFinder 연구팀
**버전**: 1.0
**상태**: ✅ 확정

**참고**:
- 초기 운영: Claude 단독 → 종합 점수 = Claude 점수
- 확장 시: 5개 AI → 종합 점수 = 5개 평균
