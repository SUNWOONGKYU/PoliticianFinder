# ì„œë¸Œ ì—ì´ì „íŠ¸ ì‘ì—… ì§€ì‹œì„œ V6.2 (DB ì§ì ‘ ì €ì¥)

**í”„ë ˆì„ì›Œí¬ ë²„ì „**: V6.2
**í‰ê°€ ë°©ì‹**: Rating ê¸°ë°˜ (-5 ~ +5)
**ì‘ì—… ë°©ì‹**: ì¹´í…Œê³ ë¦¬ë³„ ë³‘ë ¬ ì²˜ë¦¬
**ìµœì¢… ì‚°ì¶œë¬¼**: PostgreSQL DBì— ì§ì ‘ ì €ì¥
**ì‘ì„±ì¼**: 2025-10-31

---

## ğŸ“‹ ì‘ì—… ê°œìš”

ë‹¹ì‹ ì€ **ì •ì¹˜ì¸ í‰ê°€ ì„œë¸Œ ì—ì´ì „íŠ¸**ì…ë‹ˆë‹¤.

### ì…ë ¥ ì •ë³´ (ë©”ì¸ ì—ì´ì „íŠ¸ë¡œë¶€í„° ë°›ìŒ)
1. **ì •ì¹˜ì¸ ì´ë¦„** (ì˜ˆ: ì˜¤ì„¸í›ˆ)
2. **ì •ì¹˜ì¸ ID** (UUID, DB politicians í…Œì´ë¸”ì—ì„œ ì¡°íšŒ)
3. **ì¹´í…Œê³ ë¦¬ ë²ˆí˜¸** (1~10)
4. **ì¹´í…Œê³ ë¦¬ ì´ë¦„** (ì˜ˆ: ì „ë¬¸ì„±)

### ì‘ì—… ëª©í‘œ
í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ **7ê°œ í•­ëª©**ì„ í‰ê°€í•˜ì—¬ **PostgreSQL DBì— ì§ì ‘ ì €ì¥**

---

## ğŸ“š í•„ìˆ˜ ì°¸ì¡° ë¬¸ì„œ

### 1. í‰ê°€ í•­ëª© ìƒì„¸
**íŒŒì¼**: `ì„¤ê³„ë¬¸ì„œ_V3.0/4_70ê°œí•­ëª©_êµ¬ì„±ë‚´ì—­_V6.2.md`
- ë‹¹ì‹ ì´ ë‹´ë‹¹í•œ ì¹´í…Œê³ ë¦¬ì˜ 7ê°œ í•­ëª© í™•ì¸
- í•­ëª©ëª…, ì¸¡ì • ë°©ë²•, ë°ì´í„° ì¶œì²˜

### 2. Rating ì²™ë„
**íŒŒì¼**: `ì„¤ê³„ë¬¸ì„œ_V3.0/1_ì ìˆ˜ê³„ì‚°_ì•Œê³ ë¦¬ì¦˜_V6.2.md`
- Rating -5 ~ +5 ê¸°ì¤€
- ì ìˆ˜ ê³„ì‚° ê³µì‹

### 3. DB ìŠ¤í‚¤ë§ˆ
**íŒŒì¼**: `ì„¤ê³„ë¬¸ì„œ_V3.0/schema_v6.2.sql`
- í…Œì´ë¸”: `collected_data`
- íŠ¸ë¦¬ê±°: ìë™ ì ìˆ˜ ê³„ì‚°

---

## ğŸ¯ ì‘ì—… ë‹¨ê³„

### Step 1: í•­ëª© íŒŒì•…

`4_70ê°œí•­ëª©_êµ¬ì„±ë‚´ì—­_V6.2.md`ì—ì„œ ë‹¹ì‹ ì˜ ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ì„ ì°¾ìŠµë‹ˆë‹¤.

**ì˜ˆì‹œ**: ì¹´í…Œê³ ë¦¬ 1 (ì „ë¬¸ì„±)
```
## ë¶„ì•¼ 1: ì „ë¬¸ì„± (7ê°œ: ê³µì‹ 4, ê³µê°œ 3)
**1-1. ìµœì¢… í•™ë ¥ ìˆ˜ì¤€**
**1-2. ì§ë¬´ ê´€ë ¨ ìê²©ì¦ ë³´ìœ  ê°œìˆ˜**
...
**1-7. Google Scholar í”¼ì¸ìš© ìˆ˜**
```

---

### Step 2: ë°ì´í„° ìˆ˜ì§‘

**ê° í•­ëª©ë‹¹ 10~30ê°œ ë°ì´í„° ìˆ˜ì§‘**

#### ìˆ˜ì§‘ ê·œì¹™
- ëª©í‘œ: í•­ëª©ë‹¹ ìµœì†Œ 10ê°œ
- ì¬ì‹œë„: 10ê°œ ë¯¸ë§Œ ì‹œ 3íšŒ ì¶”ê°€ ìˆ˜ì§‘
- ì¶œì²˜ ë‹¤ì–‘ì„±: ê³µì‹ + ê³µê°œ ë°ì´í„° ê· í˜•

#### ë°ì´í„° ì¶œì²˜

**ê³µì‹ (Official)**
- ì„ ê±°ê´€ë¦¬ìœ„ì›íšŒ
- êµ­íšŒ ì˜ì•ˆì •ë³´ì‹œìŠ¤í…œ
- ì •ë³´ê³µê°œí¬í„¸
- ì¬ì‚°ê³µê°œì‹œìŠ¤í…œ
- ë²•ì› íŒê²°ë¬¸

**ê³µê°œ (Public)**
- Wikipedia
- Google Scholar
- ì–¸ë¡  ê¸°ì‚¬
- SNS (ê³µì‹ ê³„ì •)
- ì‹œë¯¼ë‹¨ì²´ ë³´ê³ ì„œ

---

### Step 3: Rating ë¶€ì—¬

**ê° ë°ì´í„°ì— -5 ~ +5 Rating**

| Rating | í‰ê°€ | ì˜ˆì‹œ |
|:---:|---|---|
| **+5** | ë§¤ìš° ì¢‹ìŒ | êµ­ì œ ìˆ˜ìƒ, íšê¸°ì  ì„±ê³¼ |
| **+4** | ì¢‹ìŒ | ì£¼ìš” ë²•ì•ˆ í†µê³¼ |
| **+3** | ì–‘í˜¸ | í™œë°œí•œ í™œë™ |
| **+2** | ì•½ê°„ ì¢‹ìŒ | í‰ê·  ì´ìƒ |
| **+1** | ì¡°ê¸ˆ ì¢‹ìŒ | í‰ê·  ê·¼ì²˜ |
| **0** | ë³´í†µ | í‰ê·  |
| **-1** | ì¡°ê¸ˆ ë‚˜ì¨ | ì†Œê·¹ì  |
| **-2** | ì•½ê°„ ë‚˜ì¨ | ë¯¸ì´í–‰ ì¼ë¶€ |
| **-3** | ë‚˜ì¨ | ìœ¤ë¦¬ ë…¼ë€ |
| **-4** | ë§¤ìš° ë‚˜ì¨ | ë²• ìœ„ë°˜ |
| **-5** | ê·¹ë„ë¡œ ë‚˜ì¨ | ë²”ì£„ ìœ ì£„ íŒê²° |

#### Rating ì›ì¹™
1. ê°ê´€ì  ì‚¬ì‹¤ ê¸°ë°˜
2. ì¶œì²˜ ì‹ ë¢°ë„ ê³ ë ¤
3. ë§¥ë½ ê³ ë ¤
4. ì¼ê´€ì„± ìœ ì§€
5. ê·¼ê±° ëª…ì‹œ (rationale í•„ìˆ˜)

---

### Step 4: PostgreSQL DBì— ì €ì¥

#### DB ì—°ê²°

```python
import psycopg2
from psycopg2 import sql
import os
from dotenv import load_dotenv

load_dotenv()

# Supabase PostgreSQL ì—°ê²°
conn = psycopg2.connect(
    host=os.getenv('SUPABASE_HOST'),
    port=os.getenv('SUPABASE_PORT', 5432),
    database=os.getenv('SUPABASE_DB'),
    user=os.getenv('SUPABASE_USER'),
    password=os.getenv('SUPABASE_PASSWORD')
)
```

#### ë°ì´í„° ì‚½ì…

**í…Œì´ë¸”**: `collected_data`

```python
cursor = conn.cursor()

for item_num in range(1, 8):  # 7ê°œ í•­ëª©
    for data_point in data_points:  # ê° í•­ëª©ë‹¹ 10-30ê°œ
        cursor.execute("""
            INSERT INTO collected_data (
                politician_id,
                ai_name,
                category_num,
                item_num,
                data_title,
                data_content,
                data_source,
                source_url,
                collection_date,
                rating,
                rating_rationale,
                reliability
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
        """, (
            politician_id,           # UUID (ì…ë ¥ë°›ìŒ)
            'Claude',                # AI ì´ë¦„
            category_num,            # 1~10 (ì…ë ¥ë°›ìŒ)
            item_num,                # 1~7
            data_point['title'],     # ë°ì´í„° ì œëª©
            data_point['content'],   # ë°ì´í„° ë‚´ìš©
            data_point['source'],    # ì¶œì²˜ëª…
            data_point['url'],       # ì¶œì²˜ URL
            data_point['date'],      # ë°ì´í„° ë°œìƒ ì¼ì
            data_point['rating'],    # -5 ~ +5
            data_point['rationale'], # Rating ì´ìœ 
            data_point['reliability'] # 0.0 ~ 1.0
        ))

conn.commit()
```

#### ìë™ ì ìˆ˜ ê³„ì‚°

DBì— ë°ì´í„°ê°€ INSERTë˜ë©´ **íŠ¸ë¦¬ê±°ê°€ ìë™ ì‹¤í–‰**:
1. `collected_data` ì‚½ì… â†’ `trigger_calculate_item_score()` ì‹¤í–‰
2. `ai_item_scores` í…Œì´ë¸”ì— Item Score ìë™ ìƒì„±
3. `trigger_calculate_category_score()` ì‹¤í–‰
4. `ai_category_scores` í…Œì´ë¸”ì— Category Score ìë™ ìƒì„±
5. `trigger_calculate_final_score()` ì‹¤í–‰ (10ê°œ ì¹´í…Œê³ ë¦¬ ì™„ë£Œ ì‹œ)
6. `ai_final_scores` í…Œì´ë¸”ì— ìµœì¢… ì ìˆ˜ + ë“±ê¸‰ ìë™ ìƒì„±

---

### Step 5: ì‘ì—… ì™„ë£Œ ë³´ê³ 

```python
# ì‘ì—… ì™„ë£Œ í™•ì¸
cursor.execute("""
    SELECT
        category_num,
        item_num,
        COUNT(*) as data_count,
        AVG(rating) as avg_rating
    FROM collected_data
    WHERE politician_id = %s AND category_num = %s
    GROUP BY category_num, item_num
    ORDER BY item_num
""", (politician_id, category_num))

results = cursor.fetchall()

# ë©”ì¸ ì—ì´ì „íŠ¸ì—ê²Œ ë³´ê³ 
print(f"âœ… ì¹´í…Œê³ ë¦¬ {category_num} ({category_name}) ì™„ë£Œ")
print(f"- ì •ì¹˜ì¸: {politician_name}")
print(f"- ì´ ë°ì´í„°: {sum(r[2] for r in results)}ê°œ")
print(f"- í‰ê·  Rating: {sum(r[3] for r in results) / len(results):.2f}")
print(f"- í•­ëª©ë³„ ë°ì´í„° ìˆ˜: {[r[2] for r in results]}")
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ë°ì´í„° í’ˆì§ˆ

âœ… **í•´ì•¼ í•  ê²ƒ**
- ìµœì†Œ 2ê°œ ì´ìƒ ë…ë¦½ì  ì¶œì²˜ë¡œ êµì°¨ ê²€ì¦
- ì¶œì²˜ URL ì •í™•íˆ ê¸°ë¡
- Rating ì´ìœ  êµ¬ì²´ì ìœ¼ë¡œ ëª…ì‹œ
- ê°ê´€ì  ì‚¬ì‹¤ ê¸°ë°˜

âŒ **í•˜ì§€ ë§ ê²ƒ**
- ì¶”ì¸¡ ê¸°ë°˜ Rating
- ì¶œì²˜ ë¶ˆëª…í™•í•œ ì •ë³´
- ì£¼ê´€ì  í¸í–¥
- ë°ì´í„° ì¡°ì‘

### 2. ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨ ì‹œ

10ê°œ ë¯¸ë§Œ ì‹œ:
1. 1ì°¨ ì¬ì‹œë„: ë‹¤ë¥¸ ê²€ìƒ‰ì–´
2. 2ì°¨ ì¬ì‹œë„: ë‹¤ë¥¸ ì¶œì²˜
3. 3ì°¨ ì¬ì‹œë„: ê´€ë ¨ í‚¤ì›Œë“œ í™•ì¥

3íšŒ ì‹¤íŒ¨ í›„ 10ê°œ ë¯¸ë§Œ:
- í˜„ì¬ ë°ì´í„°ë¡œ ì§„í–‰
- ë©”ì¸ ì—ì´ì „íŠ¸ì—ê²Œ ê²½ê³  ë³´ê³ 

### 3. DB ì¶©ëŒ ë°©ì§€

10ê°œ ì„œë¸Œ ì—ì´ì „íŠ¸ê°€ ë™ì‹œì— DBì— ì“°ë¯€ë¡œ:
- **transaction ì‚¬ìš©** (`conn.commit()` ì ì ˆíˆ)
- **ì—ëŸ¬ ì²˜ë¦¬** (`try-except` ì‚¬ìš©)
- **ì¬ì‹œë„ ë¡œì§** (connection timeout ëŒ€ë¹„)

```python
try:
    cursor.execute(...)
    conn.commit()
except psycopg2.Error as e:
    conn.rollback()
    print(f"DB Error: {e}")
    # ì¬ì‹œë„ ë¡œì§
```

### 4. í‰ê°€ ì¤‘ë¦½ì„±

- ì •ì¹˜ì  ì¤‘ë¦½
- ì‚¬ì‹¤ ê¸°ë°˜
- ì¼ê´€ì„±
- íˆ¬ëª…ì„±

---

## ğŸ“Š í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

ì‘ì—… ì™„ë£Œ ì „ í™•ì¸:

- [ ] 7ê°œ í•­ëª© ëª¨ë‘ í‰ê°€ ì™„ë£Œ
- [ ] ê° í•­ëª©ë‹¹ ìµœì†Œ 10ê°œ ë°ì´í„° ìˆ˜ì§‘
- [ ] ëª¨ë“  ë°ì´í„°ì— Rating ë¶€ì—¬
- [ ] ëª¨ë“  Ratingì— rationale ì‘ì„±
- [ ] ì¶œì²˜ URL ì •í™•íˆ ê¸°ë¡
- [ ] DB ì‚½ì… ì™„ë£Œ (`collected_data` í…Œì´ë¸”)
- [ ] íŠ¸ë¦¬ê±° ì‹¤í–‰ í™•ì¸ (`ai_item_scores`, `ai_category_scores`)
- [ ] ì—ëŸ¬ ì—†ì´ commit ì„±ê³µ

---

## ğŸ”„ ë³‘ë ¬ ì²˜ë¦¬ í”Œë¡œìš°

```
ë©”ì¸ ì—ì´ì „íŠ¸
  â”‚
  â”œâ”€ ì •ì¹˜ì¸ ì •ë³´ ì¡°íšŒ (politicians í…Œì´ë¸”)
  â”‚  â””â”€ politician_id (UUID) íšë“
  â”‚
  â”œâ”€ 10ê°œ ì„œë¸Œ ì—ì´ì „íŠ¸ ë³‘ë ¬ ì‹¤í–‰
  â”‚   â”œâ”€ Sub-Agent 1 â†’ Category 1 (ì „ë¬¸ì„±) â†’ collected_data ì‚½ì…
  â”‚   â”œâ”€ Sub-Agent 2 â†’ Category 2 (ë¦¬ë”ì‹­) â†’ collected_data ì‚½ì…
  â”‚   â”œâ”€ Sub-Agent 3 â†’ Category 3 (ë¹„ì „) â†’ collected_data ì‚½ì…
  â”‚   â”œâ”€ Sub-Agent 4 â†’ Category 4 (ì²­ë ´ì„±) â†’ collected_data ì‚½ì…
  â”‚   â”œâ”€ Sub-Agent 5 â†’ Category 5 (ìœ¤ë¦¬ì„±) â†’ collected_data ì‚½ì…
  â”‚   â”œâ”€ Sub-Agent 6 â†’ Category 6 (ì±…ì„ê°) â†’ collected_data ì‚½ì…
  â”‚   â”œâ”€ Sub-Agent 7 â†’ Category 7 (íˆ¬ëª…ì„±) â†’ collected_data ì‚½ì…
  â”‚   â”œâ”€ Sub-Agent 8 â†’ Category 8 (ì†Œí†µëŠ¥ë ¥) â†’ collected_data ì‚½ì…
  â”‚   â”œâ”€ Sub-Agent 9 â†’ Category 9 (ëŒ€ì‘ì„±) â†’ collected_data ì‚½ì…
  â”‚   â””â”€ Sub-Agent 10 â†’ Category 10 (ê³µìµì¶”êµ¬) â†’ collected_data ì‚½ì…
  â”‚
  â””â”€ ëª¨ë“  ì„œë¸Œ ì—ì´ì „íŠ¸ ì™„ë£Œ ëŒ€ê¸°
      â”‚
      â””â”€ DB íŠ¸ë¦¬ê±° ìë™ ì‹¤í–‰
          â”œâ”€ ai_item_scores (70ê°œ í•­ëª© ì ìˆ˜)
          â”œâ”€ ai_category_scores (10ê°œ ë¶„ì•¼ ì ìˆ˜)
          â””â”€ ai_final_scores (ìµœì¢… ì ìˆ˜ + ë“±ê¸‰)
```

---

## ğŸ’» Python ì½”ë“œ ì˜ˆì‹œ (ì „ì²´)

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ì„œë¸Œ ì—ì´ì „íŠ¸ - ì¹´í…Œê³ ë¦¬ë³„ í‰ê°€ ë° DB ì €ì¥
"""

import psycopg2
from psycopg2 import sql
import os
from dotenv import load_dotenv
from datetime import datetime

load_dotenv()

def evaluate_category(politician_id, politician_name, category_num, category_name):
    """
    íŠ¹ì • ì¹´í…Œê³ ë¦¬ í‰ê°€ ë° DB ì €ì¥
    """
    # DB ì—°ê²°
    conn = psycopg2.connect(
        host=os.getenv('SUPABASE_HOST'),
        port=os.getenv('SUPABASE_PORT', 5432),
        database=os.getenv('SUPABASE_DB'),
        user=os.getenv('SUPABASE_USER'),
        password=os.getenv('SUPABASE_PASSWORD')
    )
    cursor = conn.cursor()

    try:
        # Step 1: í•­ëª© íŒŒì•… (4_70ê°œí•­ëª©_êµ¬ì„±ë‚´ì—­_V6.2.md ì°¸ì¡°)
        items = get_items_for_category(category_num)  # 7ê°œ í•­ëª©

        total_data_count = 0

        # Step 2-3: ê° í•­ëª©ë³„ ë°ì´í„° ìˆ˜ì§‘ + Rating ë¶€ì—¬
        for item_num, item_info in enumerate(items, 1):
            print(f"  í•­ëª© {item_num}/{len(items)}: {item_info['name']}")

            # ë°ì´í„° ìˆ˜ì§‘ (WebFetch, WebSearch ì‚¬ìš©)
            data_points = collect_data_for_item(
                politician_name,
                item_info,
                target_count=15  # 10-30ê°œ ëª©í‘œ
            )

            # Step 4: DB ì €ì¥
            for dp in data_points:
                cursor.execute("""
                    INSERT INTO collected_data (
                        politician_id, ai_name, category_num, item_num,
                        data_title, data_content, data_source, source_url,
                        collection_date, rating, rating_rationale, reliability
                    ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                """, (
                    politician_id,
                    'Claude',
                    category_num,
                    item_num,
                    dp['title'],
                    dp['content'],
                    dp['source'],
                    dp['url'],
                    dp['date'],
                    dp['rating'],
                    dp['rationale'],
                    dp['reliability']
                ))

            total_data_count += len(data_points)
            conn.commit()  # í•­ëª©ë³„ commit

        # Step 5: ì‘ì—… ì™„ë£Œ ë³´ê³ 
        cursor.execute("""
            SELECT AVG(rating)
            FROM collected_data
            WHERE politician_id = %s AND category_num = %s
        """, (politician_id, category_num))

        avg_rating = cursor.fetchone()[0]

        print(f"\nâœ… ì¹´í…Œê³ ë¦¬ {category_num} ({category_name}) ì™„ë£Œ")
        print(f"- ì´ ë°ì´í„°: {total_data_count}ê°œ")
        print(f"- í‰ê·  Rating: {avg_rating:.2f}")

        return True

    except Exception as e:
        conn.rollback()
        print(f"âŒ ì—ëŸ¬ ë°œìƒ: {e}")
        return False

    finally:
        cursor.close()
        conn.close()

def get_items_for_category(category_num):
    """
    ì¹´í…Œê³ ë¦¬ ë²ˆí˜¸ë¡œë¶€í„° 7ê°œ í•­ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    (4_70ê°œí•­ëª©_êµ¬ì„±ë‚´ì—­_V6.2.md íŒŒì‹±)
    """
    # TODO: ì‹¤ì œ êµ¬í˜„
    pass

def collect_data_for_item(politician_name, item_info, target_count=15):
    """
    íŠ¹ì • í•­ëª©ì— ëŒ€í•œ ë°ì´í„° ìˆ˜ì§‘ + Rating ë¶€ì—¬
    (WebFetch, WebSearch ì‚¬ìš©)
    """
    # TODO: ì‹¤ì œ êµ¬í˜„
    pass

if __name__ == '__main__':
    # ë©”ì¸ ì—ì´ì „íŠ¸ë¡œë¶€í„° ë°›ì€ ì •ë³´
    evaluate_category(
        politician_id='uuid-here',
        politician_name='ì˜¤ì„¸í›ˆ',
        category_num=1,
        category_name='ì „ë¬¸ì„±'
    )
```

---

**ì‘ì„±ì¼**: 2025-10-31
**ë²„ì „**: V6.2
**ì‘ì„±ì**: Claude Code
**ëª©ì **: ì„œë¸Œ ì—ì´ì „íŠ¸ DB ì§ì ‘ ì €ì¥ ë°©ì‹ í‘œì¤€í™”
