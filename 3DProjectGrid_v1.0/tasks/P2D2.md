# P2D2 - ratings í…Œì´ë¸”

**Phase**: Phase 2 - ì •ì¹˜ì¸ ëª©ë¡/ìƒì„¸
**ì˜ì—­**: Database (Supabase)
**ë‹´ë‹¹ AI**: fullstack-developer
**ìƒíƒœ**: ëŒ€ê¸°
**ì§„ë„**: 0%

---

## ðŸ“‹ ìž‘ì—… ê°œìš”

ì‹œë¯¼ë“¤ì´ ì •ì¹˜ì¸ì„ í‰ê°€í•  ìˆ˜ ìžˆëŠ” `ratings` í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤. ì‚¬ìš©ìžë³„ 1ì¸ 1í‰ê°€ ì œí•œ, í‰ì (1-5), ì½”ë©˜íŠ¸, ì¹´í…Œê³ ë¦¬ ë“±ì„ ì €ìž¥í•©ë‹ˆë‹¤.

---

## ðŸŽ¯ ìž‘ì—… ëª©í‘œ

- [ ] ratings í…Œì´ë¸” ìƒì„±
- [ ] 1ì¸ 1í‰ê°€ ì œì•½ì¡°ê±´ (UNIQUE)
- [ ] í‰ì  ë²”ìœ„ ì œì•½ì¡°ê±´ (1-5)
- [ ] ì™¸ëž˜í‚¤ ì„¤ì • (users, politicians)
- [ ] ì¸ë±ìŠ¤ ì¶”ê°€
- [ ] RLS ì •ì±… ì¤€ë¹„
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

---

## ðŸ“ ê¸°ìˆ  ì‚¬ì–‘

### Database
- Platform: Supabase (PostgreSQL 15+)
- ORM: Supabase Client
- Migration Tool: Supabase CLI

---

## ðŸ”— ì˜ì¡´ ìž‘ì—…

**ì„ í–‰ ìž‘ì—…**: P1D2 (politicians í…Œì´ë¸”)
**í›„ì† ìž‘ì—…**: P2B2 (ì‹œë¯¼ í‰ê°€ API), P2B3 (í‰ê°€ ì§‘ê³„ ë¡œì§)

---

## âœ… ì™„ë£Œ ê¸°ì¤€

1. ratings í…Œì´ë¸” ìƒì„± ì™„ë£Œ
2. ì œì•½ì¡°ê±´ ì„¤ì • ì™„ë£Œ
3. ì™¸ëž˜í‚¤ ì„¤ì • ì™„ë£Œ
4. ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ
5. ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìž‘ì„± ì™„ë£Œ
6. ë¡¤ë°± ê°€ëŠ¥ í™•ì¸

---

## ðŸ’» êµ¬í˜„ ìƒì„¸

### 1. í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

```sql
-- supabase/migrations/[timestamp]_create_ratings_table.sql

CREATE TABLE IF NOT EXISTS ratings (
  id BIGSERIAL PRIMARY KEY,

  -- ì‚¬ìš©ìž ì •ë³´ (Supabase Auth)
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- ì •ì¹˜ì¸ ì •ë³´
  politician_id BIGINT NOT NULL REFERENCES politicians(id) ON DELETE CASCADE,

  -- í‰ê°€ ë‚´ìš©
  score INTEGER NOT NULL CHECK (score >= 1 AND score <= 5),
  comment TEXT,
  category VARCHAR(50) DEFAULT 'overall',

  -- íƒ€ìž„ìŠ¤íƒ¬í”„
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- 1ì¸ 1í‰ê°€ ì œì•½ì¡°ê±´
  CONSTRAINT unique_user_politician UNIQUE(user_id, politician_id)
);

-- ì½”ë©˜íŠ¸ ê¸¸ì´ ì œí•œ (ì„ íƒì‚¬í•­)
ALTER TABLE ratings
ADD CONSTRAINT check_comment_length
CHECK (LENGTH(comment) <= 1000);

-- í…Œì´ë¸” ì„¤ëª…
COMMENT ON TABLE ratings IS 'ì‹œë¯¼ì˜ ì •ì¹˜ì¸ í‰ê°€ í…Œì´ë¸”';
COMMENT ON COLUMN ratings.score IS 'í‰ì  (1-5)';
COMMENT ON COLUMN ratings.category IS 'í‰ê°€ ì¹´í…Œê³ ë¦¬ (overall, policy, integrity, communication ë“±)';
```

### 2. ì¸ë±ìŠ¤ ìƒì„±

```sql
-- ì •ì¹˜ì¸ë³„ í‰ê°€ ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_ratings_politician_id
ON ratings(politician_id);

-- ì‚¬ìš©ìžë³„ í‰ê°€ ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_ratings_user_id
ON ratings(user_id);

-- ìµœì‹  í‰ê°€ìˆœ ì •ë ¬ ìµœì í™”
CREATE INDEX idx_ratings_created_at
ON ratings(created_at DESC);

-- ì •ì¹˜ì¸ + í‰ì  ë³µí•© ì¸ë±ìŠ¤ (í†µê³„ ì¿¼ë¦¬ ìµœì í™”)
CREATE INDEX idx_ratings_politician_score
ON ratings(politician_id, score);

-- ì •ì¹˜ì¸ + ìƒì„±ì¼ ë³µí•© ì¸ë±ìŠ¤ (ì‹œê°„ìˆœ ì •ë ¬)
CREATE INDEX idx_ratings_politician_created
ON ratings(politician_id, created_at DESC);
```

### 3. íŠ¸ë¦¬ê±° - updated_at ìžë™ ì—…ë°ì´íŠ¸

```sql
-- updated_at ìžë™ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_ratings_updated_at
BEFORE UPDATE ON ratings
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### 4. ë¡¤ë°± SQL

```sql
-- supabase/migrations/[timestamp]_rollback_create_ratings_table.sql

-- íŠ¸ë¦¬ê±° ì œê±°
DROP TRIGGER IF EXISTS update_ratings_updated_at ON ratings;
DROP FUNCTION IF EXISTS update_updated_at_column();

-- ì¸ë±ìŠ¤ ì œê±°
DROP INDEX IF EXISTS idx_ratings_politician_created;
DROP INDEX IF EXISTS idx_ratings_politician_score;
DROP INDEX IF EXISTS idx_ratings_created_at;
DROP INDEX IF EXISTS idx_ratings_user_id;
DROP INDEX IF EXISTS idx_ratings_politician_id;

-- í…Œì´ë¸” ì œê±°
DROP TABLE IF EXISTS ratings;
```

### 5. TypeScript íƒ€ìž… ì •ì˜

```typescript
// types/database.ts

export interface Rating {
  id: number
  user_id: string              // UUID (Supabase Auth)
  politician_id: number
  score: number                // 1-5
  comment: string | null
  category: string             // 'overall' | 'policy' | 'integrity' | 'communication'
  created_at: string
  updated_at: string
}

// API ìš”ì²­ íƒ€ìž…
export interface CreateRatingRequest {
  politician_id: number
  score: number
  comment?: string
  category?: string
}

export interface UpdateRatingRequest {
  score: number
  comment?: string
}

// API ì‘ë‹µ íƒ€ìž… (í”„ë¡œí•„ ì •ë³´ í¬í•¨)
export interface RatingWithProfile extends Rating {
  profiles: {
    username: string
    avatar_url: string | null
  }
}

// Supabase ìžë™ ìƒì„± íƒ€ìž…
export type RatingsRow = Database['public']['Tables']['ratings']['Row']
export type RatingsInsert = Database['public']['Tables']['ratings']['Insert']
export type RatingsUpdate = Database['public']['Tables']['ratings']['Update']
```

### 6. ìƒ˜í”Œ ë°ì´í„°

```sql
-- ê°œë°œ/í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„°
INSERT INTO ratings (user_id, politician_id, score, comment, category)
VALUES
  ('550e8400-e29b-41d4-a716-446655440000', 1, 5, 'í›Œë¥­í•œ ì •ì¹˜ì¸ìž…ë‹ˆë‹¤.', 'overall'),
  ('550e8400-e29b-41d4-a716-446655440001', 1, 4, 'ì •ì±…ì´ ì¢‹ìŠµë‹ˆë‹¤.', 'policy'),
  ('550e8400-e29b-41d4-a716-446655440002', 2, 3, 'ë³´í†µìž…ë‹ˆë‹¤.', 'overall');
```

---

## ðŸ“ í…ŒìŠ¤íŠ¸ ê³„íš

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] í…Œì´ë¸” ìƒì„± í™•ì¸
- [ ] ì œì•½ì¡°ê±´ ë™ìž‘ í™•ì¸
  - [ ] 1ì¸ 1í‰ê°€ ì œì•½ (ì¤‘ë³µ í‰ê°€ ì‹œ ì—ëŸ¬)
  - [ ] í‰ì  ë²”ìœ„ ì œì•½ (0 ë˜ëŠ” 6 ìž…ë ¥ ì‹œ ì—ëŸ¬)
  - [ ] ì™¸ëž˜í‚¤ ì œì•½ (ì¡´ìž¬í•˜ì§€ ì•ŠëŠ” ì •ì¹˜ì¸ ID ì‹œ ì—ëŸ¬)
- [ ] ì¸ë±ìŠ¤ ìƒì„± í™•ì¸
- [ ] íŠ¸ë¦¬ê±° ë™ìž‘ í™•ì¸ (updated_at ìžë™ ì—…ë°ì´íŠ¸)

### í†µí•© í…ŒìŠ¤íŠ¸
- [ ] INSERT ì¿¼ë¦¬ ì„±ê³µ í™•ì¸
- [ ] UPDATE ì¿¼ë¦¬ ì„±ê³µ í™•ì¸
- [ ] DELETE ì¿¼ë¦¬ ì„±ê³µ í™•ì¸ (CASCADE ë™ìž‘)
- [ ] ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸ (EXPLAIN ANALYZE)

### ê²€ì¦ ì¿¼ë¦¬

```sql
-- í…Œì´ë¸” êµ¬ì¡° í™•ì¸
\d ratings

-- ì œì•½ì¡°ê±´ í™•ì¸
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'ratings';

-- ì¸ë±ìŠ¤ í™•ì¸
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'ratings';

-- ìƒ˜í”Œ ë°ì´í„° ì¡°íšŒ
SELECT * FROM ratings LIMIT 5;

-- 1ì¸ 1í‰ê°€ ì œì•½ í…ŒìŠ¤íŠ¸ (ì—ëŸ¬ ë°œìƒ ì˜ˆìƒ)
INSERT INTO ratings (user_id, politician_id, score)
VALUES ('550e8400-e29b-41d4-a716-446655440000', 1, 4);
-- ERROR: duplicate key value violates unique constraint "unique_user_politician"

-- í‰ì  ë²”ìœ„ ì œì•½ í…ŒìŠ¤íŠ¸ (ì—ëŸ¬ ë°œìƒ ì˜ˆìƒ)
INSERT INTO ratings (user_id, politician_id, score)
VALUES ('550e8400-e29b-41d4-a716-446655440000', 2, 6);
-- ERROR: new row violates check constraint "ratings_score_check"
```

---

## ðŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

- RLS ì •ì±…ì€ P2E1ì—ì„œ ì„¤ì •
- user_idëŠ” Supabase Authì—ì„œ ìžë™ìœ¼ë¡œ ê°€ì ¸ì˜´
- ë³¸ì¸ì˜ í‰ê°€ë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥í•˜ë„ë¡ RLS ì„¤ì • í•„ìš”
- commentëŠ” XSS ë°©ì§€ë¥¼ ìœ„í•´ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ sanitize í•„ìš”

---

## ðŸ“Œ ì°¸ê³ ì‚¬í•­

**ìž‘ì—… ì™„ë£Œ ì¼ì‹œ**: ëŒ€ê¸°ì¤‘
**í…ŒìŠ¤íŠ¸/ê²€í†  ê²°ê³¼**: ëŒ€ê¸°
**ìžë™í™” ë°©ì‹**: AI-only
**ë¸”ë¡œì»¤**: ì—†ìŒ
**ë¹„ê³ **:
- categoryëŠ” í–¥í›„ í™•ìž¥ ê°€ëŠ¥ (ì •ì±…, ì²­ë ´ë„, ì†Œí†µ ë“±)
- commentëŠ” ì„ íƒ ì‚¬í•­ (NULL í—ˆìš©)
- 1ì¸ 1í‰ê°€ëŠ” UNIQUE ì œì•½ì¡°ê±´ìœ¼ë¡œ DB ë ˆë²¨ì—ì„œ ê°•ì œ

---

**ìž‘ì„± ë°©ë²•ë¡ **: 15DGC-AODM v3.0
**AI-Only ì›ì¹™ ì¤€ìˆ˜**: âœ…
