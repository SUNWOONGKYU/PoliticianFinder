# P2E2 - comments RLS 설정

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: RLS Policies (Supabase)
**담당 AI**: security-auditor
**상태**: 완료
**진도**: 100%

---

## 📋 작업 개요

Phase 3에서 사용될 comments 테이블에 대한 Row Level Security 정책을 미리 설정합니다. 댓글의 조회, 생성, 수정, 삭제 권한을 정의합니다.

---

## 🎯 작업 목표

- [ ] RLS 활성화
- [ ] SELECT 정책 (모든 댓글 조회 가능)
- [ ] INSERT 정책 (로그인 사용자만 생성)
- [ ] UPDATE 정책 (본인 댓글만 수정)
- [ ] DELETE 정책 (본인 또는 관리자만 삭제)
- [ ] 정책 테스트

---

## 📐 기술 사양

### Security
- Platform: Supabase RLS (Row Level Security)
- Auth: Supabase Auth (auth.uid())
- Database: PostgreSQL 15+

---

## 🔗 의존 작업

**선행 작업**: P1D6 (comments 테이블 - Phase 1에서 생성 예정)
**후속 작업**: P3F3 (댓글 컴포넌트 - Phase 3)

---

## ✅ 완료 기준

1. RLS 활성화 완료
2. 4개 정책 생성 완료
3. 본인 댓글 CRUD 테스트 통과
4. 타인 댓글 수정 차단 확인
5. 계층 구조 댓글 권한 확인 (대댓글)
6. 관리자 권한 확인

---

## 💻 구현 상세

### 1. comments 테이블 구조 (참고)

```sql
-- Phase 1 또는 Phase 3에서 생성될 테이블 구조
CREATE TABLE IF NOT EXISTS comments (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  post_id BIGINT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  parent_id BIGINT REFERENCES comments(id) ON DELETE CASCADE, -- 대댓글
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2. RLS 활성화

```sql
-- supabase/migrations/[timestamp]_comments_rls.sql

-- RLS 활성화
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
```

### 3. SELECT 정책 (모든 댓글 조회 가능)

```sql
-- 모든 사용자(비로그인 포함)가 모든 댓글 조회 가능
CREATE POLICY "Comments are viewable by everyone"
ON comments FOR SELECT
USING (true);
```

**이유**:
- 댓글은 공개 정보
- 토론의 투명성 보장
- 비로그인 사용자도 댓글 읽기 가능

### 4. INSERT 정책 (로그인 사용자만 생성)

```sql
-- 로그인한 사용자만 댓글 작성 가능
CREATE POLICY "Authenticated users can create comments"
ON comments FOR INSERT
WITH CHECK (auth.uid() = user_id);
```

**보안 특징**:
- 로그인 필수
- 다른 사용자의 이름으로 댓글 작성 불가

### 5. UPDATE 정책 (본인 댓글만 수정)

```sql
-- 본인이 작성한 댓글만 수정 가능
CREATE POLICY "Users can update their own comments"
ON comments FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);
```

**제한사항**:
- user_id, post_id, parent_id 변경 불가
- content만 수정 가능

### 6. DELETE 정책 (본인 또는 관리자만 삭제)

```sql
-- 본인이 작성한 댓글 또는 본인 게시글의 댓글 삭제 가능
CREATE POLICY "Users can delete their own comments or comments on their posts"
ON comments FOR DELETE
USING (
  auth.uid() = user_id  -- 본인 댓글
  OR
  auth.uid() = (
    SELECT user_id FROM posts WHERE id = comments.post_id
  ) -- 본인 게시글의 댓글
);
```

**권한 구조**:
1. 댓글 작성자: 자신의 댓글 삭제 가능
2. 게시글 작성자: 자신의 게시글에 달린 모든 댓글 삭제 가능 (관리 권한)

### 7. 전체 마이그레이션 SQL

```sql
-- supabase/migrations/[timestamp]_comments_rls.sql

-- RLS 활성화
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

-- SELECT: 모든 댓글 조회 가능
CREATE POLICY "Comments are viewable by everyone"
ON comments FOR SELECT
USING (true);

-- INSERT: 로그인한 사용자만 생성
CREATE POLICY "Authenticated users can create comments"
ON comments FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- UPDATE: 본인 댓글만 수정
CREATE POLICY "Users can update their own comments"
ON comments FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- DELETE: 본인 댓글 또는 본인 게시글의 댓글 삭제 가능
CREATE POLICY "Users can delete their own comments or comments on their posts"
ON comments FOR DELETE
USING (
  auth.uid() = user_id
  OR
  auth.uid() = (SELECT user_id FROM posts WHERE id = comments.post_id)
);
```

### 8. 롤백 SQL

```sql
-- supabase/migrations/[timestamp]_rollback_comments_rls.sql

-- 정책 제거
DROP POLICY IF EXISTS "Users can delete their own comments or comments on their posts" ON comments;
DROP POLICY IF EXISTS "Users can update their own comments" ON comments;
DROP POLICY IF EXISTS "Authenticated users can create comments" ON comments;
DROP POLICY IF EXISTS "Comments are viewable by everyone" ON comments;

-- RLS 비활성화 (개발 환경에서만)
-- ALTER TABLE comments DISABLE ROW LEVEL SECURITY;
```

---

## 📝 테스트 계획

### 1. RLS 활성화 확인

```sql
-- RLS 상태 확인
SELECT tablename, rowsecurity
FROM pg_tables
WHERE tablename = 'comments';

-- 정책 목록 확인
SELECT policyname, cmd, qual, with_check
FROM pg_policies
WHERE tablename = 'comments';
```

### 2. INSERT 정책 테스트

```typescript
describe('Comments RLS - INSERT', () => {
  test('로그인한 사용자는 댓글 작성 가능', async () => {
    const { data, error } = await supabase
      .from('comments')
      .insert({
        post_id: 1,
        content: '좋은 글입니다'
      })
      .select()
      .single()

    expect(error).toBeNull()
    expect(data).toBeDefined()
  })

  test('비로그인 사용자는 댓글 작성 불가', async () => {
    await supabase.auth.signOut()

    const { error } = await supabase
      .from('comments')
      .insert({
        post_id: 1,
        content: '댓글'
      })

    expect(error).toBeDefined()
  })

  test('대댓글 작성 가능', async () => {
    const { data, error } = await supabase
      .from('comments')
      .insert({
        post_id: 1,
        parent_id: commentId, // 부모 댓글 ID
        content: '답글입니다'
      })
      .select()
      .single()

    expect(error).toBeNull()
    expect(data.parent_id).toBe(commentId)
  })
})
```

### 3. UPDATE 정책 테스트

```typescript
describe('Comments RLS - UPDATE', () => {
  test('본인 댓글은 수정 가능', async () => {
    const { data, error } = await supabase
      .from('comments')
      .update({ content: '수정된 내용' })
      .eq('id', myCommentId)
      .select()
      .single()

    expect(error).toBeNull()
    expect(data.content).toBe('수정된 내용')
  })

  test('타인 댓글은 수정 불가', async () => {
    const { error } = await supabase
      .from('comments')
      .update({ content: '해킹 시도' })
      .eq('id', otherUserCommentId)

    expect(error).toBeDefined()
  })
})
```

### 4. DELETE 정책 테스트

```typescript
describe('Comments RLS - DELETE', () => {
  test('본인 댓글은 삭제 가능', async () => {
    const { error } = await supabase
      .from('comments')
      .delete()
      .eq('id', myCommentId)

    expect(error).toBeNull()
  })

  test('타인 댓글은 삭제 불가', async () => {
    const { error } = await supabase
      .from('comments')
      .delete()
      .eq('id', otherUserCommentId)

    expect(error).toBeDefined()
  })

  test('게시글 작성자는 자신의 게시글 댓글 삭제 가능', async () => {
    // postAuthor가 로그인한 상태
    // otherUser가 작성한 댓글이지만 postAuthor의 게시글에 달림
    const { error } = await supabase
      .from('comments')
      .delete()
      .eq('id', commentOnMyPost)

    expect(error).toBeNull() // 삭제 성공
  })
})
```

### 5. 대댓글 CASCADE 테스트

```sql
-- 부모 댓글 삭제 시 대댓글도 함께 삭제되는지 확인
DELETE FROM comments WHERE id = parent_comment_id;

-- 대댓글도 함께 삭제되었는지 확인
SELECT COUNT(*) FROM comments WHERE parent_id = parent_comment_id;
-- 결과: 0
```

---

## 🔒 보안 고려사항

### 주요 보안 특징

1. **2단계 삭제 권한**
   - 댓글 작성자: 자신의 댓글 삭제
   - 게시글 작성자: 자신의 게시글에 달린 모든 댓글 삭제 (모욕적/부적절한 댓글 관리)

2. **계층 구조 지원**
   - parent_id를 통한 대댓글 지원
   - ON DELETE CASCADE로 부모 댓글 삭제 시 자동 정리

3. **콘텐츠 무결성**
   - user_id, post_id 변경 불가
   - content만 수정 가능

4. **투명성**
   - 모든 댓글 공개
   - 건전한 토론 문화 조성

### XSS 방어

```typescript
// 프론트엔드에서 XSS 방어 필요
import DOMPurify from 'dompurify'

function CommentDisplay({ comment }: { comment: Comment }) {
  const sanitizedContent = DOMPurify.sanitize(comment.content)

  return (
    <div dangerouslySetInnerHTML={{ __html: sanitizedContent }} />
  )
}
```

### Rate Limiting

```typescript
// API Route에서 Rate Limiting 적용
// 1분에 최대 10개 댓글 작성 제한
import rateLimit from '@/lib/rate-limit'

const limiter = rateLimit({
  interval: 60 * 1000, // 1분
  uniqueTokenPerInterval: 500
})

export async function POST(request: Request) {
  try {
    await limiter.check(request, 10, 'COMMENT_RATE_LIMIT')
    // 댓글 생성 로직
  } catch {
    return new Response('Too many requests', { status: 429 })
  }
}
```

---

## 📌 참고사항

**작업 완료 일시**: 2025-01-17
**테스트/검토 결과**: RLS 정책 스크립트 작성 완료, 보안 테스트 케이스 작성 완료
**자동화 방식**: AI-only
**블로커**: P1D6 (comments 테이블 생성 대기)
**비고**:
- Phase 3에서 실제 사용
- Phase 2에서 미리 설정하여 Phase 3 작업 간소화
- 게시글 작성자의 댓글 관리 권한은 커뮤니티 관리에 필수
- 향후 관리자 역할 추가 시 별도 정책 필요

---

**작성 방법론**: 15DGC-AODM v3.0
**AI-Only 원칙 준수**: ✅
