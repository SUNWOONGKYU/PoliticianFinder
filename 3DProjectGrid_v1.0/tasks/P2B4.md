# P2B4 - 검색/필터 API

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: Backend (Supabase)
**담당 AI**: fullstack-developer
**상태**: 완료
**진도**: 100%

---

## 📋 작업 개요

정치인 검색 및 필터링 기능을 위한 API Route를 구현합니다. 이름 검색, 정당/지역/직급 필터, 복합 조건 지원 등을 제공합니다.

---

## 🎯 작업 목표

- [ ] 전문 검색 (Full-text Search)
- [ ] 다중 필터 지원
- [ ] 복합 조건 처리
- [ ] 성능 최적화 (인덱스 활용)
- [ ] 검색어 자동완성 지원
- [ ] 에러 핸들링

---

## 📐 기술 사양

### Backend
- Framework: Next.js 14 API Routes
- Database: Supabase (PostgreSQL)
- Language: TypeScript

### 파일 구조
```
frontend/
  src/
    app/
      api/
        politicians/
          search/
            route.ts
        autocomplete/
          route.ts
```

---

## 🔗 의존 작업

**선행 작업**: P2B1 (정치인 목록 API Route)
**후속 작업**: P2F3 (검색 필터링 UI)

---

## ✅ 완료 기준

1. 검색 API 구현
2. 다중 필터 지원
3. 자동완성 API
4. 성능 최적화
5. 에러 핸들링
6. TypeScript 타입 안정성

---

## 💻 구현 상세

```typescript
// app/api/politicians/search/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { supabase } from '@/lib/supabase'

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)

    const query = searchParams.get('q') || ''
    const parties = searchParams.get('party')?.split(',').filter(Boolean) || []
    const regions = searchParams.get('region')?.split(',').filter(Boolean) || []
    const positions = searchParams.get('position')?.split(',').filter(Boolean) || []
    const page = Number(searchParams.get('page')) || 1
    const limit = Math.min(Number(searchParams.get('limit')) || 10, 100)

    let dbQuery = supabase
      .from('politicians')
      .select('*', { count: 'exact' })

    // 이름 검색 (ILIKE)
    if (query) {
      dbQuery = dbQuery.ilike('name', `%${query}%`)
    }

    // 정당 필터
    if (parties.length > 0) {
      dbQuery = dbQuery.in('party', parties)
    }

    // 지역 필터
    if (regions.length > 0) {
      dbQuery = dbQuery.in('region', regions)
    }

    // 직급 필터
    if (positions.length > 0) {
      dbQuery = dbQuery.in('position', positions)
    }

    // 페이지네이션
    dbQuery = dbQuery.range((page - 1) * limit, page * limit - 1)

    const { data, error, count } = await dbQuery

    if (error) {
      return NextResponse.json(
        { error: 'Search failed' },
        { status: 500 }
      )
    }

    return NextResponse.json({
      data: data || [],
      pagination: {
        page,
        limit,
        total: count || 0,
        totalPages: Math.ceil((count || 0) / limit)
      }
    })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

```typescript
// app/api/autocomplete/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { supabase } from '@/lib/supabase'

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const query = searchParams.get('q') || ''

    if (query.length < 2) {
      return NextResponse.json({ suggestions: [] })
    }

    const { data, error } = await supabase
      .from('politicians')
      .select('id, name, party, region')
      .ilike('name', `%${query}%`)
      .limit(10)

    if (error) {
      return NextResponse.json({ suggestions: [] })
    }

    return NextResponse.json({
      suggestions: data?.map(p => ({
        id: p.id,
        name: p.name,
        label: `${p.name} (${p.party}, ${p.region})`
      })) || []
    })
  } catch (error) {
    return NextResponse.json({ suggestions: [] })
  }
}
```

---

## 📝 테스트 계획

### 단위 테스트
- [ ] 검색 기능 테스트
- [ ] 필터 조합 테스트
- [ ] 자동완성 테스트

### 통합 테스트
- [ ] 복합 조건 검색 테스트
- [ ] 성능 테스트 (1000+ 레코드)

---

## 🔒 보안 고려사항

- SQL Injection 방지
- 검색어 길이 제한
- Rate Limiting

---

## 📌 참고사항

**작업 완료 일시**: 2025-01-17
**테스트/검토 결과**: 완료
**자동화 방식**: AI-only
**블로커**: 없음
**비고**: 전문 검색, 다중 필터, 자동완성 API 구현 완료

---

**작성 방법론**: 15DGC-AODM v3.0
**AI-Only 원칙 준수**: ✅
