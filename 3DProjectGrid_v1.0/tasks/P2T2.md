# P2T2 - 평가 시스템 E2E

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: Test (E2E)
**담당 AI**: devops-troubleshooter
**상태**: 대기
**진도**: 0%

---

## 📋 작업 개요

시민 평가 시스템의 End-to-End 테스트를 작성합니다. 평가 생성, 수정, 삭제 및 1인 1평가 제한 등의 기능을 Playwright로 테스트합니다.

---

## 🎯 작업 목표

- [ ] 평가 생성 테스트
- [ ] 평가 수정 테스트
- [ ] 평가 삭제 테스트
- [ ] 1인 1평가 제한 테스트
- [ ] 평가 목록 조회 테스트
- [ ] 평균 평점 업데이트 테스트
- [ ] 권한 확인 테스트
- [ ] 인증 필수 테스트

---

## 📐 기술 사양

### Testing
- Framework: Playwright
- Language: TypeScript
- Auth: Supabase Test Users

---

## 🔗 의존 작업

**선행 작업**: P2B2 (시민 평가 API)
**후속 작업**: P2V2 (CI/CD 파이프라인)

---

## ✅ 완료 기준

1. 8개 이상의 E2E 테스트 작성
2. 모든 테스트 통과
3. 인증 플로우 테스트 완료
4. 1인 1평가 제약 테스트 완료
5. 에러 처리 테스트 완료

---

## 💻 구현 상세

### 1. 테스트 유틸리티 (인증 헬퍼)

```typescript
// tests/e2e/helpers/auth.ts
import { Page } from '@playwright/test'

export async function loginAsTestUser(page: Page) {
  // 테스트 계정으로 로그인
  await page.goto('/login')
  await page.locator('[data-testid="email-input"]').fill('test@example.com')
  await page.locator('[data-testid="password-input"]').fill('testpass123')
  await page.locator('[data-testid="login-button"]').click()

  // 로그인 완료 대기
  await page.waitForURL('/')
  await page.waitForSelector('[data-testid="user-menu"]')
}

export async function logoutUser(page: Page) {
  await page.locator('[data-testid="user-menu"]').click()
  await page.locator('[data-testid="logout-button"]').click()
  await page.waitForURL('/login')
}

export async function createTestRating(
  page: Page,
  politicianId: number,
  score: number,
  comment?: string
) {
  await page.goto(`/politicians/${politicianId}`)

  // 평가 작성 버튼 클릭
  await page.locator('[data-testid="write-rating-button"]').click()

  // 평점 선택
  await page.locator(`[data-testid="rating-star-${score}"]`).click()

  // 코멘트 입력 (선택)
  if (comment) {
    await page.locator('[data-testid="rating-comment"]').fill(comment)
  }

  // 제출
  await page.locator('[data-testid="submit-rating"]').click()

  // 성공 메시지 대기
  await page.waitForSelector('[data-testid="rating-success"]')
}
```

### 2. 평가 생성 테스트

```typescript
// tests/e2e/rating-create.spec.ts
import { test, expect } from '@playwright/test'
import { loginAsTestUser } from './helpers/auth'

test.describe('평가 생성', () => {
  test.beforeEach(async ({ page }) => {
    await loginAsTestUser(page)
  })

  test('정치인 평가 작성', async ({ page }) => {
    await page.goto('/politicians/1')

    // 평가 작성 버튼 클릭
    await page.locator('[data-testid="write-rating-button"]').click()

    // 평가 모달/폼 표시 확인
    await expect(page.locator('[data-testid="rating-modal"]')).toBeVisible()

    // 평점 선택 (5점)
    await page.locator('[data-testid="rating-star-5"]').click()

    // 별 표시 확인
    const stars = page.locator('[data-testid^="rating-star-"]')
    for (let i = 1; i <= 5; i++) {
      await expect(stars.nth(i - 1)).toHaveClass(/filled/)
    }

    // 코멘트 입력
    const comment = '훌륭한 정치인입니다'
    await page.locator('[data-testid="rating-comment"]').fill(comment)

    // 제출
    await page.locator('[data-testid="submit-rating"]').click()

    // 성공 메시지 확인
    await expect(page.locator('[data-testid="toast-success"]')).toBeVisible()
    await expect(page.locator('[data-testid="toast-success"]')).toContainText(
      '평가가 등록되었습니다'
    )

    // 평가 목록에 표시 확인
    await expect(page.locator('[data-testid="my-rating"]')).toBeVisible()
    await expect(page.locator('[data-testid="my-rating"]')).toContainText(comment)

    // 평균 평점 업데이트 확인
    const avgRating = await page.locator('[data-testid="avg-rating"]').textContent()
    expect(parseFloat(avgRating!)).toBeGreaterThan(0)
  })

  test('코멘트 없이 평가 작성', async ({ page }) => {
    await page.goto('/politicians/1')
    await page.locator('[data-testid="write-rating-button"]').click()

    // 평점만 선택
    await page.locator('[data-testid="rating-star-4"]').click()

    // 제출
    await page.locator('[data-testid="submit-rating"]').click()

    // 성공 확인
    await expect(page.locator('[data-testid="toast-success"]')).toBeVisible()
  })

  test('평점 선택 없이 제출 시 에러', async ({ page }) => {
    await page.goto('/politicians/1')
    await page.locator('[data-testid="write-rating-button"]').click()

    // 평점 선택 없이 제출
    await page.locator('[data-testid="submit-rating"]').click()

    // 에러 메시지 확인
    await expect(page.locator('[data-testid="rating-error"]')).toBeVisible()
    await expect(page.locator('[data-testid="rating-error"]')).toContainText(
      '평점을 선택해주세요'
    )
  })
})
```

### 3. 1인 1평가 제한 테스트

```typescript
// tests/e2e/rating-constraint.spec.ts
import { test, expect } from '@playwright/test'
import { loginAsTestUser, createTestRating } from './helpers/auth'

test.describe('1인 1평가 제한', () => {
  test.beforeEach(async ({ page }) => {
    await loginAsTestUser(page)
  })

  test('이미 평가한 정치인에게 중복 평가 불가', async ({ page }) => {
    const politicianId = 1

    // 첫 번째 평가 작성
    await createTestRating(page, politicianId, 5, '첫 번째 평가')

    // 페이지 새로고침
    await page.reload()

    // 평가 작성 버튼이 "수정하기"로 변경됨
    await expect(page.locator('[data-testid="write-rating-button"]')).not.toBeVisible()
    await expect(page.locator('[data-testid="edit-rating-button"]')).toBeVisible()
  })

  test('이미 평가한 경우 평가 작성 폼 대신 수정 폼 표시', async ({ page }) => {
    await page.goto('/politicians/1')

    // 이미 평가가 있는 경우
    const hasRating = await page.locator('[data-testid="my-rating"]').isVisible()

    if (hasRating) {
      // 수정 버튼만 표시
      await expect(page.locator('[data-testid="edit-rating-button"]')).toBeVisible()
      await expect(page.locator('[data-testid="write-rating-button"]')).not.toBeVisible()
    } else {
      // 작성 버튼만 표시
      await expect(page.locator('[data-testid="write-rating-button"]')).toBeVisible()
      await expect(page.locator('[data-testid="edit-rating-button"]')).not.toBeVisible()
    }
  })
})
```

### 4. 평가 수정 테스트

```typescript
// tests/e2e/rating-update.spec.ts
import { test, expect } from '@playwright/test'
import { loginAsTestUser, createTestRating } from './helpers/auth'

test.describe('평가 수정', () => {
  test.beforeEach(async ({ page }) => {
    await loginAsTestUser(page)
  })

  test('본인 평가 수정', async ({ page }) => {
    const politicianId = 1

    // 평가 작성 (없는 경우)
    await page.goto(`/politicians/${politicianId}`)
    const hasRating = await page.locator('[data-testid="my-rating"]').isVisible()

    if (!hasRating) {
      await createTestRating(page, politicianId, 3, '초기 평가')
    }

    // 수정 버튼 클릭
    await page.locator('[data-testid="edit-rating-button"]').click()

    // 기존 평점 및 코멘트 표시 확인
    await expect(page.locator('[data-testid="rating-star-3"]')).toHaveClass(/filled/)

    // 평점 변경 (5점)
    await page.locator('[data-testid="rating-star-5"]').click()

    // 코멘트 변경
    const newComment = '수정된 평가입니다'
    await page.locator('[data-testid="rating-comment"]').clear()
    await page.locator('[data-testid="rating-comment"]').fill(newComment)

    // 수정 제출
    await page.locator('[data-testid="update-rating"]').click()

    // 성공 메시지
    await expect(page.locator('[data-testid="toast-success"]')).toContainText(
      '평가가 수정되었습니다'
    )

    // 변경 사항 확인
    await expect(page.locator('[data-testid="my-rating"]')).toContainText(newComment)

    // 평균 평점 재계산 확인
    const avgRating = await page.locator('[data-testid="avg-rating"]').textContent()
    expect(avgRating).toBeDefined()
  })

  test('평가 수정 취소', async ({ page }) => {
    await page.goto('/politicians/1')

    // 수정 버튼 클릭
    await page.locator('[data-testid="edit-rating-button"]').click()

    // 원본 코멘트 저장
    const originalComment = await page
      .locator('[data-testid="rating-comment"]')
      .inputValue()

    // 코멘트 변경
    await page.locator('[data-testid="rating-comment"]').fill('변경할 내용')

    // 취소 버튼 클릭
    await page.locator('[data-testid="cancel-edit"]').click()

    // 모달 닫힘 확인
    await expect(page.locator('[data-testid="rating-modal"]')).not.toBeVisible()

    // 원본 코멘트 유지 확인
    await expect(page.locator('[data-testid="my-rating"]')).toContainText(originalComment)
  })
})
```

### 5. 평가 삭제 테스트

```typescript
// tests/e2e/rating-delete.spec.ts
import { test, expect } from '@playwright/test'
import { loginAsTestUser, createTestRating } from './helpers/auth'

test.describe('평가 삭제', () => {
  test.beforeEach(async ({ page }) => {
    await loginAsTestUser(page)
  })

  test('본인 평가 삭제', async ({ page }) => {
    const politicianId = 1

    // 평가 작성 (없는 경우)
    await page.goto(`/politicians/${politicianId}`)
    const hasRating = await page.locator('[data-testid="my-rating"]').isVisible()

    if (!hasRating) {
      await createTestRating(page, politicianId, 4, '삭제할 평가')
    }

    // 삭제 버튼 클릭
    await page.locator('[data-testid="delete-rating-button"]').click()

    // 확인 다이얼로그
    await expect(page.locator('[data-testid="confirm-dialog"]')).toBeVisible()
    await expect(page.locator('[data-testid="confirm-dialog"]')).toContainText(
      '정말 삭제하시겠습니까?'
    )

    // 확인 버튼 클릭
    await page.locator('[data-testid="confirm-delete"]').click()

    // 성공 메시지
    await expect(page.locator('[data-testid="toast-success"]')).toContainText(
      '평가가 삭제되었습니다'
    )

    // 평가 제거 확인
    await expect(page.locator('[data-testid="my-rating"]')).not.toBeVisible()

    // 평가 작성 버튼 다시 표시
    await expect(page.locator('[data-testid="write-rating-button"]')).toBeVisible()

    // 평균 평점 재계산
    const avgRating = await page.locator('[data-testid="avg-rating"]').textContent()
    expect(avgRating).toBeDefined()
  })

  test('삭제 취소', async ({ page }) => {
    await page.goto('/politicians/1')

    // 삭제 버튼 클릭
    await page.locator('[data-testid="delete-rating-button"]').click()

    // 취소 버튼 클릭
    await page.locator('[data-testid="cancel-delete"]').click()

    // 다이얼로그 닫힘
    await expect(page.locator('[data-testid="confirm-dialog"]')).not.toBeVisible()

    // 평가 유지
    await expect(page.locator('[data-testid="my-rating"]')).toBeVisible()
  })
})
```

### 6. 인증 필수 테스트

```typescript
// tests/e2e/rating-auth.spec.ts
import { test, expect } from '@playwright/test'

test.describe('평가 시스템 인증 요구', () => {
  test('비로그인 상태에서 평가 작성 불가', async ({ page }) => {
    await page.goto('/politicians/1')

    // 평가 작성 버튼 클릭
    await page.locator('[data-testid="write-rating-button"]').click()

    // 로그인 페이지로 리디렉션
    await expect(page).toHaveURL(/\/login/)

    // 또는 로그인 모달 표시
    await expect(page.locator('[data-testid="login-modal"]')).toBeVisible()
    await expect(page.locator('[data-testid="login-modal"]')).toContainText(
      '로그인이 필요합니다'
    )
  })

  test('비로그인 상태에서 평가 목록은 조회 가능', async ({ page }) => {
    await page.goto('/politicians/1')

    // 평가 목록은 보임
    const ratings = page.locator('[data-testid="rating-item"]')
    await expect(ratings).toBeVisible()

    // 평균 평점도 보임
    await expect(page.locator('[data-testid="avg-rating"]')).toBeVisible()
  })
})
```

### 7. 평가 목록 조회 테스트

```typescript
// tests/e2e/rating-list.spec.ts
import { test, expect } from '@playwright/test'

test.describe('평가 목록 조회', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/politicians/1')
  })

  test('평가 목록 표시', async ({ page }) => {
    // 평가 목록 섹션 표시
    await expect(page.locator('[data-testid="ratings-section"]')).toBeVisible()

    // 평가 아이템 표시
    const ratings = page.locator('[data-testid="rating-item"]')
    const count = await ratings.count()
    expect(count).toBeGreaterThan(0)

    // 첫 번째 평가 내용 확인
    const firstRating = ratings.first()
    await expect(firstRating.locator('[data-testid="rating-author"]')).toBeVisible()
    await expect(firstRating.locator('[data-testid="rating-score"]')).toBeVisible()
    await expect(firstRating.locator('[data-testid="rating-date"]')).toBeVisible()
  })

  test('평가 페이지네이션', async ({ page }) => {
    // 첫 페이지 평가 수 확인
    const ratings = page.locator('[data-testid="rating-item"]')
    const firstPageCount = await ratings.count()

    // 다음 페이지
    await page.locator('[data-testid="ratings-next-page"]').click()

    // 새로운 평가 로드 확인
    await page.waitForTimeout(500)
    const firstRatingId = await ratings.first().getAttribute('data-rating-id')

    expect(firstRatingId).toBeDefined()
  })

  test('평가 정렬 (최신순)', async ({ page }) => {
    // 정렬 옵션 선택
    await page.locator('[data-testid="rating-sort"]').selectOption('created_at_desc')

    // 날짜 순서 확인
    const dates = await page
      .locator('[data-testid="rating-date"]')
      .allTextContents()
      .then(texts => texts.map(t => new Date(t)))

    // 내림차순 확인
    for (let i = 0; i < dates.length - 1; i++) {
      expect(dates[i].getTime()).toBeGreaterThanOrEqual(dates[i + 1].getTime())
    }
  })
})
```

---

## 📝 테스트 실행

```bash
# 평가 시스템 E2E 테스트만 실행
npx playwright test rating

# 특정 파일 실행
npx playwright test rating-create.spec.ts

# 디버그 모드
npx playwright test rating-create.spec.ts --debug
```

---

## 🔒 보안 고려사항

- 테스트 계정은 별도 격리된 환경에서만 사용
- 테스트 후 생성된 데이터 자동 정리 (cleanup)
- RLS 정책 동작 확인

---

## 📌 참고사항

**작업 완료 일시**: 대기중
**테스트/검토 결과**: 대기
**자동화 방식**: AI-only
**블로커**: 없음
**비고**:
- 1인 1평가 제약은 UI와 DB 양측에서 검증
- 평균 평점은 실시간으로 재계산되어 표시
- 테스트 데이터는 각 테스트 후 정리 권장

---

**작성 방법론**: 15DGC-AODM v3.0
**AI-Only 원칙 준수**: ✅
