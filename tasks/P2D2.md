# P2D2: 실시간 인기글 시스템

## 작업 ID
P2D2

## 작업 개요
시간 감쇠 알고리즘을 적용한 실시간 인기글 시스템 구축

## 담당 AI
fullstack-developer

## 의존 작업
없음

## 작업 내용

### 1. posts 테이블 컬럼 추가
```sql
ALTER TABLE posts ADD COLUMN hot_score DECIMAL(10,2) DEFAULT 0;
ALTER TABLE posts ADD COLUMN is_hot BOOLEAN DEFAULT false;
ALTER TABLE posts ADD COLUMN trending_rank INTEGER;
```

### 2. hot_score 계산 함수
```sql
CREATE FUNCTION calculate_hot_score(
  p_view_count INTEGER,
  p_upvotes INTEGER,
  p_downvotes INTEGER,
  p_comment_count INTEGER,
  p_created_at TIMESTAMP WITH TIME ZONE
) RETURNS DECIMAL
```

알고리즘:
- **기본 점수**: 조회수(0.1배) + 추천수(3배) + 댓글수(2배)
- **시간 감쇠**: e^(-t/24) (24시간 반감기)
- **논쟁도 반영**: 반대표 비율에 따라 최대 30% 가중치
- **최종 점수**: 기본점수 × 논쟁도 × 시간감쇠

### 3. 자동 업데이트 트리거
- posts 테이블 INSERT/UPDATE 시
- comments 테이블 INSERT/DELETE 시
- hot_score 자동 재계산

### 4. v_hot_posts_top15 뷰
- 최근 7일 이내 게시글
- hot_score 내림차순
- 작성자 정보 포함
- 댓글 수 집계

### 5. trending_rank 캐시 시스템
```sql
CREATE FUNCTION update_trending_ranks() RETURNS void
```
- 5분마다 실행 예정
- TOP 100 순위 캐시

## 산출물
- `supabase/migrations/20251020_P2D2_hot_posts_system.sql`

## 검증 방법
```sql
-- hot_score 계산 테스트
SELECT calculate_hot_score(1000, 50, 10, 25, NOW() - INTERVAL '2 hours');

-- 인기글 TOP 15 조회
SELECT * FROM v_hot_posts_top15;

-- HOT 뱃지 게시글 확인
SELECT COUNT(*) FROM posts WHERE is_hot = true;
```

## 예상 소요 시간
45분

## 완료 조건
- [x] posts 테이블에 3개 컬럼 추가
- [x] calculate_hot_score 함수 생성
- [x] 자동 업데이트 트리거 2개 생성
- [x] v_hot_posts_top15 뷰 생성
- [x] update_trending_ranks 함수 생성
- [x] 기존 게시글 hot_score 계산
- [x] Migration 파일 작성 완료

## 상태
✅ 완료 (2025-10-20 01:00)
