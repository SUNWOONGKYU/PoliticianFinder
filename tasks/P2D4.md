# P2D4: 사이드바 위젯 시스템 (8개 위젯)

## 작업 ID
P2D4

## 작업 개요
메인 페이지 사이드바 8개 위젯을 위한 데이터 시스템 구축

## 담당 AI
fullstack-developer

## 의존 작업
P2D1, P2D2, P2D3

## 작업 내용

### 위젯 1: 정치인 등록 현황
```sql
CREATE VIEW v_politician_stats AS
SELECT
  COUNT(*) as total_count,
  COUNT(*) FILTER (WHERE status = '현직') as active_count,
  COUNT(*) FILTER (WHERE status = '후보자') as candidate_count,
  COUNT(*) FILTER (WHERE created_at > NOW() - INTERVAL '7 days') as new_this_week
FROM politicians;
```

### 위젯 2: 평점 급상승 정치인
```sql
CREATE TABLE politician_score_history (
  id BIGSERIAL PRIMARY KEY,
  politician_id INTEGER NOT NULL,
  composite_score DECIMAL(4,1),
  recorded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE VIEW v_trending_politicians -- TOP 3
```

### 위젯 3: 명예의 전당
```sql
CREATE VIEW v_hall_of_fame -- 90점 이상 TOP 3
```

### 위젯 4: 사용자 레벨 시스템
```sql
CREATE FUNCTION get_user_level_info(p_points INTEGER)
-- 1000 XP당 레벨업
```

### 위젯 5: 실시간 통계
```sql
CREATE VIEW v_realtime_stats
-- 1시간 새 글/댓글, 24시간 활성 사용자
```

### 위젯 6: 최근 댓글
```sql
CREATE VIEW v_recent_comments_widget -- 최근 5개
```

### 위젯 7: 연결 서비스
```sql
CREATE TABLE connected_services (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(100),
  category VARCHAR(50),
  description TEXT,
  icon VARCHAR(50)
)
```

### 위젯 8: 광고
```sql
CREATE TABLE widget_ads (
  id BIGSERIAL PRIMARY KEY,
  title VARCHAR(200),
  content TEXT,
  image_url VARCHAR(500),
  is_active BOOLEAN
)
```

### 통합 함수
```sql
CREATE FUNCTION get_sidebar_data(p_user_id UUID DEFAULT NULL)
RETURNS JSON
-- 모든 위젯 데이터 한번에 조회
```

## 산출물
- `supabase/migrations/20251020_P2D4_sidebar_widgets.sql`

## 검증 방법
```sql
SELECT get_sidebar_data(NULL);
SELECT * FROM v_politician_stats;
SELECT * FROM v_trending_politicians;
```

## 예상 소요 시간
1시간

## 완료 조건
- [x] 6개 뷰 생성
- [x] 4개 테이블 생성
- [x] 2개 함수 생성
- [x] get_sidebar_data 통합 함수 생성
- [x] 샘플 데이터 삽입

## 상태
✅ 완료 (2025-10-20 01:00)
