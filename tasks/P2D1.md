# P2D1: AI 평점 시스템 확장 (5 AI 지원)

## 작업 ID
P2D1

## 작업 개요
기존 Claude 단일 AI 평점 시스템을 5개 AI(Claude, GPT, Gemini, Grok, Perplexity)를 지원하도록 확장

## 담당 AI
fullstack-developer

## 의존 작업
없음

## 작업 내용

### 1. ai_scores 테이블 컬럼 추가
```sql
ALTER TABLE ai_scores ADD COLUMN IF NOT EXISTS gpt_score DECIMAL(4,1);
ALTER TABLE ai_scores ADD COLUMN IF NOT EXISTS gemini_score DECIMAL(4,1);
ALTER TABLE ai_scores ADD COLUMN IF NOT EXISTS grok_score DECIMAL(4,1);
ALTER TABLE ai_scores ADD COLUMN IF NOT EXISTS perplexity_score DECIMAL(4,1);
```

### 2. composite_score 계산 함수 생성
```sql
CREATE FUNCTION calculate_composite_score(
  claude DECIMAL,
  gpt DECIMAL DEFAULT NULL,
  gemini DECIMAL DEFAULT NULL,
  grok DECIMAL DEFAULT NULL,
  perp DECIMAL DEFAULT NULL
) RETURNS DECIMAL
```
- 모든 AI 점수의 평균 계산
- NULL 값 자동 제외
- IMMUTABLE 함수로 성능 최적화

### 3. 자동 업데이트 트리거
```sql
CREATE TRIGGER trigger_update_composite_score
BEFORE INSERT OR UPDATE ON ai_scores
FOR EACH ROW EXECUTE FUNCTION update_composite_score();
```

### 4. v_ai_ranking_top10 뷰 생성
- AI 종합 평점 TOP 10 조회
- 회원 평점 통합 표시
- 정치인 기본 정보 포함

## 산출물
- `supabase/migrations/20251020_P2D1_ai_scores_extension.sql`

## 검증 방법
```sql
-- 컬럼 추가 확인
SELECT column_name FROM information_schema.columns
WHERE table_name = 'ai_scores'
AND column_name IN ('gpt_score', 'gemini_score', 'grok_score', 'perplexity_score');

-- 함수 생성 확인
SELECT routine_name FROM information_schema.routines
WHERE routine_name = 'calculate_composite_score';

-- 뷰 생성 확인
SELECT * FROM v_ai_ranking_top10 LIMIT 5;
```

## 예상 소요 시간
30분

## 완료 조건
- [x] ai_scores 테이블에 4개 컬럼 추가
- [x] calculate_composite_score 함수 생성
- [x] 자동 업데이트 트리거 생성
- [x] v_ai_ranking_top10 뷰 생성
- [x] 기존 데이터 composite_score 업데이트
- [x] Migration 파일 작성 완료

## 상태
✅ 완료 (2025-10-20 01:00)
