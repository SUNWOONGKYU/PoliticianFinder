# P2S1 - CORS 설정

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: Security
**담당 AI**: security-auditor
**상태**: 대기
**진도**: 0%

---

## 📋 작업 개요

Cross-Origin Resource Sharing (CORS) 정책을 설정하여 허용된 도메인에서만 API 접근이 가능하도록 합니다. 보안을 강화하면서도 필요한 외부 접근은 허용합니다.

---

## 🎯 작업 목표

- [ ] Next.js API Routes CORS 설정
- [ ] Supabase CORS 설정
- [ ] 허용 도메인 화이트리스트 관리
- [ ] Preflight 요청 처리
- [ ] CORS 헤더 설정
- [ ] 에러 핸들링

---

## 📐 기술 사양

### Security
- Framework: Next.js 14 API Routes
- Library: cors (선택사항)
- Platform: Supabase

---

## 🔗 의존 작업

**선행 작업**: P1B1 (Supabase Auth 통합)
**후속 작업**: P3S1 (XSS 방어 - Phase 3)

---

## ✅ 완료 기준

1. CORS 정책 설정 완료
2. 허용 도메인 화이트리스트 구성
3. Preflight 요청 처리 확인
4. 크로스 오리진 테스트 통과
5. 보안 헤더 설정 완료

---

## 💻 구현 상세

### 1. Next.js API Routes CORS 설정

```typescript
// lib/cors.ts
import { NextRequest, NextResponse } from 'next/server'

const allowedOrigins = [
  'https://politician-finder.com',
  'https://www.politician-finder.com',
  'https://politician-finder.vercel.app',
  process.env.NODE_ENV === 'development' ? 'http://localhost:3000' : null
].filter(Boolean) as string[]

export function corsHeaders(origin: string | null) {
  const isAllowedOrigin = origin && allowedOrigins.includes(origin)

  return {
    'Access-Control-Allow-Origin': isAllowedOrigin ? origin : allowedOrigins[0],
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Credentials': 'true',
    'Access-Control-Max-Age': '86400' // 24시간
  }
}

export function handleCors(request: NextRequest) {
  const origin = request.headers.get('origin')

  // Preflight 요청 처리
  if (request.method === 'OPTIONS') {
    return new NextResponse(null, {
      status: 204,
      headers: corsHeaders(origin)
    })
  }

  return null
}

export function withCors(handler: Function) {
  return async (request: NextRequest, context?: any) => {
    // Preflight 요청 처리
    const corsResponse = handleCors(request)
    if (corsResponse) return corsResponse

    // 실제 요청 처리
    const response = await handler(request, context)

    // CORS 헤더 추가
    const origin = request.headers.get('origin')
    const headers = corsHeaders(origin)

    Object.entries(headers).forEach(([key, value]) => {
      response.headers.set(key, value)
    })

    return response
  }
}
```

### 2. API Route에 CORS 적용

```typescript
// app/api/politicians/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { withCors } from '@/lib/cors'
import { supabase } from '@/lib/supabase'

async function handler(request: NextRequest) {
  try {
    const { data, error } = await supabase
      .from('politicians')
      .select('*')
      .limit(10)

    if (error) throw error

    return NextResponse.json({ data })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

export const GET = withCors(handler)
export const OPTIONS = withCors(() => new NextResponse(null, { status: 204 }))
```

### 3. Middleware CORS 설정

```typescript
// middleware.ts
import { NextRequest, NextResponse } from 'next/server'

const allowedOrigins = [
  'https://politician-finder.com',
  'https://www.politician-finder.com',
  process.env.NODE_ENV === 'development' ? 'http://localhost:3000' : null
].filter(Boolean)

export function middleware(request: NextRequest) {
  const origin = request.headers.get('origin')
  const response = NextResponse.next()

  // API 요청에만 CORS 적용
  if (request.nextUrl.pathname.startsWith('/api')) {
    // Origin 검증
    if (origin && allowedOrigins.includes(origin)) {
      response.headers.set('Access-Control-Allow-Origin', origin)
      response.headers.set('Access-Control-Allow-Credentials', 'true')
    }

    // Preflight 요청
    if (request.method === 'OPTIONS') {
      response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
      response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization')
      response.headers.set('Access-Control-Max-Age', '86400')
      return new NextResponse(null, { status: 204, headers: response.headers })
    }
  }

  return response
}

export const config = {
  matcher: '/api/:path*'
}
```

### 4. Supabase CORS 설정

**Supabase Dashboard > Settings > API:**

```
Allowed Origins:
- https://politician-finder.com
- https://www.politician-finder.com
- https://politician-finder.vercel.app
- http://localhost:3000 (개발 환경)
```

### 5. next.config.js 헤더 설정

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          {
            key: 'Access-Control-Allow-Credentials',
            value: 'true'
          },
          {
            key: 'Access-Control-Allow-Origin',
            value: process.env.ALLOWED_ORIGIN || 'https://politician-finder.com'
          },
          {
            key: 'Access-Control-Allow-Methods',
            value: 'GET,POST,PUT,DELETE,OPTIONS'
          },
          {
            key: 'Access-Control-Allow-Headers',
            value: 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization'
          }
        ]
      }
    ]
  }
}

module.exports = nextConfig
```

### 6. 환경변수 설정

```env
# .env.local
ALLOWED_ORIGINS=https://politician-finder.com,https://www.politician-finder.com
NODE_ENV=development
```

### 7. CORS 테스트

```typescript
// tests/security/cors.test.ts
import { describe, test, expect } from '@jest/globals'

describe('CORS Security', () => {
  test('허용된 origin에서 요청 성공', async () => {
    const response = await fetch('http://localhost:3000/api/politicians', {
      headers: {
        Origin: 'https://politician-finder.com'
      }
    })

    expect(response.headers.get('Access-Control-Allow-Origin')).toBe(
      'https://politician-finder.com'
    )
  })

  test('허용되지 않은 origin 차단', async () => {
    const response = await fetch('http://localhost:3000/api/politicians', {
      headers: {
        Origin: 'https://malicious-site.com'
      }
    })

    expect(response.headers.get('Access-Control-Allow-Origin')).not.toBe(
      'https://malicious-site.com'
    )
  })

  test('Preflight 요청 처리', async () => {
    const response = await fetch('http://localhost:3000/api/politicians', {
      method: 'OPTIONS',
      headers: {
        Origin: 'https://politician-finder.com',
        'Access-Control-Request-Method': 'POST'
      }
    })

    expect(response.status).toBe(204)
    expect(response.headers.get('Access-Control-Allow-Methods')).toContain('POST')
  })
})
```

---

## 📝 CORS 정책 설명

### 허용 정책
- **Origin**: 화이트리스트에 등록된 도메인만 허용
- **Methods**: GET, POST, PUT, DELETE, OPTIONS
- **Headers**: Content-Type, Authorization
- **Credentials**: 쿠키 및 인증 정보 허용

### 차단 정책
- 화이트리스트에 없는 도메인
- 허용되지 않은 HTTP 메서드
- 비정상적인 헤더

---

## 🔒 보안 고려사항

### CORS 우회 공격 방어
- Origin 헤더 검증 강화
- Wildcard (*) 사용 금지
- Null origin 차단

### 추가 보안 헤더
```typescript
// 추가 보안 헤더
response.headers.set('X-Content-Type-Options', 'nosniff')
response.headers.set('X-Frame-Options', 'DENY')
response.headers.set('X-XSS-Protection', '1; mode=block')
response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
```

---

## 📌 참고사항

**작업 완료 일시**: 대기중
**테스트/검토 결과**: 대기
**자동화 방식**: AI-only
**블로커**: 없음
**비고**:
- CORS는 브라우저 보안 기능
- 서버 간 통신에는 적용되지 않음
- Preflight 요청은 OPTIONS 메서드 사용

---

**작성 방법론**: 13DGC-AODM v1.1
**AI-Only 원칙 준수**: ✅
