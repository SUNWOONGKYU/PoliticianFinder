# P2S1 - CORS ì„¤ì •

**Phase**: Phase 2 - ì •ì¹˜ì¸ ëª©ë¡/ìƒì„¸
**ì˜ì—­**: Security
**ë‹´ë‹¹ AI**: security-auditor
**ìƒíƒœ**: ëŒ€ê¸°
**ì§„ë„**: 0%

---

## ğŸ“‹ ì‘ì—… ê°œìš”

Cross-Origin Resource Sharing (CORS) ì •ì±…ì„ ì„¤ì •í•˜ì—¬ í—ˆìš©ëœ ë„ë©”ì¸ì—ì„œë§Œ API ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë„ë¡ í•©ë‹ˆë‹¤. ë³´ì•ˆì„ ê°•í™”í•˜ë©´ì„œë„ í•„ìš”í•œ ì™¸ë¶€ ì ‘ê·¼ì€ í—ˆìš©í•©ë‹ˆë‹¤.

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

- [ ] Next.js API Routes CORS ì„¤ì •
- [ ] Supabase CORS ì„¤ì •
- [ ] í—ˆìš© ë„ë©”ì¸ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
- [ ] Preflight ìš”ì²­ ì²˜ë¦¬
- [ ] CORS í—¤ë” ì„¤ì •
- [ ] ì—ëŸ¬ í•¸ë“¤ë§

---

## ğŸ“ ê¸°ìˆ  ì‚¬ì–‘

### Security
- Framework: Next.js 14 API Routes
- Library: cors (ì„ íƒì‚¬í•­)
- Platform: Supabase

---

## ğŸ”— ì˜ì¡´ ì‘ì—…

**ì„ í–‰ ì‘ì—…**: P1B1 (Supabase Auth í†µí•©)
**í›„ì† ì‘ì—…**: P3S1 (XSS ë°©ì–´ - Phase 3)

---

## âœ… ì™„ë£Œ ê¸°ì¤€

1. CORS ì •ì±… ì„¤ì • ì™„ë£Œ
2. í—ˆìš© ë„ë©”ì¸ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ êµ¬ì„±
3. Preflight ìš”ì²­ ì²˜ë¦¬ í™•ì¸
4. í¬ë¡œìŠ¤ ì˜¤ë¦¬ì§„ í…ŒìŠ¤íŠ¸ í†µê³¼
5. ë³´ì•ˆ í—¤ë” ì„¤ì • ì™„ë£Œ

---

## ğŸ’» êµ¬í˜„ ìƒì„¸

### 1. Next.js API Routes CORS ì„¤ì •

```typescript
// lib/cors.ts
import { NextRequest, NextResponse } from 'next/server'

const allowedOrigins = [
  'https://politician-finder.com',
  'https://www.politician-finder.com',
  'https://politician-finder.vercel.app',
  process.env.NODE_ENV === 'development' ? 'http://localhost:3000' : null
].filter(Boolean) as string[]

export function corsHeaders(origin: string | null) {
  const isAllowedOrigin = origin && allowedOrigins.includes(origin)

  return {
    'Access-Control-Allow-Origin': isAllowedOrigin ? origin : allowedOrigins[0],
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Allow-Credentials': 'true',
    'Access-Control-Max-Age': '86400' // 24ì‹œê°„
  }
}

export function handleCors(request: NextRequest) {
  const origin = request.headers.get('origin')

  // Preflight ìš”ì²­ ì²˜ë¦¬
  if (request.method === 'OPTIONS') {
    return new NextResponse(null, {
      status: 204,
      headers: corsHeaders(origin)
    })
  }

  return null
}

export function withCors(handler: Function) {
  return async (request: NextRequest, context?: any) => {
    // Preflight ìš”ì²­ ì²˜ë¦¬
    const corsResponse = handleCors(request)
    if (corsResponse) return corsResponse

    // ì‹¤ì œ ìš”ì²­ ì²˜ë¦¬
    const response = await handler(request, context)

    // CORS í—¤ë” ì¶”ê°€
    const origin = request.headers.get('origin')
    const headers = corsHeaders(origin)

    Object.entries(headers).forEach(([key, value]) => {
      response.headers.set(key, value)
    })

    return response
  }
}
```

### 2. API Routeì— CORS ì ìš©

```typescript
// app/api/politicians/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { withCors } from '@/lib/cors'
import { supabase } from '@/lib/supabase'

async function handler(request: NextRequest) {
  try {
    const { data, error } = await supabase
      .from('politicians')
      .select('*')
      .limit(10)

    if (error) throw error

    return NextResponse.json({ data })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

export const GET = withCors(handler)
export const OPTIONS = withCors(() => new NextResponse(null, { status: 204 }))
```

### 3. Middleware CORS ì„¤ì •

```typescript
// middleware.ts
import { NextRequest, NextResponse } from 'next/server'

const allowedOrigins = [
  'https://politician-finder.com',
  'https://www.politician-finder.com',
  process.env.NODE_ENV === 'development' ? 'http://localhost:3000' : null
].filter(Boolean)

export function middleware(request: NextRequest) {
  const origin = request.headers.get('origin')
  const response = NextResponse.next()

  // API ìš”ì²­ì—ë§Œ CORS ì ìš©
  if (request.nextUrl.pathname.startsWith('/api')) {
    // Origin ê²€ì¦
    if (origin && allowedOrigins.includes(origin)) {
      response.headers.set('Access-Control-Allow-Origin', origin)
      response.headers.set('Access-Control-Allow-Credentials', 'true')
    }

    // Preflight ìš”ì²­
    if (request.method === 'OPTIONS') {
      response.headers.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
      response.headers.set('Access-Control-Allow-Headers', 'Content-Type, Authorization')
      response.headers.set('Access-Control-Max-Age', '86400')
      return new NextResponse(null, { status: 204, headers: response.headers })
    }
  }

  return response
}

export const config = {
  matcher: '/api/:path*'
}
```

### 4. Supabase CORS ì„¤ì •

**Supabase Dashboard > Settings > API:**

```
Allowed Origins:
- https://politician-finder.com
- https://www.politician-finder.com
- https://politician-finder.vercel.app
- http://localhost:3000 (ê°œë°œ í™˜ê²½)
```

### 5. next.config.js í—¤ë” ì„¤ì •

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          {
            key: 'Access-Control-Allow-Credentials',
            value: 'true'
          },
          {
            key: 'Access-Control-Allow-Origin',
            value: process.env.ALLOWED_ORIGIN || 'https://politician-finder.com'
          },
          {
            key: 'Access-Control-Allow-Methods',
            value: 'GET,POST,PUT,DELETE,OPTIONS'
          },
          {
            key: 'Access-Control-Allow-Headers',
            value: 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization'
          }
        ]
      }
    ]
  }
}

module.exports = nextConfig
```

### 6. í™˜ê²½ë³€ìˆ˜ ì„¤ì •

```env
# .env.local
ALLOWED_ORIGINS=https://politician-finder.com,https://www.politician-finder.com
NODE_ENV=development
```

### 7. CORS í…ŒìŠ¤íŠ¸

```typescript
// tests/security/cors.test.ts
import { describe, test, expect } from '@jest/globals'

describe('CORS Security', () => {
  test('í—ˆìš©ëœ originì—ì„œ ìš”ì²­ ì„±ê³µ', async () => {
    const response = await fetch('http://localhost:3000/api/politicians', {
      headers: {
        Origin: 'https://politician-finder.com'
      }
    })

    expect(response.headers.get('Access-Control-Allow-Origin')).toBe(
      'https://politician-finder.com'
    )
  })

  test('í—ˆìš©ë˜ì§€ ì•Šì€ origin ì°¨ë‹¨', async () => {
    const response = await fetch('http://localhost:3000/api/politicians', {
      headers: {
        Origin: 'https://malicious-site.com'
      }
    })

    expect(response.headers.get('Access-Control-Allow-Origin')).not.toBe(
      'https://malicious-site.com'
    )
  })

  test('Preflight ìš”ì²­ ì²˜ë¦¬', async () => {
    const response = await fetch('http://localhost:3000/api/politicians', {
      method: 'OPTIONS',
      headers: {
        Origin: 'https://politician-finder.com',
        'Access-Control-Request-Method': 'POST'
      }
    })

    expect(response.status).toBe(204)
    expect(response.headers.get('Access-Control-Allow-Methods')).toContain('POST')
  })
})
```

---

## ğŸ“ CORS ì •ì±… ì„¤ëª…

### í—ˆìš© ì •ì±…
- **Origin**: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ëœ ë„ë©”ì¸ë§Œ í—ˆìš©
- **Methods**: GET, POST, PUT, DELETE, OPTIONS
- **Headers**: Content-Type, Authorization
- **Credentials**: ì¿ í‚¤ ë° ì¸ì¦ ì •ë³´ í—ˆìš©

### ì°¨ë‹¨ ì •ì±…
- í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” ë„ë©”ì¸
- í—ˆìš©ë˜ì§€ ì•Šì€ HTTP ë©”ì„œë“œ
- ë¹„ì •ìƒì ì¸ í—¤ë”

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### CORS ìš°íšŒ ê³µê²© ë°©ì–´
- Origin í—¤ë” ê²€ì¦ ê°•í™”
- Wildcard (*) ì‚¬ìš© ê¸ˆì§€
- Null origin ì°¨ë‹¨

### ì¶”ê°€ ë³´ì•ˆ í—¤ë”
```typescript
// ì¶”ê°€ ë³´ì•ˆ í—¤ë”
response.headers.set('X-Content-Type-Options', 'nosniff')
response.headers.set('X-Frame-Options', 'DENY')
response.headers.set('X-XSS-Protection', '1; mode=block')
response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
```

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

**ì‘ì—… ì™„ë£Œ ì¼ì‹œ**: ëŒ€ê¸°ì¤‘
**í…ŒìŠ¤íŠ¸/ê²€í†  ê²°ê³¼**: ëŒ€ê¸°
**ìë™í™” ë°©ì‹**: AI-only
**ë¸”ë¡œì»¤**: ì—†ìŒ
**ë¹„ê³ **:
- CORSëŠ” ë¸Œë¼ìš°ì € ë³´ì•ˆ ê¸°ëŠ¥
- ì„œë²„ ê°„ í†µì‹ ì—ëŠ” ì ìš©ë˜ì§€ ì•ŠìŒ
- Preflight ìš”ì²­ì€ OPTIONS ë©”ì„œë“œ ì‚¬ìš©

---

**ì‘ì„± ë°©ë²•ë¡ **: 13DGC-AODM v1.1
**AI-Only ì›ì¹™ ì¤€ìˆ˜**: âœ…
