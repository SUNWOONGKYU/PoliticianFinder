# P2V3 - DB ë°±ì—…

**Phase**: Phase 2 - ì •ì¹˜ì¸ ëª©ë¡/ìƒì„¸
**ì˜ì—­**: DevOps
**ë‹´ë‹¹ AI**: devops-troubleshooter
**ìƒíƒœ**: ëŒ€ê¸°
**ì§„ë„**: 0%

---

## ğŸ“‹ ì‘ì—… ê°œìš”

Supabase ë°ì´í„°ë² ì´ìŠ¤ì˜ ìë™ ë°±ì—… ì‹œìŠ¤í…œì„ êµ¬ì¶•í•©ë‹ˆë‹¤. ì •ê¸°ì ì¸ ë°±ì—…, ë°±ì—… ë³µì› í…ŒìŠ¤íŠ¸, ë°±ì—… íŒŒì¼ ê´€ë¦¬ë¥¼ ìë™í™”í•©ë‹ˆë‹¤.

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

- [ ] ìë™ ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- [ ] GitHub Actions ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •
- [ ] ë°±ì—… íŒŒì¼ ì €ì¥ì†Œ ì„¤ì • (S3 ë˜ëŠ” GitHub)
- [ ] ë°±ì—… ë³µì› ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- [ ] ë°±ì—… ì•Œë¦¼ ì„¤ì •
- [ ] ë°±ì—… ì£¼ê¸° ì„¤ì • (ì¼ê°„/ì£¼ê°„)

---

## ğŸ“ ê¸°ìˆ  ì‚¬ì–‘

### Backup
- Database: Supabase (PostgreSQL)
- Storage: AWS S3 ë˜ëŠ” GitHub Artifacts
- Scheduler: GitHub Actions (Cron)

---

## ğŸ”— ì˜ì¡´ ì‘ì—…

**ì„ í–‰ ì‘ì—…**: P2V1 (Vercel ë°°í¬)
**í›„ì† ì‘ì—…**: P3V3 (Uptime ëª¨ë‹ˆí„°ë§ - Phase 3)

---

## âœ… ì™„ë£Œ ê¸°ì¤€

1. ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ì™„ë£Œ
2. ìë™ ë°±ì—… ìŠ¤ì¼€ì¤„ ì„¤ì • ì™„ë£Œ
3. ë°±ì—… íŒŒì¼ ì €ì¥ í™•ì¸
4. ë³µì› í…ŒìŠ¤íŠ¸ ì„±ê³µ
5. ì•Œë¦¼ ì„¤ì • ì™„ë£Œ

---

## ğŸ’» êµ¬í˜„ ìƒì„¸

### 1. ë°±ì—… ìŠ¤í¬ë¦½íŠ¸

```bash
# scripts/backup-db.sh
#!/bin/bash

set -e

# í™˜ê²½ë³€ìˆ˜
SUPABASE_PROJECT_ID="${SUPABASE_PROJECT_ID}"
SUPABASE_DB_PASSWORD="${SUPABASE_DB_PASSWORD}"
BACKUP_DIR="./backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="backup_${TIMESTAMP}.sql"

# ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p $BACKUP_DIR

# PostgreSQL ë¤í”„
PGPASSWORD=$SUPABASE_DB_PASSWORD pg_dump \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d postgres \
  -F c \
  -b \
  -v \
  -f "${BACKUP_DIR}/${BACKUP_FILE}"

echo "âœ… Backup created: ${BACKUP_FILE}"

# 30ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ
find $BACKUP_DIR -name "backup_*.sql" -mtime +30 -delete

echo "âœ… Old backups cleaned up"
```

### 2. GitHub Actions ìë™ ë°±ì—…

```yaml
# .github/workflows/backup.yml
name: Database Backup

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 3ì‹œ (KST ê¸°ì¤€)
    - cron: '0 18 * * *'  # UTC 18:00 = KST 03:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  backup:
    name: Backup Supabase Database
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create Backup
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          chmod +x scripts/backup-db.sh
          ./scripts/backup-db.sh

      - name: Upload Backup to Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: db-backup-${{ github.run_number }}
          path: backups/*.sql
          retention-days: 30

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.name,
              title: 'âŒ Database Backup Failed',
              body: `ë°±ì—… ì‹¤íŒ¨: ${context.runId}\n\n[ì›Œí¬í”Œë¡œìš° ë¡œê·¸](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            })
```

### 3. S3 ë°±ì—… (ì„ íƒì‚¬í•­)

```yaml
# .github/workflows/backup-s3.yml
name: Database Backup to S3

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  backup:
    name: Backup to S3
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: sudo apt-get install -y postgresql-client

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Create Backup
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: ./scripts/backup-db.sh

      - name: Upload to S3
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          aws s3 cp backups/backup_*.sql \
            s3://politician-finder-backups/db/backup_${TIMESTAMP}.sql \
            --storage-class STANDARD_IA

      - name: Notify Success
        run: echo "âœ… Backup uploaded to S3"
```

### 4. ë³µì› ìŠ¤í¬ë¦½íŠ¸

```bash
# scripts/restore-db.sh
#!/bin/bash

set -e

BACKUP_FILE="$1"

if [ -z "$BACKUP_FILE" ]; then
  echo "Usage: ./restore-db.sh <backup_file>"
  exit 1
fi

# í™˜ê²½ë³€ìˆ˜ í™•ì¸
if [ -z "$SUPABASE_PROJECT_ID" ] || [ -z "$SUPABASE_DB_PASSWORD" ]; then
  echo "Error: SUPABASE_PROJECT_ID and SUPABASE_DB_PASSWORD must be set"
  exit 1
fi

echo "âš ï¸  WARNING: This will restore the database from backup."
echo "   Backup file: $BACKUP_FILE"
read -p "Continue? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  exit 1
fi

# ë³µì› ì‹¤í–‰
PGPASSWORD=$SUPABASE_DB_PASSWORD pg_restore \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d postgres \
  -v \
  -c \
  "$BACKUP_FILE"

echo "âœ… Database restored successfully"
```

### 5. ë°±ì—… ë³µì› í…ŒìŠ¤íŠ¸ (ìŠ¤í…Œì´ì§•)

```bash
# scripts/test-restore.sh
#!/bin/bash

set -e

BACKUP_FILE="$1"
TEST_DB="test_restore_db"

echo "ğŸ“¦ Creating test database..."
PGPASSWORD=$SUPABASE_DB_PASSWORD psql \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d postgres \
  -c "CREATE DATABASE $TEST_DB;"

echo "ğŸ“‚ Restoring backup to test database..."
PGPASSWORD=$SUPABASE_DB_PASSWORD pg_restore \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d $TEST_DB \
  -v \
  "$BACKUP_FILE"

echo "âœ… Restore test successful"

echo "ğŸ§¹ Cleaning up..."
PGPASSWORD=$SUPABASE_DB_PASSWORD psql \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d postgres \
  -c "DROP DATABASE $TEST_DB;"

echo "âœ… Test completed successfully"
```

### 6. ì£¼ê°„ ë°±ì—… ë° ì›”ê°„ ì•„ì¹´ì´ë¸Œ

```yaml
# .github/workflows/weekly-backup.yml
name: Weekly Full Backup

on:
  schedule:
    # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 2ì‹œ
    - cron: '0 17 * * 0'

jobs:
  full-backup:
    name: Full Database Backup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: sudo apt-get install -y postgresql-client

      - name: Create Full Backup
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: ./scripts/backup-db.sh

      - name: Archive Monthly Backup
        if: github.event.schedule == '0 17 1 * *'
        uses: actions/upload-artifact@v3
        with:
          name: monthly-backup-${{ github.run_number }}
          path: backups/*.sql
          retention-days: 365

      - name: Upload Weekly Backup
        uses: actions/upload-artifact@v3
        with:
          name: weekly-backup-${{ github.run_number }}
          path: backups/*.sql
          retention-days: 90
```

---

## ğŸ“ ë°±ì—… ê´€ë¦¬

### ë°±ì—… ì£¼ê¸°
- **ì¼ê°„ ë°±ì—…**: 30ì¼ ë³´ê´€
- **ì£¼ê°„ ë°±ì—…**: 90ì¼ ë³´ê´€
- **ì›”ê°„ ë°±ì—…**: 365ì¼ ë³´ê´€

### ë°±ì—… í™•ì¸
```bash
# GitHub Actions Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œ
gh run download <run-id>

# S3ì—ì„œ ë‹¤ìš´ë¡œë“œ (ì„ íƒì‚¬í•­)
aws s3 ls s3://politician-finder-backups/db/
aws s3 cp s3://politician-finder-backups/db/backup_20250116.sql ./
```

### ë³µì› ì‹¤í–‰
```bash
# ë¡œì»¬ì—ì„œ ë³µì› í…ŒìŠ¤íŠ¸
export SUPABASE_PROJECT_ID="your-project-id"
export SUPABASE_DB_PASSWORD="your-password"
./scripts/test-restore.sh backup_20250116.sql

# í”„ë¡œë•ì…˜ ë³µì› (ì£¼ì˜!)
./scripts/restore-db.sh backup_20250116.sql
```

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

- DB ë¹„ë°€ë²ˆí˜¸ëŠ” GitHub Secretsë¡œ ê´€ë¦¬
- ë°±ì—… íŒŒì¼ì€ ì•”í˜¸í™” ì €ì¥ ê¶Œì¥
- ë³µì› ìŠ¤í¬ë¦½íŠ¸ëŠ” í”„ë¡œë•ì…˜ì—ì„œ ì‹ ì¤‘íˆ ì‚¬ìš©
- ë°±ì—… íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ ìµœì†Œí™”

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

**ì‘ì—… ì™„ë£Œ ì¼ì‹œ**: ëŒ€ê¸°ì¤‘
**í…ŒìŠ¤íŠ¸/ê²€í†  ê²°ê³¼**: ëŒ€ê¸°
**ìë™í™” ë°©ì‹**: AI-only
**ë¸”ë¡œì»¤**: ì—†ìŒ
**ë¹„ê³ **:
- SupabaseëŠ” ìë™ ë°±ì—… ì œê³µ (7ì¼)
- ì¶”ê°€ ë°±ì—…ì€ ì¥ê¸° ë³´ê´€ ë° ì¬í•´ ë³µêµ¬ìš©
- pg_dumpëŠ” PostgreSQL í‘œì¤€ ë„êµ¬

---

**ì‘ì„± ë°©ë²•ë¡ **: 13DGC-AODM v1.1
**AI-Only ì›ì¹™ ì¤€ìˆ˜**: âœ…
