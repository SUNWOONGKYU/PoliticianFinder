# P2V3 - DB 백업

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: DevOps
**담당 AI**: devops-troubleshooter
**상태**: 대기
**진도**: 0%

---

## 📋 작업 개요

Supabase 데이터베이스의 자동 백업 시스템을 구축합니다. 정기적인 백업, 백업 복원 테스트, 백업 파일 관리를 자동화합니다.

---

## 🎯 작업 목표

- [ ] 자동 백업 스크립트 작성
- [ ] GitHub Actions 스케줄러 설정
- [ ] 백업 파일 저장소 설정 (S3 또는 GitHub)
- [ ] 백업 복원 스크립트 작성
- [ ] 백업 알림 설정
- [ ] 백업 주기 설정 (일간/주간)

---

## 📐 기술 사양

### Backup
- Database: Supabase (PostgreSQL)
- Storage: AWS S3 또는 GitHub Artifacts
- Scheduler: GitHub Actions (Cron)

---

## 🔗 의존 작업

**선행 작업**: P2V1 (Vercel 배포)
**후속 작업**: P3V3 (Uptime 모니터링 - Phase 3)

---

## ✅ 완료 기준

1. 백업 스크립트 작성 완료
2. 자동 백업 스케줄 설정 완료
3. 백업 파일 저장 확인
4. 복원 테스트 성공
5. 알림 설정 완료

---

## 💻 구현 상세

### 1. 백업 스크립트

```bash
# scripts/backup-db.sh
#!/bin/bash

set -e

# 환경변수
SUPABASE_PROJECT_ID="${SUPABASE_PROJECT_ID}"
SUPABASE_DB_PASSWORD="${SUPABASE_DB_PASSWORD}"
BACKUP_DIR="./backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="backup_${TIMESTAMP}.sql"

# 백업 디렉토리 생성
mkdir -p $BACKUP_DIR

# PostgreSQL 덤프
PGPASSWORD=$SUPABASE_DB_PASSWORD pg_dump \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d postgres \
  -F c \
  -b \
  -v \
  -f "${BACKUP_DIR}/${BACKUP_FILE}"

echo "✅ Backup created: ${BACKUP_FILE}"

# 30일 이상 된 백업 삭제
find $BACKUP_DIR -name "backup_*.sql" -mtime +30 -delete

echo "✅ Old backups cleaned up"
```

### 2. GitHub Actions 자동 백업

```yaml
# .github/workflows/backup.yml
name: Database Backup

on:
  schedule:
    # 매일 오전 3시 (KST 기준)
    - cron: '0 18 * * *'  # UTC 18:00 = KST 03:00
  workflow_dispatch:  # 수동 실행 가능

jobs:
  backup:
    name: Backup Supabase Database
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create Backup
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          chmod +x scripts/backup-db.sh
          ./scripts/backup-db.sh

      - name: Upload Backup to Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: db-backup-${{ github.run_number }}
          path: backups/*.sql
          retention-days: 30

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.name,
              title: '❌ Database Backup Failed',
              body: `백업 실패: ${context.runId}\n\n[워크플로우 로그](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            })
```

### 3. S3 백업 (선택사항)

```yaml
# .github/workflows/backup-s3.yml
name: Database Backup to S3

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

jobs:
  backup:
    name: Backup to S3
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: sudo apt-get install -y postgresql-client

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Create Backup
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: ./scripts/backup-db.sh

      - name: Upload to S3
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          aws s3 cp backups/backup_*.sql \
            s3://politician-finder-backups/db/backup_${TIMESTAMP}.sql \
            --storage-class STANDARD_IA

      - name: Notify Success
        run: echo "✅ Backup uploaded to S3"
```

### 4. 복원 스크립트

```bash
# scripts/restore-db.sh
#!/bin/bash

set -e

BACKUP_FILE="$1"

if [ -z "$BACKUP_FILE" ]; then
  echo "Usage: ./restore-db.sh <backup_file>"
  exit 1
fi

# 환경변수 확인
if [ -z "$SUPABASE_PROJECT_ID" ] || [ -z "$SUPABASE_DB_PASSWORD" ]; then
  echo "Error: SUPABASE_PROJECT_ID and SUPABASE_DB_PASSWORD must be set"
  exit 1
fi

echo "⚠️  WARNING: This will restore the database from backup."
echo "   Backup file: $BACKUP_FILE"
read -p "Continue? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  exit 1
fi

# 복원 실행
PGPASSWORD=$SUPABASE_DB_PASSWORD pg_restore \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d postgres \
  -v \
  -c \
  "$BACKUP_FILE"

echo "✅ Database restored successfully"
```

### 5. 백업 복원 테스트 (스테이징)

```bash
# scripts/test-restore.sh
#!/bin/bash

set -e

BACKUP_FILE="$1"
TEST_DB="test_restore_db"

echo "📦 Creating test database..."
PGPASSWORD=$SUPABASE_DB_PASSWORD psql \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d postgres \
  -c "CREATE DATABASE $TEST_DB;"

echo "📂 Restoring backup to test database..."
PGPASSWORD=$SUPABASE_DB_PASSWORD pg_restore \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d $TEST_DB \
  -v \
  "$BACKUP_FILE"

echo "✅ Restore test successful"

echo "🧹 Cleaning up..."
PGPASSWORD=$SUPABASE_DB_PASSWORD psql \
  -h db.${SUPABASE_PROJECT_ID}.supabase.co \
  -U postgres \
  -d postgres \
  -c "DROP DATABASE $TEST_DB;"

echo "✅ Test completed successfully"
```

### 6. 주간 백업 및 월간 아카이브

```yaml
# .github/workflows/weekly-backup.yml
name: Weekly Full Backup

on:
  schedule:
    # 매주 일요일 오전 2시
    - cron: '0 17 * * 0'

jobs:
  full-backup:
    name: Full Database Backup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: sudo apt-get install -y postgresql-client

      - name: Create Full Backup
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: ./scripts/backup-db.sh

      - name: Archive Monthly Backup
        if: github.event.schedule == '0 17 1 * *'
        uses: actions/upload-artifact@v3
        with:
          name: monthly-backup-${{ github.run_number }}
          path: backups/*.sql
          retention-days: 365

      - name: Upload Weekly Backup
        uses: actions/upload-artifact@v3
        with:
          name: weekly-backup-${{ github.run_number }}
          path: backups/*.sql
          retention-days: 90
```

---

## 📝 백업 관리

### 백업 주기
- **일간 백업**: 30일 보관
- **주간 백업**: 90일 보관
- **월간 백업**: 365일 보관

### 백업 확인
```bash
# GitHub Actions Artifacts에서 다운로드
gh run download <run-id>

# S3에서 다운로드 (선택사항)
aws s3 ls s3://politician-finder-backups/db/
aws s3 cp s3://politician-finder-backups/db/backup_20250116.sql ./
```

### 복원 실행
```bash
# 로컬에서 복원 테스트
export SUPABASE_PROJECT_ID="your-project-id"
export SUPABASE_DB_PASSWORD="your-password"
./scripts/test-restore.sh backup_20250116.sql

# 프로덕션 복원 (주의!)
./scripts/restore-db.sh backup_20250116.sql
```

---

## 🔒 보안 고려사항

- DB 비밀번호는 GitHub Secrets로 관리
- 백업 파일은 암호화 저장 권장
- 복원 스크립트는 프로덕션에서 신중히 사용
- 백업 파일 접근 권한 최소화

---

## 📌 참고사항

**작업 완료 일시**: 대기중
**테스트/검토 결과**: 대기
**자동화 방식**: AI-only
**블로커**: 없음
**비고**:
- Supabase는 자동 백업 제공 (7일)
- 추가 백업은 장기 보관 및 재해 복구용
- pg_dump는 PostgreSQL 표준 도구

---

**작성 방법론**: 13DGC-AODM v1.1
**AI-Only 원칙 준수**: ✅
