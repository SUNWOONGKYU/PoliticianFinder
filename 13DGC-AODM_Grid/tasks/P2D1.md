# P2D1 - 정치인 테이블 확장

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: Database (Supabase)
**담당 AI**: fullstack-developer
**상태**: 대기
**진도**: 0%

---

## 📋 작업 개요

Phase 1에서 생성한 `politicians` 테이블에 평가 통계 필드를 추가하여 확장합니다. 평균 평점, 평가 개수 등의 집계 데이터를 저장할 수 있도록 합니다.

---

## 🎯 작업 목표

- [ ] avg_rating 컬럼 추가
- [ ] total_ratings 컬럼 추가
- [ ] 인덱스 추가 (성능 최적화)
- [ ] 기본값 설정
- [ ] 마이그레이션 스크립트 작성
- [ ] 롤백 스크립트 작성

---

## 📐 기술 사양

### Database
- Platform: Supabase (PostgreSQL 15+)
- ORM: Supabase Client
- Migration Tool: Supabase CLI

---

## 🔗 의존 작업

**선행 작업**: P1D1 (profiles 테이블 생성)
**후속 작업**: P2D2 (ratings 테이블), P2B2 (시민 평가 API)

---

## ✅ 완료 기준

1. avg_rating 컬럼 추가 완료
2. total_ratings 컬럼 추가 완료
3. 인덱스 추가 완료
4. 마이그레이션 스크립트 작성 완료
5. 롤백 가능 확인
6. 기존 데이터 무결성 유지

---

## 💻 구현 상세

### 1. 마이그레이션 파일 생성

```bash
# Supabase CLI를 사용한 마이그레이션 생성
supabase migration new add_rating_fields_to_politicians
```

### 2. 마이그레이션 SQL

```sql
-- supabase/migrations/[timestamp]_add_rating_fields_to_politicians.sql

-- 평균 평점 컬럼 추가 (1-5 범위, 소수점 1자리)
ALTER TABLE politicians
ADD COLUMN IF NOT EXISTS avg_rating DECIMAL(2,1) DEFAULT 0.0;

-- 평가 개수 컬럼 추가
ALTER TABLE politicians
ADD COLUMN IF NOT EXISTS total_ratings INTEGER DEFAULT 0;

-- 평균 평점 제약조건 추가 (1-5 범위)
ALTER TABLE politicians
ADD CONSTRAINT check_avg_rating_range
CHECK (avg_rating >= 0.0 AND avg_rating <= 5.0);

-- 평가 개수 제약조건 추가 (음수 불가)
ALTER TABLE politicians
ADD CONSTRAINT check_total_ratings_positive
CHECK (total_ratings >= 0);

-- 평균 평점 인덱스 추가 (정렬 쿼리 최적화)
CREATE INDEX IF NOT EXISTS idx_politicians_avg_rating
ON politicians(avg_rating DESC);

-- 복합 인덱스 추가 (정당 + 평점 필터링 최적화)
CREATE INDEX IF NOT EXISTS idx_politicians_party_rating
ON politicians(party, avg_rating DESC);

-- 복합 인덱스 추가 (지역 + 평점 필터링 최적화)
CREATE INDEX IF NOT EXISTS idx_politicians_region_rating
ON politicians(region, avg_rating DESC);

-- 기존 데이터 업데이트 (이미 있는 평가가 있다면)
-- 이 부분은 P2B3 (평가 집계 로직)에서 처리됨
```

### 3. 롤백 SQL

```sql
-- supabase/migrations/[timestamp]_rollback_add_rating_fields.sql

-- 인덱스 제거
DROP INDEX IF EXISTS idx_politicians_region_rating;
DROP INDEX IF EXISTS idx_politicians_party_rating;
DROP INDEX IF EXISTS idx_politicians_avg_rating;

-- 제약조건 제거
ALTER TABLE politicians
DROP CONSTRAINT IF EXISTS check_total_ratings_positive;

ALTER TABLE politicians
DROP CONSTRAINT IF EXISTS check_avg_rating_range;

-- 컬럼 제거
ALTER TABLE politicians
DROP COLUMN IF EXISTS total_ratings;

ALTER TABLE politicians
DROP COLUMN IF EXISTS avg_rating;
```

### 4. TypeScript 타입 업데이트

```typescript
// types/database.ts

export interface Politician {
  id: number
  name: string
  party: string
  region: string
  position: string
  profile_image_url: string
  biography: string
  official_website: string

  // Phase 2에서 추가된 필드
  avg_rating: number           // 평균 평점 (0.0 - 5.0)
  total_ratings: number         // 평가 개수

  created_at: string
  updated_at: string
}

// Supabase 자동 생성 타입과 동기화
export type PoliticiansRow = Database['public']['Tables']['politicians']['Row']
export type PoliticiansInsert = Database['public']['Tables']['politicians']['Insert']
export type PoliticiansUpdate = Database['public']['Tables']['politicians']['Update']
```

### 5. 마이그레이션 실행

```bash
# 로컬 환경에서 마이그레이션 실행
supabase db reset

# 또는 새 마이그레이션만 적용
supabase migration up

# 마이그레이션 상태 확인
supabase migration list
```

---

## 📝 테스트 계획

### 단위 테스트
- [ ] 컬럼 추가 확인
- [ ] 기본값 확인
- [ ] 제약조건 동작 확인 (범위 초과 시 에러)
- [ ] 인덱스 생성 확인

### 통합 테스트
- [ ] 기존 politicians 데이터 무결성 확인
- [ ] INSERT/UPDATE 쿼리 정상 동작 확인
- [ ] 인덱스를 사용한 쿼리 성능 확인

### 검증 쿼리

```sql
-- 컬럼 추가 확인
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'politicians'
AND column_name IN ('avg_rating', 'total_ratings');

-- 제약조건 확인
SELECT constraint_name, check_clause
FROM information_schema.check_constraints
WHERE constraint_name LIKE '%politicians%rating%';

-- 인덱스 확인
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'politicians'
AND indexname LIKE '%rating%';

-- 샘플 데이터 조회
SELECT id, name, avg_rating, total_ratings
FROM politicians
LIMIT 5;
```

---

## 🔒 보안 고려사항

- RLS 정책은 기존 설정 유지
- avg_rating, total_ratings는 시스템에서만 업데이트 (사용자 직접 수정 불가)
- API를 통해서만 업데이트되도록 제어 (P2B2, P2B3)

---

## 📌 참고사항

**작업 완료 일시**: 대기중
**테스트/검토 결과**: 대기
**자동화 방식**: AI-only
**블로커**: 없음
**비고**:
- avg_rating은 소수점 1자리까지 저장 (예: 4.3)
- total_ratings는 정수형
- 인덱스는 정렬 쿼리 성능 최적화를 위해 필수

---

**작성 방법론**: 13DGC-AODM v1.1
**AI-Only 원칙 준수**: ✅
