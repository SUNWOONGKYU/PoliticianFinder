# P2D1 - ì •ì¹˜ì¸ í…Œì´ë¸” í™•ì¥

**Phase**: Phase 2 - ì •ì¹˜ì¸ ëª©ë¡/ìƒì„¸
**ì˜ì—­**: Database (Supabase)
**ë‹´ë‹¹ AI**: fullstack-developer
**ìƒíƒœ**: ëŒ€ê¸°
**ì§„ë„**: 0%

---

## ğŸ“‹ ì‘ì—… ê°œìš”

Phase 1ì—ì„œ ìƒì„±í•œ `politicians` í…Œì´ë¸”ì— í‰ê°€ í†µê³„ í•„ë“œë¥¼ ì¶”ê°€í•˜ì—¬ í™•ì¥í•©ë‹ˆë‹¤. í‰ê·  í‰ì , í‰ê°€ ê°œìˆ˜ ë“±ì˜ ì§‘ê³„ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

- [ ] avg_rating ì»¬ëŸ¼ ì¶”ê°€
- [ ] total_ratings ì»¬ëŸ¼ ì¶”ê°€
- [ ] ì¸ë±ìŠ¤ ì¶”ê°€ (ì„±ëŠ¥ ìµœì í™”)
- [ ] ê¸°ë³¸ê°’ ì„¤ì •
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±
- [ ] ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

---

## ğŸ“ ê¸°ìˆ  ì‚¬ì–‘

### Database
- Platform: Supabase (PostgreSQL 15+)
- ORM: Supabase Client
- Migration Tool: Supabase CLI

---

## ğŸ”— ì˜ì¡´ ì‘ì—…

**ì„ í–‰ ì‘ì—…**: P1D1 (profiles í…Œì´ë¸” ìƒì„±)
**í›„ì† ì‘ì—…**: P2D2 (ratings í…Œì´ë¸”), P2B2 (ì‹œë¯¼ í‰ê°€ API)

---

## âœ… ì™„ë£Œ ê¸°ì¤€

1. avg_rating ì»¬ëŸ¼ ì¶”ê°€ ì™„ë£Œ
2. total_ratings ì»¬ëŸ¼ ì¶”ê°€ ì™„ë£Œ
3. ì¸ë±ìŠ¤ ì¶”ê°€ ì™„ë£Œ
4. ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ì™„ë£Œ
5. ë¡¤ë°± ê°€ëŠ¥ í™•ì¸
6. ê¸°ì¡´ ë°ì´í„° ë¬´ê²°ì„± ìœ ì§€

---

## ğŸ’» êµ¬í˜„ ìƒì„¸

### 1. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±

```bash
# Supabase CLIë¥¼ ì‚¬ìš©í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
supabase migration new add_rating_fields_to_politicians
```

### 2. ë§ˆì´ê·¸ë ˆì´ì…˜ SQL

```sql
-- supabase/migrations/[timestamp]_add_rating_fields_to_politicians.sql

-- í‰ê·  í‰ì  ì»¬ëŸ¼ ì¶”ê°€ (1-5 ë²”ìœ„, ì†Œìˆ˜ì  1ìë¦¬)
ALTER TABLE politicians
ADD COLUMN IF NOT EXISTS avg_rating DECIMAL(2,1) DEFAULT 0.0;

-- í‰ê°€ ê°œìˆ˜ ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE politicians
ADD COLUMN IF NOT EXISTS total_ratings INTEGER DEFAULT 0;

-- í‰ê·  í‰ì  ì œì•½ì¡°ê±´ ì¶”ê°€ (1-5 ë²”ìœ„)
ALTER TABLE politicians
ADD CONSTRAINT check_avg_rating_range
CHECK (avg_rating >= 0.0 AND avg_rating <= 5.0);

-- í‰ê°€ ê°œìˆ˜ ì œì•½ì¡°ê±´ ì¶”ê°€ (ìŒìˆ˜ ë¶ˆê°€)
ALTER TABLE politicians
ADD CONSTRAINT check_total_ratings_positive
CHECK (total_ratings >= 0);

-- í‰ê·  í‰ì  ì¸ë±ìŠ¤ ì¶”ê°€ (ì •ë ¬ ì¿¼ë¦¬ ìµœì í™”)
CREATE INDEX IF NOT EXISTS idx_politicians_avg_rating
ON politicians(avg_rating DESC);

-- ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€ (ì •ë‹¹ + í‰ì  í•„í„°ë§ ìµœì í™”)
CREATE INDEX IF NOT EXISTS idx_politicians_party_rating
ON politicians(party, avg_rating DESC);

-- ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€ (ì§€ì—­ + í‰ì  í•„í„°ë§ ìµœì í™”)
CREATE INDEX IF NOT EXISTS idx_politicians_region_rating
ON politicians(region, avg_rating DESC);

-- ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ì´ë¯¸ ìˆëŠ” í‰ê°€ê°€ ìˆë‹¤ë©´)
-- ì´ ë¶€ë¶„ì€ P2B3 (í‰ê°€ ì§‘ê³„ ë¡œì§)ì—ì„œ ì²˜ë¦¬ë¨
```

### 3. ë¡¤ë°± SQL

```sql
-- supabase/migrations/[timestamp]_rollback_add_rating_fields.sql

-- ì¸ë±ìŠ¤ ì œê±°
DROP INDEX IF EXISTS idx_politicians_region_rating;
DROP INDEX IF EXISTS idx_politicians_party_rating;
DROP INDEX IF EXISTS idx_politicians_avg_rating;

-- ì œì•½ì¡°ê±´ ì œê±°
ALTER TABLE politicians
DROP CONSTRAINT IF EXISTS check_total_ratings_positive;

ALTER TABLE politicians
DROP CONSTRAINT IF EXISTS check_avg_rating_range;

-- ì»¬ëŸ¼ ì œê±°
ALTER TABLE politicians
DROP COLUMN IF EXISTS total_ratings;

ALTER TABLE politicians
DROP COLUMN IF EXISTS avg_rating;
```

### 4. TypeScript íƒ€ì… ì—…ë°ì´íŠ¸

```typescript
// types/database.ts

export interface Politician {
  id: number
  name: string
  party: string
  region: string
  position: string
  profile_image_url: string
  biography: string
  official_website: string

  // Phase 2ì—ì„œ ì¶”ê°€ëœ í•„ë“œ
  avg_rating: number           // í‰ê·  í‰ì  (0.0 - 5.0)
  total_ratings: number         // í‰ê°€ ê°œìˆ˜

  created_at: string
  updated_at: string
}

// Supabase ìë™ ìƒì„± íƒ€ì…ê³¼ ë™ê¸°í™”
export type PoliticiansRow = Database['public']['Tables']['politicians']['Row']
export type PoliticiansInsert = Database['public']['Tables']['politicians']['Insert']
export type PoliticiansUpdate = Database['public']['Tables']['politicians']['Update']
```

### 5. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

```bash
# ë¡œì»¬ í™˜ê²½ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
supabase db reset

# ë˜ëŠ” ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ë§Œ ì ìš©
supabase migration up

# ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸
supabase migration list
```

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ê³„íš

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] ì»¬ëŸ¼ ì¶”ê°€ í™•ì¸
- [ ] ê¸°ë³¸ê°’ í™•ì¸
- [ ] ì œì•½ì¡°ê±´ ë™ì‘ í™•ì¸ (ë²”ìœ„ ì´ˆê³¼ ì‹œ ì—ëŸ¬)
- [ ] ì¸ë±ìŠ¤ ìƒì„± í™•ì¸

### í†µí•© í…ŒìŠ¤íŠ¸
- [ ] ê¸°ì¡´ politicians ë°ì´í„° ë¬´ê²°ì„± í™•ì¸
- [ ] INSERT/UPDATE ì¿¼ë¦¬ ì •ìƒ ë™ì‘ í™•ì¸
- [ ] ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•œ ì¿¼ë¦¬ ì„±ëŠ¥ í™•ì¸

### ê²€ì¦ ì¿¼ë¦¬

```sql
-- ì»¬ëŸ¼ ì¶”ê°€ í™•ì¸
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'politicians'
AND column_name IN ('avg_rating', 'total_ratings');

-- ì œì•½ì¡°ê±´ í™•ì¸
SELECT constraint_name, check_clause
FROM information_schema.check_constraints
WHERE constraint_name LIKE '%politicians%rating%';

-- ì¸ë±ìŠ¤ í™•ì¸
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'politicians'
AND indexname LIKE '%rating%';

-- ìƒ˜í”Œ ë°ì´í„° ì¡°íšŒ
SELECT id, name, avg_rating, total_ratings
FROM politicians
LIMIT 5;
```

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

- RLS ì •ì±…ì€ ê¸°ì¡´ ì„¤ì • ìœ ì§€
- avg_rating, total_ratingsëŠ” ì‹œìŠ¤í…œì—ì„œë§Œ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ì ì§ì ‘ ìˆ˜ì • ë¶ˆê°€)
- APIë¥¼ í†µí•´ì„œë§Œ ì—…ë°ì´íŠ¸ë˜ë„ë¡ ì œì–´ (P2B2, P2B3)

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

**ì‘ì—… ì™„ë£Œ ì¼ì‹œ**: ëŒ€ê¸°ì¤‘
**í…ŒìŠ¤íŠ¸/ê²€í†  ê²°ê³¼**: ëŒ€ê¸°
**ìë™í™” ë°©ì‹**: AI-only
**ë¸”ë¡œì»¤**: ì—†ìŒ
**ë¹„ê³ **:
- avg_ratingì€ ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€ ì €ì¥ (ì˜ˆ: 4.3)
- total_ratingsëŠ” ì •ìˆ˜í˜•
- ì¸ë±ìŠ¤ëŠ” ì •ë ¬ ì¿¼ë¦¬ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ í•„ìˆ˜

---

**ì‘ì„± ë°©ë²•ë¡ **: 13DGC-AODM v1.1
**AI-Only ì›ì¹™ ì¤€ìˆ˜**: âœ…
