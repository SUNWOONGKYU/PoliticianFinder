# P2C1 - 소셜 로그인 (다중 플랫폼)

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: Authentication (Supabase Auth)
**담당 AI**: fullstack-developer
**상태**: 대기
**진도**: 0%

---

## 📋 작업 개요

다중 소셜 로그인을 Supabase Auth를 통해 구현합니다. 한국 사용자를 위한 카카오, 네이버와 글로벌 플랫폼인 Google, 페이스북, X(트위터)를 모두 지원하여 사용자가 선호하는 플랫폼으로 간편하게 로그인할 수 있도록 합니다.

**지원 플랫폼**:
1. **Google** - 글로벌 표준
2. **카카오톡** - 한국 #1 메신저 (필수)
3. **네이버** - 한국 #1 포털 (필수)
4. **페이스북** - 글로벌 소셜 네트워크
5. **X (트위터)** - 실시간 소셜 미디어

---

## 🎯 작업 목표

### Google 로그인
- [ ] Google Cloud Console에서 OAuth 클라이언트 설정
- [ ] Supabase에서 Google Provider 활성화
- [ ] Google 로그인 버튼 UI 구현

### 카카오 로그인 (필수)
- [ ] Kakao Developers에서 애플리케이션 등록
- [ ] Supabase에서 Kakao Provider 활성화
- [ ] 카카오 로그인 버튼 UI 구현

### 네이버 로그인 (필수)
- [ ] 네이버 개발자 센터에서 애플리케이션 등록
- [ ] Supabase에서 Naver Provider 활성화 (Custom OAuth)
- [ ] 네이버 로그인 버튼 UI 구현

### 페이스북 로그인
- [ ] Meta for Developers에서 앱 등록
- [ ] Supabase에서 Facebook Provider 활성화
- [ ] 페이스북 로그인 버튼 UI 구현

### X (트위터) 로그인
- [ ] X Developer Portal에서 앱 등록
- [ ] Supabase에서 Twitter Provider 활성화
- [ ] X 로그인 버튼 UI 구현

### 공통 작업
- [ ] OAuth 플로우 구현 (5개 플랫폼)
- [ ] 로그인 성공 후 프로필 자동 생성
- [ ] 통합 에러 핸들링
- [ ] 리디렉션 처리
- [ ] 로그인 UI/UX 최적화

---

## 📐 기술 사양

### Frontend
- Framework: Next.js 14 App Router
- Auth: Supabase Auth (Multi-Provider)
- UI: shadcn/ui Button + Custom Provider Buttons
- Icons: lucide-react + Custom SVG

### Backend
- Platform: Supabase Auth
- OAuth Providers:
  - Google OAuth 2.0
  - Kakao OAuth 2.0
  - Naver OAuth 2.0
  - Facebook OAuth 2.0
  - X (Twitter) OAuth 2.0

### 지원 환경
- Production: Vercel 배포 URL
- Development: localhost:3000
- Preview: Vercel Preview URL

---

## 🔗 의존 작업

**선행 작업**: P1C1 (AuthContext)
**후속 작업**: P3C1 (2FA 인증 - Phase 3)

---

## ✅ 완료 기준

### 필수 (P0)
1. ✅ Google OAuth 클라이언트 생성 및 활성화
2. ✅ 카카오 OAuth 앱 등록 및 활성화 (한국 필수)
3. ✅ 네이버 OAuth 앱 등록 및 활성화 (한국 필수)
4. ✅ 5개 플랫폼 로그인 버튼 UI 구현
5. ✅ OAuth 플로우 동작 확인 (5개 플랫폼)
6. ✅ 프로필 자동 생성 확인
7. ✅ 통합 에러 핸들링 구현

### 선택 (P1)
8. ⭕ 페이스북 OAuth 앱 등록 및 활성화
9. ⭕ X(트위터) OAuth 앱 등록 및 활성화
10. ⭕ 로그인 UI/UX 최적화
11. ⭕ E2E 테스트 작성

---

## 💻 구현 상세

### 1. Google Cloud Console 설정

**Step 1: OAuth 클라이언트 생성**

1. https://console.cloud.google.com 접속
2. 프로젝트 생성 또는 선택
3. "API 및 서비스" > "사용자 인증 정보"
4. "사용자 인증 정보 만들기" > "OAuth 클라이언트 ID"
5. 애플리케이션 유형: "웹 애플리케이션"
6. 승인된 리디렉션 URI 추가:
   - `https://[YOUR_SUPABASE_PROJECT_ID].supabase.co/auth/v1/callback`
   - 로컬 개발: `http://localhost:54321/auth/v1/callback`

**Step 2: 클라이언트 ID 및 비밀번호 저장**

```env
# .env.local
NEXT_PUBLIC_GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
```

### 2. Supabase Google Provider 활성화

**Supabase Dashboard:**

1. Authentication > Providers
2. Google 활성화
3. Client ID 입력
4. Client Secret 입력
5. Authorized redirect URLs 확인
6. 저장

**사이트 URL 설정:**

```
Authentication > URL Configuration
- Site URL: https://politician-finder.com (프로덕션)
- Redirect URLs: https://politician-finder.com/auth/callback
```

### 3. Google 로그인 버튼 UI

```typescript
// components/auth/GoogleLoginButton.tsx
'use client'

import { useState } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { Button } from '@/components/ui/button'
import { Chrome } from 'lucide-react'

export function GoogleLoginButton() {
  const [loading, setLoading] = useState(false)
  const supabase = createClientComponentClient()

  const handleGoogleLogin = async () => {
    try {
      setLoading(true)

      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`,
          queryParams: {
            access_type: 'offline',
            prompt: 'consent'
          }
        }
      })

      if (error) {
        console.error('Google login error:', error)
        throw error
      }
    } catch (error: any) {
      console.error('Login failed:', error)
      alert('Google 로그인에 실패했습니다. 다시 시도해주세요.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Button
      onClick={handleGoogleLogin}
      disabled={loading}
      variant="outline"
      className="w-full"
    >
      <Chrome className="mr-2 h-4 w-4" />
      {loading ? '로그인 중...' : 'Google로 계속하기'}
    </Button>
  )
}
```

### 3-2. 카카오 로그인 설정 및 구현

**Step 1: Kakao Developers 앱 등록**

1. https://developers.kakao.com 접속
2. "내 애플리케이션" > "애플리케이션 추가하기"
3. 앱 이름, 사업자명 입력
4. "앱 키" 확인 (REST API 키, JavaScript 키)
5. "플랫폼" 설정:
   - Web 플랫폼 추가
   - 사이트 도메인: `https://[YOUR_SUPABASE_PROJECT_ID].supabase.co`
6. "카카오 로그인" 활성화
7. Redirect URI 설정:
   - `https://[YOUR_SUPABASE_PROJECT_ID].supabase.co/auth/v1/callback`
8. 동의 항목 설정:
   - 닉네임 (필수)
   - 프로필 사진 (선택)
   - 카카오계정(이메일) (필수)

**Step 2: Supabase Kakao Provider 설정**

Supabase는 기본 Kakao Provider를 지원하므로:

1. Authentication > Providers > Kakao
2. Enable Kakao
3. Client ID: Kakao REST API 키
4. Client Secret: Kakao JavaScript 키 (또는 Admin 키)
5. Callback URL 확인

**Step 3: 카카오 로그인 버튼**

```typescript
// components/auth/KakaoLoginButton.tsx
'use client'

import { useState } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { Button } from '@/components/ui/button'

export function KakaoLoginButton() {
  const [loading, setLoading] = useState(false)
  const supabase = createClientComponentClient()

  const handleKakaoLogin = async () => {
    try {
      setLoading(true)

      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'kakao',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`
        }
      })

      if (error) throw error
    } catch (error: any) {
      console.error('Kakao login error:', error)
      alert('카카오 로그인에 실패했습니다.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Button
      onClick={handleKakaoLogin}
      disabled={loading}
      variant="outline"
      className="w-full bg-[#FEE500] hover:bg-[#FEE500]/90 text-[#000000] border-0"
    >
      <svg className="mr-2 h-5 w-5" viewBox="0 0 18 18">
        <path fill="currentColor" d="M9 0C4.03 0 0 3.37 0 7.5c0 2.74 1.82 5.14 4.58 6.43-.2.73-.68 2.52-.77 2.93-.11.5.18.49.38.36.15-.1 2.47-1.62 3.41-2.24.47.06.95.1 1.44.1 4.97 0 9-3.37 9-7.5S13.97 0 9 0z"/>
      </svg>
      {loading ? '로그인 중...' : '카카오로 계속하기'}
    </Button>
  )
}
```

### 3-3. 네이버 로그인 설정 및 구현

**Step 1: 네이버 개발자 센터 앱 등록**

1. https://developers.naver.com/apps 접속
2. "애플리케이션 등록"
3. 애플리케이션 이름 입력
4. 사용 API 선택: "네이버 로그인"
5. 제공 정보 선택:
   - 이메일 주소 (필수)
   - 닉네임 (필수)
   - 프로필 사진 (선택)
6. 서비스 환경 추가:
   - PC 웹
   - 서비스 URL: `https://politician-finder.vercel.app`
   - Callback URL: `https://[YOUR_SUPABASE_PROJECT_ID].supabase.co/auth/v1/callback`
7. Client ID, Client Secret 확인

**Step 2: Supabase Custom OAuth Provider 설정**

Supabase는 네이버를 기본 지원하지 않으므로 Custom OAuth 설정:

```sql
-- Supabase SQL Editor에서 실행
-- 네이버 OAuth 설정 추가 (선택사항, Auth UI에서 직접 설정 가능)
```

또는 Supabase Dashboard:
1. Authentication > Providers
2. 스크롤하여 "Custom" OAuth provider 찾기
3. Naver 설정 추가

**Step 3: 네이버 로그인 버튼**

```typescript
// components/auth/NaverLoginButton.tsx
'use client'

import { useState } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { Button } from '@/components/ui/button'

export function NaverLoginButton() {
  const [loading, setLoading] = useState(false)
  const supabase = createClientComponentClient()

  const handleNaverLogin = async () => {
    try {
      setLoading(true)

      // Supabase가 Naver를 기본 지원하지 않으므로,
      // Custom OAuth 또는 직접 구현 필요
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'naver' as any,  // Custom provider
        options: {
          redirectTo: `${window.location.origin}/auth/callback`
        }
      })

      if (error) throw error
    } catch (error: any) {
      console.error('Naver login error:', error)
      alert('네이버 로그인에 실패했습니다.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Button
      onClick={handleNaverLogin}
      disabled={loading}
      variant="outline"
      className="w-full bg-[#03C75A] hover:bg-[#03C75A]/90 text-white border-0"
    >
      <span className="mr-2 font-bold text-white">N</span>
      {loading ? '로그인 중...' : '네이버로 계속하기'}
    </Button>
  )
}
```

### 3-4. 페이스북 로그인 설정 및 구현

**Step 1: Meta for Developers 앱 등록**

1. https://developers.facebook.com 접속
2. "내 앱" > "앱 만들기"
3. 앱 유형: "소비자" 선택
4. 앱 이름 입력
5. "Facebook 로그인" 제품 추가
6. 설정 > 기본 설정:
   - 앱 ID 확인
   - 앱 시크릿 코드 확인
7. Facebook 로그인 > 설정:
   - 유효한 OAuth 리디렉션 URI:
     `https://[YOUR_SUPABASE_PROJECT_ID].supabase.co/auth/v1/callback`

**Step 2: Supabase Facebook Provider 설정**

1. Authentication > Providers > Facebook
2. Enable Facebook
3. Facebook Client ID: 앱 ID
4. Facebook Secret: 앱 시크릿 코드

**Step 3: 페이스북 로그인 버튼**

```typescript
// components/auth/FacebookLoginButton.tsx
'use client'

import { useState } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { Button } from '@/components/ui/button'
import { Facebook } from 'lucide-react'

export function FacebookLoginButton() {
  const [loading, setLoading] = useState(false)
  const supabase = createClientComponentClient()

  const handleFacebookLogin = async () => {
    try {
      setLoading(true)

      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'facebook',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`
        }
      })

      if (error) throw error
    } catch (error: any) {
      console.error('Facebook login error:', error)
      alert('페이스북 로그인에 실패했습니다.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Button
      onClick={handleFacebookLogin}
      disabled={loading}
      variant="outline"
      className="w-full bg-[#1877F2] hover:bg-[#1877F2]/90 text-white border-0"
    >
      <Facebook className="mr-2 h-4 w-4" />
      {loading ? '로그인 중...' : 'Facebook으로 계속하기'}
    </Button>
  )
}
```

### 3-5. X (트위터) 로그인 설정 및 구현

**Step 1: X Developer Portal 앱 등록**

1. https://developer.x.com/en/portal/dashboard 접속
2. "Create Project" > "Create App"
3. App name 입력
4. App permissions: "Read" 선택
5. Type of App: "Web App"
6. Callback URLs:
   - `https://[YOUR_SUPABASE_PROJECT_ID].supabase.co/auth/v1/callback`
7. API Key, API Secret Key 확인
8. OAuth 2.0 활성화

**Step 2: Supabase Twitter Provider 설정**

1. Authentication > Providers > Twitter
2. Enable Twitter
3. API Key: Client ID
4. API Secret Key: Client Secret

**Step 3: X 로그인 버튼**

```typescript
// components/auth/XLoginButton.tsx
'use client'

import { useState } from 'react'
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs'
import { Button } from '@/components/ui/button'

export function XLoginButton() {
  const [loading, setLoading] = useState(false)
  const supabase = createClientComponentClient()

  const handleXLogin = async () => {
    try {
      setLoading(true)

      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'twitter',
        options: {
          redirectTo: `${window.location.origin}/auth/callback`
        }
      })

      if (error) throw error
    } catch (error: any) {
      console.error('X login error:', error)
      alert('X 로그인에 실패했습니다.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Button
      onClick={handleXLogin}
      disabled={loading}
      variant="outline"
      className="w-full bg-[#000000] hover:bg-[#000000]/90 text-white border-0"
    >
      <svg className="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
      </svg>
      {loading ? '로그인 중...' : 'X로 계속하기'}
    </Button>
  )
}
```

### 4. 통합 로그인 페이지

```typescript
// app/login/page.tsx
import { GoogleLoginButton } from '@/components/auth/GoogleLoginButton'
import { KakaoLoginButton } from '@/components/auth/KakaoLoginButton'
import { NaverLoginButton } from '@/components/auth/NaverLoginButton'
import { FacebookLoginButton } from '@/components/auth/FacebookLoginButton'
import { XLoginButton } from '@/components/auth/XLoginButton'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Separator } from '@/components/ui/separator'

export default function LoginPage() {
  return (
    <div className="flex min-h-screen items-center justify-center p-4">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <CardTitle className="text-2xl">로그인</CardTitle>
          <CardDescription>
            정치인 평가 플랫폼에 오신 것을 환영합니다
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-3">
          {/* 한국 필수 플랫폼 */}
          <div className="space-y-2">
            <p className="text-xs text-muted-foreground text-center mb-2">
              한국 사용자 추천
            </p>
            <KakaoLoginButton />
            <NaverLoginButton />
          </div>

          <Separator className="my-4" />

          {/* 글로벌 플랫폼 */}
          <div className="space-y-2">
            <p className="text-xs text-muted-foreground text-center mb-2">
              기타 로그인 방법
            </p>
            <GoogleLoginButton />
            <FacebookLoginButton />
            <XLoginButton />
          </div>

          <div className="relative my-6">
            <div className="absolute inset-0 flex items-center">
              <span className="w-full border-t" />
            </div>
            <div className="relative flex justify-center text-xs uppercase">
              <span className="bg-background px-2 text-muted-foreground">
                또는
              </span>
            </div>
          </div>

          {/* 이메일 로그인 (P1C2에서 구현됨) */}
          <p className="text-xs text-center text-muted-foreground">
            이메일로 로그인하시려면{' '}
            <a href="/login/email" className="underline">
              여기를 클릭
            </a>
            하세요
          </p>
        </CardContent>
      </Card>
    </div>
  )
}
```

### 5. OAuth 콜백 처리

```typescript
// app/auth/callback/route.ts
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { NextRequest, NextResponse } from 'next/server'

export async function GET(request: NextRequest) {
  try {
    const requestUrl = new URL(request.url)
    const code = requestUrl.searchParams.get('code')

    if (code) {
      const supabase = createRouteHandlerClient({ cookies })

      // OAuth 코드를 세션으로 교환
      await supabase.auth.exchangeCodeForSession(code)

      // 사용자 정보 가져오기
      const { data: { user } } = await supabase.auth.getUser()

      if (user) {
        // 프로필 자동 생성 (없는 경우)
        await createProfileIfNotExists(supabase, user)
      }
    }

    // 홈으로 리디렉션
    return NextResponse.redirect(new URL('/', request.url))
  } catch (error) {
    console.error('OAuth callback error:', error)
    return NextResponse.redirect(new URL('/login?error=auth_failed', request.url))
  }
}

async function createProfileIfNotExists(supabase: any, user: any) {
  // 기존 프로필 확인
  const { data: existingProfile } = await supabase
    .from('profiles')
    .select('id')
    .eq('id', user.id)
    .single()

  if (!existingProfile) {
    // 프로필 생성
    await supabase
      .from('profiles')
      .insert({
        id: user.id,
        email: user.email,
        username: user.user_metadata?.full_name || user.email?.split('@')[0],
        avatar_url: user.user_metadata?.avatar_url || null
      })
  }
}
```

### 6. 에러 핸들링

```typescript
// app/login/page.tsx에 에러 메시지 표시
'use client'

import { useSearchParams } from 'next/navigation'
import { Alert, AlertDescription } from '@/components/ui/alert'

export default function LoginPage() {
  const searchParams = useSearchParams()
  const error = searchParams.get('error')

  return (
    <div className="flex min-h-screen items-center justify-center">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle>로그인</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {error === 'auth_failed' && (
            <Alert variant="destructive">
              <AlertDescription>
                로그인에 실패했습니다. 다시 시도해주세요.
              </AlertDescription>
            </Alert>
          )}

          <GoogleLoginButton />
        </CardContent>
      </Card>
    </div>
  )
}
```

### 7. 로그인 상태 표시

```typescript
// components/auth/UserMenu.tsx
'use client'

import { useAuth } from '@/contexts/AuthContext'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@/components/ui/dropdown-menu'
import { LogOut, User } from 'lucide-react'
import { useRouter } from 'next/navigation'

export function UserMenu() {
  const { user, profile, signOut } = useAuth()
  const router = useRouter()

  if (!user) return null

  const handleSignOut = async () => {
    await signOut()
    router.push('/')
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <button className="flex items-center gap-2">
          <Avatar>
            <AvatarImage src={profile?.avatar_url || undefined} />
            <AvatarFallback>
              {profile?.username?.[0]?.toUpperCase() || 'U'}
            </AvatarFallback>
          </Avatar>
        </button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuLabel>
          {profile?.username || user.email}
        </DropdownMenuLabel>
        <DropdownMenuSeparator />
        <DropdownMenuItem onClick={() => router.push('/profile')}>
          <User className="mr-2 h-4 w-4" />
          프로필
        </DropdownMenuItem>
        <DropdownMenuItem onClick={handleSignOut}>
          <LogOut className="mr-2 h-4 w-4" />
          로그아웃
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

---

## 📝 테스트 계획

### 기능 테스트
- [ ] Google 로그인 버튼 클릭 시 Google OAuth 페이지로 이동
- [ ] Google 계정 선택 및 권한 승인
- [ ] 로그인 성공 후 홈으로 리디렉션
- [ ] 프로필 자동 생성 확인
- [ ] 로그아웃 기능 동작 확인

### 에러 시나리오
- [ ] OAuth 취소 시 로그인 페이지 복귀
- [ ] 네트워크 오류 시 에러 메시지 표시
- [ ] 잘못된 리디렉션 URI 처리

### 보안 테스트
- [ ] PKCE 플로우 사용 확인
- [ ] CSRF 토큰 검증
- [ ] State 파라미터 검증

---

## 🔒 보안 고려사항

### OAuth 2.0 보안

1. **PKCE (Proof Key for Code Exchange)**
   - Supabase Auth가 자동으로 처리
   - Authorization Code Interception 공격 방어

2. **State Parameter**
   - CSRF 공격 방어
   - Supabase가 자동으로 생성 및 검증

3. **Redirect URI 검증**
   - Google Cloud Console에 등록된 URI만 허용
   - 와일드카드 사용 금지

### 클라이언트 시크릿 보호

- Client Secret은 서버 환경변수에만 저장
- 프론트엔드 코드에 노출 금지
- .env 파일은 .gitignore에 추가

### 세션 관리

```typescript
// Supabase는 자동으로 JWT 토큰 관리
// Access Token: 1시간 (자동 갱신)
// Refresh Token: 30일
```

---

## 📌 참고사항

**작업 완료 일시**: 대기중
**테스트/검토 결과**: 대기
**자동화 방식**: AI-only
**블로커**: 없음

**비고**:
- **필수 플랫폼**: 카카오, 네이버 (한국 사용자 80%+ 커버리지)
- **추천 플랫폼**: Google, 페이스북, X (글로벌 사용자 대응)
- 각 플랫폼별 앱 등록 및 심사 소요 시간:
  - Google: 즉시 (심사 불필요)
  - 카카오: 1-2일 (비즈앱 전환 필요 시)
  - 네이버: 1-3일 (검수 필요)
  - 페이스북: 즉시 (개발 모드), 심사 필요 (프로덕션)
  - X: 즉시 (Basic 계정), 승인 필요 (Elevated)
- Supabase Auth는 20+ OAuth Provider 기본 지원
- 프로덕션 배포 전 각 플랫폼별 OAuth 동의 화면 설정 필수
- 한국 서비스 특성상 카카오/네이버는 반드시 구현 권장

---

**작성 방법론**: 13DGC-AODM v1.1
**AI-Only 원칙 준수**: ✅
