# P2S2 - SQL Injection ë°©ì–´

**Phase**: Phase 2 - ì •ì¹˜ì¸ ëª©ë¡/ìƒì„¸
**ì˜ì—­**: Security
**ë‹´ë‹¹ AI**: security-auditor
**ìƒíƒœ**: ëŒ€ê¸°
**ì§„ë„**: 0%

---

## ğŸ“‹ ì‘ì—… ê°œìš”

SQL Injection ê³µê²©ì„ ë°©ì–´í•˜ê¸° ìœ„í•œ ë³´ì•ˆ ì¡°ì¹˜ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. Supabase í´ë¼ì´ì–¸íŠ¸ì˜ íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬ë¥¼ í™œìš©í•˜ê³ , ì…ë ¥ê°’ ê²€ì¦ì„ ê°•í™”í•©ë‹ˆë‹¤.

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

- [ ] íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬ ì‚¬ìš©
- [ ] ì…ë ¥ê°’ ê²€ì¦ ë° ìƒˆë‹ˆíƒ€ì´ì œì´ì…˜
- [ ] SQL Injection íŒ¨í„´ íƒì§€
- [ ] ì—ëŸ¬ ë©”ì‹œì§€ ì •ë³´ ë…¸ì¶œ ë°©ì§€
- [ ] ORM ì•ˆì „ ì‚¬ìš©ë²• ì ìš©
- [ ] ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì‘ì„±

---

## ğŸ“ ê¸°ìˆ  ì‚¬ì–‘

### Security
- ORM: Supabase Client (ìë™ íŒŒë¼ë¯¸í„°í™”)
- Validation: Zod
- Testing: Jest

---

## ğŸ”— ì˜ì¡´ ì‘ì—…

**ì„ í–‰ ì‘ì—…**: P2B1 (ì •ì¹˜ì¸ ëª©ë¡ API Route)
**í›„ì† ì‘ì—…**: P3S2 (Rate Limiting - Phase 3)

---

## âœ… ì™„ë£Œ ê¸°ì¤€

1. ëª¨ë“  ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°í™” ì™„ë£Œ
2. ì…ë ¥ê°’ ê²€ì¦ ë¡œì§ êµ¬í˜„
3. SQL Injection í…ŒìŠ¤íŠ¸ í†µê³¼
4. ì—ëŸ¬ ë©”ì‹œì§€ ìƒˆë‹ˆíƒ€ì´ì œì´ì…˜ ì™„ë£Œ
5. ë³´ì•ˆ ê°€ì´ë“œë¼ì¸ ë¬¸ì„œí™”

---

## ğŸ’» êµ¬í˜„ ìƒì„¸

### 1. Supabase ì•ˆì „í•œ ì¿¼ë¦¬ íŒ¨í„´

```typescript
// lib/safe-query.ts
import { SupabaseClient } from '@supabase/supabase-js'

/**
 * SQL Injectionìœ¼ë¡œë¶€í„° ì•ˆì „í•œ ì¿¼ë¦¬ í—¬í¼
 * Supabase í´ë¼ì´ì–¸íŠ¸ëŠ” ìë™ìœ¼ë¡œ íŒŒë¼ë¯¸í„°í™”ë¥¼ ì œê³µí•˜ì§€ë§Œ,
 * ì¶”ê°€ ê²€ì¦ ë ˆì´ì–´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 */

// âŒ ìœ„í—˜í•œ íŒ¨í„´ (ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€)
// const query = `SELECT * FROM politicians WHERE name = '${userInput}'`

// âœ… ì•ˆì „í•œ íŒ¨í„´
export async function safeFindPolitician(
  supabase: SupabaseClient,
  name: string
) {
  // SupabaseëŠ” ìë™ìœ¼ë¡œ íŒŒë¼ë¯¸í„°í™”
  const { data, error } = await supabase
    .from('politicians')
    .select('*')
    .eq('name', name)  // íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬
    .single()

  return { data, error }
}

// âœ… LIKE ê²€ìƒ‰ë„ ì•ˆì „
export async function searchPoliticians(
  supabase: SupabaseClient,
  searchTerm: string
) {
  // ì…ë ¥ê°’ ê²€ì¦
  const sanitized = sanitizeSearchTerm(searchTerm)

  const { data, error } = await supabase
    .from('politicians')
    .select('*')
    .ilike('name', `%${sanitized}%`)  // ìë™ ì´ìŠ¤ì¼€ì´í”„

  return { data, error }
}
```

### 2. ì…ë ¥ê°’ ê²€ì¦ (Zod)

```typescript
// lib/validation.ts
import { z } from 'zod'

// ì •ì¹˜ì¸ ê²€ìƒ‰ ìŠ¤í‚¤ë§ˆ
export const PoliticianSearchSchema = z.object({
  q: z.string()
    .max(100, 'ê²€ìƒ‰ì–´ëŠ” 100ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')
    .regex(/^[a-zA-Zê°€-í£0-9\s]*$/, 'í—ˆìš©ë˜ì§€ ì•Šì€ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤')
    .optional(),
  party: z.array(z.string()).max(10).optional(),
  region: z.array(z.string()).max(20).optional(),
  page: z.coerce.number().int().min(1).default(1),
  limit: z.coerce.number().int().min(1).max(100).default(10)
})

// í‰ê°€ ìƒì„± ìŠ¤í‚¤ë§ˆ
export const CreateRatingSchema = z.object({
  politician_id: z.number().int().positive(),
  score: z.number().int().min(1).max(5),
  comment: z.string()
    .max(1000, 'ì½”ë©˜íŠ¸ëŠ” 1000ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤')
    .optional(),
  category: z.enum(['overall', 'policy', 'integrity', 'communication']).default('overall')
})

// ì…ë ¥ê°’ ê²€ì¦ í—¬í¼
export function validateInput<T>(schema: z.ZodSchema<T>, data: unknown): T {
  try {
    return schema.parse(data)
  } catch (error) {
    if (error instanceof z.ZodError) {
      throw new Error(`ì…ë ¥ê°’ ê²€ì¦ ì‹¤íŒ¨: ${error.errors[0].message}`)
    }
    throw error
  }
}
```

### 3. ì…ë ¥ê°’ ìƒˆë‹ˆíƒ€ì´ì œì´ì…˜

```typescript
// lib/sanitize.ts

/**
 * SQL Injection ìœ„í—˜ ë¬¸ì ì œê±°
 */
export function sanitizeSearchTerm(input: string): string {
  if (typeof input !== 'string') {
    throw new Error('Invalid input type')
  }

  // ê¸¸ì´ ì œí•œ
  if (input.length > 100) {
    throw new Error('Input too long')
  }

  // ìœ„í—˜í•œ SQL í‚¤ì›Œë“œ íŒ¨í„´ íƒì§€
  const dangerousPatterns = [
    /(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|EXECUTE)\b)/gi,
    /(--|\|\||;|\/\*|\*\/)/g,  // SQL ì½”ë©˜íŠ¸ ë° êµ¬ë¶„ì
    /('|(\\')|(\\")|("))/g,      // ë”°ì˜´í‘œ
    /(<|>|&lt;|&gt;)/g           // XSS ë°©ì–´ë„ ê²¸í•¨
  ]

  for (const pattern of dangerousPatterns) {
    if (pattern.test(input)) {
      throw new Error('Invalid characters detected')
    }
  }

  // ì•ˆì „í•œ ë¬¸ìë§Œ í—ˆìš© (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)
  const sanitized = input.replace(/[^a-zA-Zê°€-í£0-9\s]/g, '')

  return sanitized.trim()
}

/**
 * ìˆ«ì ì…ë ¥ê°’ ê²€ì¦
 */
export function validateNumericInput(input: unknown): number {
  const num = Number(input)

  if (isNaN(num) || !isFinite(num)) {
    throw new Error('Invalid numeric input')
  }

  if (num < 0 || num > Number.MAX_SAFE_INTEGER) {
    throw new Error('Numeric input out of range')
  }

  return Math.floor(num)
}
```

### 4. API Route ë³´ì•ˆ ì ìš©

```typescript
// app/api/politicians/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'
import { PoliticianSearchSchema, validateInput } from '@/lib/validation'
import { sanitizeSearchTerm } from '@/lib/sanitize'

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)

    // ì…ë ¥ê°’ ê²€ì¦
    const validatedParams = validateInput(PoliticianSearchSchema, {
      q: searchParams.get('q'),
      party: searchParams.get('party')?.split(','),
      region: searchParams.get('region')?.split(','),
      page: searchParams.get('page'),
      limit: searchParams.get('limit')
    })

    const supabase = createRouteHandlerClient({ cookies })

    // ì•ˆì „í•œ ì¿¼ë¦¬ ì‹¤í–‰
    let query = supabase
      .from('politicians')
      .select('*', { count: 'exact' })

    // ê²€ìƒ‰ì–´ê°€ ìˆëŠ” ê²½ìš°
    if (validatedParams.q) {
      const sanitized = sanitizeSearchTerm(validatedParams.q)
      query = query.ilike('name', `%${sanitized}%`)  // ìë™ ì´ìŠ¤ì¼€ì´í”„
    }

    // í•„í„° ì ìš©
    if (validatedParams.party && validatedParams.party.length > 0) {
      query = query.in('party', validatedParams.party)  // íŒŒë¼ë¯¸í„°í™”
    }

    if (validatedParams.region && validatedParams.region.length > 0) {
      query = query.in('region', validatedParams.region)
    }

    // í˜ì´ì§€ë„¤ì´ì…˜
    const start = (validatedParams.page - 1) * validatedParams.limit
    const end = start + validatedParams.limit - 1
    query = query.range(start, end)

    const { data, error, count } = await query

    if (error) {
      // ì—ëŸ¬ ë©”ì‹œì§€ ìƒˆë‹ˆíƒ€ì´ì œì´ì…˜ (DB ì •ë³´ ë…¸ì¶œ ë°©ì§€)
      console.error('Database error:', error)
      return NextResponse.json(
        { error: 'Failed to fetch politicians' },
        { status: 500 }
      )
    }

    return NextResponse.json({
      data,
      pagination: {
        page: validatedParams.page,
        limit: validatedParams.limit,
        total: count || 0
      }
    })
  } catch (error: any) {
    // ì‚¬ìš©ìì—ê²ŒëŠ” ì¼ë°˜ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ë§Œ ë°˜í™˜
    console.error('API error:', error)
    return NextResponse.json(
      { error: error.message || 'Internal server error' },
      { status: 400 }
    )
  }
}
```

### 5. SQL Injection í…ŒìŠ¤íŠ¸

```typescript
// tests/security/sql-injection.test.ts
import { describe, test, expect } from '@jest/globals'
import { sanitizeSearchTerm, validateNumericInput } from '@/lib/sanitize'

describe('SQL Injection ë°©ì–´', () => {
  test('SQL í‚¤ì›Œë“œ ì°¨ë‹¨', () => {
    expect(() => sanitizeSearchTerm("'; DROP TABLE politicians; --")).toThrow()
    expect(() => sanitizeSearchTerm("1' OR '1'='1")).toThrow()
    expect(() => sanitizeSearchTerm("admin'--")).toThrow()
  })

  test('SQL ì½”ë©˜íŠ¸ ì°¨ë‹¨', () => {
    expect(() => sanitizeSearchTerm("test--comment")).toThrow()
    expect(() => sanitizeSearchTerm("test/*comment*/")).toThrow()
    expect(() => sanitizeSearchTerm("test||'test'")).toThrow()
  })

  test('ë”°ì˜´í‘œ ì°¨ë‹¨', () => {
    expect(() => sanitizeSearchTerm("test'test")).toThrow()
    expect(() => sanitizeSearchTerm('test"test')).toThrow()
  })

  test('Union ê³µê²© ì°¨ë‹¨', () => {
    expect(() => sanitizeSearchTerm("1' UNION SELECT * FROM users--")).toThrow()
  })

  test('ì•ˆì „í•œ ì…ë ¥ì€ í†µê³¼', () => {
    expect(sanitizeSearchTerm('í™ê¸¸ë™')).toBe('í™ê¸¸ë™')
    expect(sanitizeSearchTerm('John Doe')).toBe('John Doe')
    expect(sanitizeSearchTerm('ì •ì¹˜ì¸ 123')).toBe('ì •ì¹˜ì¸ 123')
  })

  test('ìˆ«ì ì…ë ¥ ê²€ì¦', () => {
    expect(validateNumericInput('123')).toBe(123)
    expect(validateNumericInput(456)).toBe(456)
    expect(() => validateNumericInput('abc')).toThrow()
    expect(() => validateNumericInput(Infinity)).toThrow()
    expect(() => validateNumericInput(-1)).toThrow()
  })
})
```

### 6. E2E SQL Injection í…ŒìŠ¤íŠ¸

```typescript
// tests/e2e/sql-injection.spec.ts
import { test, expect } from '@playwright/test'

test.describe('SQL Injection ë°©ì–´ E2E', () => {
  test('ê²€ìƒ‰ì°½ SQL Injection ì°¨ë‹¨', async ({ page }) => {
    await page.goto('/politicians')

    // SQL Injection ì‹œë„
    const searchInput = page.locator('[data-testid="search-input"]')
    await searchInput.fill("'; DROP TABLE politicians; --")
    await searchInput.press('Enter')

    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ (DB ì •ë³´ ë…¸ì¶œ ì—†ì´)
    await expect(page.locator('[data-testid="error-message"]')).toContainText(
      'ì…ë ¥ê°’ ê²€ì¦ ì‹¤íŒ¨'
    )

    // í…Œì´ë¸”ì€ ì—¬ì „íˆ ì¡´ì¬ (ê³µê²© ì‹¤íŒ¨)
    await page.goto('/politicians')
    await expect(page.locator('[data-testid="politician-card"]')).toBeVisible()
  })

  test('URL íŒŒë¼ë¯¸í„° SQL Injection ì°¨ë‹¨', async ({ page }) => {
    // ì§ì ‘ URL ì¡°ì‘ ì‹œë„
    const response = await page.goto(
      "/politicians?party='; DROP TABLE politicians; --"
    )

    expect(response?.status()).toBe(400)
  })
})
```

---

## ğŸ“ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ëª¨ë“  ì‚¬ìš©ì ì…ë ¥ ê²€ì¦
- [ ] íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬ ì‚¬ìš©
- [ ] SQL í‚¤ì›Œë“œ íŒ¨í„´ íƒì§€
- [ ] ì—ëŸ¬ ë©”ì‹œì§€ ìƒˆë‹ˆíƒ€ì´ì œì´ì…˜
- [ ] ì…ë ¥ ê¸¸ì´ ì œí•œ
- [ ] ìˆ«ì ì…ë ¥ íƒ€ì… ê²€ì¦
- [ ] í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹ í•„í„°ë§

---

## ğŸ”’ ë³´ì•ˆ ê°€ì´ë“œë¼ì¸

### DO (ê¶Œì¥)
- âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ë©”ì„œë“œ ì‚¬ìš© (ìë™ íŒŒë¼ë¯¸í„°í™”)
- âœ… Zodë¡œ ì…ë ¥ê°’ ìŠ¤í‚¤ë§ˆ ê²€ì¦
- âœ… í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹ í•„í„°ë§
- âœ… ì—ëŸ¬ ë©”ì‹œì§€ ì¼ë°˜í™”

### DON'T (ê¸ˆì§€)
- âŒ ë¬¸ìì—´ í…œí”Œë¦¿ìœ¼ë¡œ SQL ì¿¼ë¦¬ ì‘ì„±
- âŒ ì‚¬ìš©ì ì…ë ¥ì„ ì§ì ‘ ì¿¼ë¦¬ì— ì‚½ì…
- âŒ ìƒì„¸í•œ DB ì—ëŸ¬ ë…¸ì¶œ
- âŒ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë°©ì‹ í•„í„°ë§ (ìš°íšŒ ê°€ëŠ¥)

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

**ì‘ì—… ì™„ë£Œ ì¼ì‹œ**: ëŒ€ê¸°ì¤‘
**í…ŒìŠ¤íŠ¸/ê²€í†  ê²°ê³¼**: ëŒ€ê¸°
**ìë™í™” ë°©ì‹**: AI-only
**ë¸”ë¡œì»¤**: ì—†ìŒ
**ë¹„ê³ **:
- SupabaseëŠ” ê¸°ë³¸ì ìœ¼ë¡œ SQL Injection ë°©ì–´ ì œê³µ
- ì¶”ê°€ ê²€ì¦ ë ˆì´ì–´ë¡œ ë°©ì–´ ê°•í™”
- OWASP Top 10 ì·¨ì•½ì  ì¤‘ 1ìœ„

---

**ì‘ì„± ë°©ë²•ë¡ **: 13DGC-AODM v1.1
**AI-Only ì›ì¹™ ì¤€ìˆ˜**: âœ…
