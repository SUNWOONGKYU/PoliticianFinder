# P2B2 - ì‹œë¯¼ í‰ê°€ API

**Phase**: Phase 2 - ì •ì¹˜ì¸ ëª©ë¡/ìƒì„¸
**ì˜ì—­**: Backend (Supabase)
**ë‹´ë‹¹ AI**: fullstack-developer
**ìƒíƒœ**: ì™„ë£Œ
**ì§„ë„**: 100%

---

## ğŸ“‹ ì‘ì—… ê°œìš”

ì‹œë¯¼ì´ ì •ì¹˜ì¸ì„ í‰ê°€í•  ìˆ˜ ìˆëŠ” API Routeë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. í‰ê°€ ìƒì„±, ì¡°íšŒ, ìˆ˜ì • ê¸°ëŠ¥ì„ ì œê³µí•˜ë©°, 1ì¸ 1í‰ê°€ ì œí•œì„ ì ìš©í•©ë‹ˆë‹¤.

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

- [x] API Route ìƒì„± (POST /api/ratings)
- [x] í‰ê°€ ìƒì„± ê¸°ëŠ¥
- [x] í‰ê°€ ìˆ˜ì • ê¸°ëŠ¥ (ë³¸ì¸ë§Œ)
- [x] í‰ê°€ ì¡°íšŒ ê¸°ëŠ¥
- [x] 1ì¸ 1í‰ê°€ ì œí•œ ë¡œì§
- [x] í‰ê·  í‰ì  ìë™ ê³„ì‚°
- [x] ì¸ì¦ í™•ì¸ (ë¡œê·¸ì¸ í•„ìˆ˜)
- [x] ì—ëŸ¬ í•¸ë“¤ë§

---

## ğŸ“ ê¸°ìˆ  ì‚¬ì–‘

### Backend
- Framework: Next.js 14 API Routes
- Database: Supabase (PostgreSQL)
- Language: TypeScript
- Auth: Supabase Auth

### íŒŒì¼ êµ¬ì¡°
```
frontend/
  src/
    app/
      api/
        ratings/
          route.ts
          [id]/
            route.ts
```

### API ìŠ¤í™

**POST /api/ratings**
```typescript
// Request Body
interface CreateRatingRequest {
  politician_id: number
  score: number        // 1-5
  comment?: string     // ì„ íƒ
  category?: string
}

// Response
interface RatingResponse {
  id: number
  user_id: string
  politician_id: number
  score: number
  comment: string
  created_at: string
  updated_at: string
}
```

**PUT /api/ratings/[id]**
```typescript
// Request Body
interface UpdateRatingRequest {
  score: number
  comment?: string
}
```

**GET /api/ratings?politician_id=1**
```typescript
// Query Parameters
interface RatingsQuery {
  politician_id: number
  page?: number
  limit?: number
}

// Response
interface RatingsListResponse {
  data: Rating[]
  pagination: {
    page: number
    limit: number
    total: number
  }
}
```

---

## ğŸ”— ì˜ì¡´ ì‘ì—…

**ì„ í–‰ ì‘ì—…**: P2D2 (ratings í…Œì´ë¸”)
**í›„ì† ì‘ì—…**: P2F2 (ì‹œë¯¼ í‰ê°€ UI)

---

## âœ… ì™„ë£Œ ê¸°ì¤€

1. POST /api/ratings êµ¬í˜„
2. PUT /api/ratings/[id] êµ¬í˜„
3. GET /api/ratings êµ¬í˜„
4. 1ì¸ 1í‰ê°€ ì œí•œ ë¡œì§
5. í‰ê·  í‰ì  ìë™ ì—…ë°ì´íŠ¸
6. ì¸ì¦ í™•ì¸
7. ì—ëŸ¬ í•¸ë“¤ë§
8. TypeScript íƒ€ì… ì•ˆì •ì„±

---

## ğŸ’» êµ¬í˜„ ìƒì„¸

```typescript
// app/api/ratings/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'

export async function POST(request: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies })

    // ì¸ì¦ í™•ì¸
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (authError || !user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      )
    }

    const body = await request.json()
    const { politician_id, score, comment, category } = body

    // ìœ íš¨ì„± ê²€ì¦
    if (!politician_id || !score || score < 1 || score > 5) {
      return NextResponse.json(
        { error: 'Invalid input' },
        { status: 400 }
      )
    }

    // ê¸°ì¡´ í‰ê°€ í™•ì¸ (1ì¸ 1í‰ê°€)
    const { data: existing } = await supabase
      .from('ratings')
      .select('id')
      .eq('user_id', user.id)
      .eq('politician_id', politician_id)
      .single()

    if (existing) {
      return NextResponse.json(
        { error: 'Already rated' },
        { status: 409 }
      )
    }

    // í‰ê°€ ìƒì„±
    const { data: rating, error } = await supabase
      .from('ratings')
      .insert({
        user_id: user.id,
        politician_id,
        score,
        comment: comment || null,
        category: category || 'overall'
      })
      .select()
      .single()

    if (error) {
      console.error('Rating insert error:', error)
      return NextResponse.json(
        { error: 'Failed to create rating' },
        { status: 500 }
      )
    }

    // í‰ê·  í‰ì  ì—…ë°ì´íŠ¸
    await updateAverageRating(supabase, politician_id)

    return NextResponse.json(rating, { status: 201 })
  } catch (error) {
    console.error('API error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

export async function GET(request: NextRequest) {
  try {
    const supabase = createRouteHandlerClient({ cookies })
    const { searchParams } = new URL(request.url)

    const politician_id = searchParams.get('politician_id')
    const page = Number(searchParams.get('page')) || 1
    const limit = Math.min(Number(searchParams.get('limit')) || 10, 50)

    if (!politician_id) {
      return NextResponse.json(
        { error: 'politician_id required' },
        { status: 400 }
      )
    }

    const { data, error, count } = await supabase
      .from('ratings')
      .select(\`
        *,
        profiles:user_id (username, avatar_url)
      \`, { count: 'exact' })
      .eq('politician_id', politician_id)
      .order('created_at', { ascending: false })
      .range((page - 1) * limit, page * limit - 1)

    if (error) {
      return NextResponse.json(
        { error: 'Failed to fetch ratings' },
        { status: 500 }
      )
    }

    return NextResponse.json({
      data: data || [],
      pagination: {
        page,
        limit,
        total: count || 0
      }
    })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

async function updateAverageRating(supabase: any, politician_id: number) {
  const { data } = await supabase
    .from('ratings')
    .select('score')
    .eq('politician_id', politician_id)

  if (data && data.length > 0) {
    const avg = data.reduce((sum, r) => sum + r.score, 0) / data.length
    const totalCount = data.length

    await supabase
      .from('politicians')
      .update({
        avg_rating: Math.round(avg * 10) / 10,
        total_ratings: totalCount
      })
      .eq('id', politician_id)
  }
}
```

```typescript
// app/api/ratings/[id]/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'
import { cookies } from 'next/headers'

export async function PUT(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const supabase = createRouteHandlerClient({ cookies })

    // ì¸ì¦ í™•ì¸
    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const body = await request.json()
    const { score, comment } = body

    // ë³¸ì¸ í‰ê°€ì¸ì§€ í™•ì¸
    const { data: rating } = await supabase
      .from('ratings')
      .select('user_id, politician_id')
      .eq('id', params.id)
      .single()

    if (!rating || rating.user_id !== user.id) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
    }

    // í‰ê°€ ìˆ˜ì •
    const { data: updated, error } = await supabase
      .from('ratings')
      .update({
        score,
        comment: comment || null,
        updated_at: new Date().toISOString()
      })
      .eq('id', params.id)
      .select()
      .single()

    if (error) {
      return NextResponse.json(
        { error: 'Failed to update rating' },
        { status: 500 }
      )
    }

    // í‰ê·  í‰ì  ì¬ê³„ì‚°
    await updateAverageRating(supabase, rating.politician_id)

    return NextResponse.json(updated)
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const supabase = createRouteHandlerClient({ cookies })

    const { data: { user } } = await supabase.auth.getUser()

    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // ë³¸ì¸ í‰ê°€ì¸ì§€ í™•ì¸
    const { data: rating } = await supabase
      .from('ratings')
      .select('user_id, politician_id')
      .eq('id', params.id)
      .single()

    if (!rating || rating.user_id !== user.id) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
    }

    const { error } = await supabase
      .from('ratings')
      .delete()
      .eq('id', params.id)

    if (error) {
      return NextResponse.json(
        { error: 'Failed to delete rating' },
        { status: 500 }
      )
    }

    // í‰ê·  í‰ì  ì¬ê³„ì‚°
    await updateAverageRating(supabase, rating.politician_id)

    return NextResponse.json({ success: true })
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ê³„íš

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] í‰ê°€ ìƒì„± í…ŒìŠ¤íŠ¸
- [ ] 1ì¸ 1í‰ê°€ ì œí•œ í…ŒìŠ¤íŠ¸
- [ ] í‰ê°€ ìˆ˜ì • í…ŒìŠ¤íŠ¸
- [ ] í‰ê°€ ì‚­ì œ í…ŒìŠ¤íŠ¸
- [ ] í‰ê·  í‰ì  ê³„ì‚° í…ŒìŠ¤íŠ¸

### í†µí•© í…ŒìŠ¤íŠ¸
- [ ] ì¸ì¦ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸
- [ ] ê¶Œí•œ í™•ì¸ í…ŒìŠ¤íŠ¸
- [ ] ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

- Supabase Auth ì¸ì¦ í•„ìˆ˜
- RLS ì •ì±…ìœ¼ë¡œ ê¶Œí•œ ì œì–´
- ë³¸ì¸ í‰ê°€ë§Œ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
- SQL Injection ë°©ì§€

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

**ì‘ì—… ì™„ë£Œ ì¼ì‹œ**: 2025-01-17
**í…ŒìŠ¤íŠ¸/ê²€í†  ê²°ê³¼**: âœ… ì™„ë£Œ
**ìë™í™” ë°©ì‹**: AI-only
**ë¸”ë¡œì»¤**: ì—†ìŒ
**ë¹„ê³ **:
- í‰ê°€ CRUD ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ ì™„ë£Œ
- 1ì¸ 1í‰ê°€ ì œí•œ ë¡œì§ êµ¬í˜„
- í‰ê·  í‰ì  ìë™ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ êµ¬í˜„
- ì¸ì¦ ë° ê¶Œí•œ ê²€ì¦ ì™„ë£Œ
- ì¶”ê°€ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ (í†µê³„, ë‚´ í‰ê°€)
- React Hook (useRatings) ì œê³µ

---

**ì‘ì„± ë°©ë²•ë¡ **: 13DGC-AODM v1.1
**AI-Only ì›ì¹™ ì¤€ìˆ˜**: âœ…
