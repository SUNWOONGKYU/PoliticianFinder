# P2E1 - ratings RLS 확장

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: RLS Policies (Supabase)
**담당 AI**: security-auditor
**상태**: 대기
**진도**: 0%

---

## 📋 작업 개요

ratings 테이블에 대한 Row Level Security 정책을 설정합니다. 사용자는 자신의 평가만 수정/삭제할 수 있고, 모든 평가는 조회 가능하도록 설정합니다.

---

## 🎯 작업 목표

- [ ] RLS 활성화
- [ ] SELECT 정책 (모든 평가 조회 가능)
- [ ] INSERT 정책 (로그인 사용자만 생성 + 1인 1평가)
- [ ] UPDATE 정책 (본인 평가만 수정)
- [ ] DELETE 정책 (본인 평가만 삭제)
- [ ] 정책 테스트

---

## 📐 기술 사양

### Security
- Platform: Supabase RLS (Row Level Security)
- Auth: Supabase Auth (auth.uid())
- Database: PostgreSQL 15+

---

## 🔗 의존 작업

**선행 작업**: P2D2 (ratings 테이블)
**후속 작업**: P2B2 (시민 평가 API)

---

## ✅ 완료 기준

1. RLS 활성화 완료
2. 4개 정책 생성 완료 (SELECT, INSERT, UPDATE, DELETE)
3. 본인 평가 CRUD 테스트 통과
4. 타인 평가 수정/삭제 차단 확인
5. 비로그인 사용자 읽기 전용 확인
6. 1인 1평가 제약 동작 확인

---

## 💻 구현 상세

### 1. RLS 활성화

```sql
-- supabase/migrations/[timestamp]_ratings_rls.sql

-- RLS 활성화
ALTER TABLE ratings ENABLE ROW LEVEL SECURITY;
```

### 2. SELECT 정책 (모든 평가 조회 가능)

```sql
-- 모든 사용자(비로그인 포함)가 모든 평가 조회 가능
CREATE POLICY "Ratings are viewable by everyone"
ON ratings FOR SELECT
USING (true);
```

**이유**:
- 정치인 평가는 공개 정보
- 투명성을 위해 모든 평가 공개
- 프로필과 조인하여 작성자 정보도 표시

### 3. INSERT 정책 (로그인 사용자만 생성)

```sql
-- 로그인한 사용자만 평가 생성 가능
-- user_id는 현재 로그인한 사용자 ID와 일치해야 함
CREATE POLICY "Authenticated users can create ratings"
ON ratings FOR INSERT
WITH CHECK (auth.uid() = user_id);
```

**보안 특징**:
- `auth.uid()`는 Supabase Auth의 현재 로그인 사용자 UUID
- 사용자가 다른 사람의 user_id로 평가 생성 불가
- 1인 1평가는 UNIQUE 제약조건으로 DB 레벨에서 추가 보장 (P2D2)

### 4. UPDATE 정책 (본인 평가만 수정)

```sql
-- 본인이 작성한 평가만 수정 가능
CREATE POLICY "Users can update their own ratings"
ON ratings FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);
```

**보안 특징**:
- `USING`: 수정 대상 행을 선택하는 조건
- `WITH CHECK`: 수정 후 데이터 검증
- user_id 변경 방지 (user_id를 다른 사용자로 변경 시도 차단)

### 5. DELETE 정책 (본인 평가만 삭제)

```sql
-- 본인이 작성한 평가만 삭제 가능
CREATE POLICY "Users can delete their own ratings"
ON ratings FOR DELETE
USING (auth.uid() = user_id);
```

### 6. 전체 마이그레이션 SQL

```sql
-- supabase/migrations/[timestamp]_ratings_rls.sql

-- RLS 활성화
ALTER TABLE ratings ENABLE ROW LEVEL SECURITY;

-- SELECT: 모든 평가 조회 가능
CREATE POLICY "Ratings are viewable by everyone"
ON ratings FOR SELECT
USING (true);

-- INSERT: 로그인한 사용자만 생성
CREATE POLICY "Authenticated users can create ratings"
ON ratings FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- UPDATE: 본인 평가만 수정
CREATE POLICY "Users can update their own ratings"
ON ratings FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- DELETE: 본인 평가만 삭제
CREATE POLICY "Users can delete their own ratings"
ON ratings FOR DELETE
USING (auth.uid() = user_id);
```

### 7. 롤백 SQL

```sql
-- supabase/migrations/[timestamp]_rollback_ratings_rls.sql

-- 정책 제거
DROP POLICY IF EXISTS "Users can delete their own ratings" ON ratings;
DROP POLICY IF EXISTS "Users can update their own ratings" ON ratings;
DROP POLICY IF EXISTS "Authenticated users can create ratings" ON ratings;
DROP POLICY IF EXISTS "Ratings are viewable by everyone" ON ratings;

-- RLS 비활성화 (개발 환경에서만)
-- ALTER TABLE ratings DISABLE ROW LEVEL SECURITY;
```

---

## 📝 테스트 계획

### 1. RLS 활성화 확인

```sql
-- RLS 상태 확인
SELECT tablename, rowsecurity
FROM pg_tables
WHERE tablename = 'ratings';
-- rowsecurity = true 확인

-- 정책 목록 확인
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE tablename = 'ratings';
```

### 2. SELECT 정책 테스트

```sql
-- 비로그인 상태에서 조회 (Supabase 대시보드)
SELECT * FROM ratings LIMIT 5;
-- 성공해야 함

-- 로그인 상태에서 조회
SELECT * FROM ratings WHERE politician_id = 1;
-- 성공해야 함
```

### 3. INSERT 정책 테스트

```typescript
// 테스트 코드 (Jest + Supabase)

describe('Ratings RLS - INSERT', () => {
  test('로그인한 사용자는 평가 생성 가능', async () => {
    // 사용자 A로 로그인
    const { data, error } = await supabase
      .from('ratings')
      .insert({
        politician_id: 1,
        score: 5,
        comment: '좋습니다'
      })
      .select()
      .single()

    expect(error).toBeNull()
    expect(data).toBeDefined()
    expect(data.user_id).toBe(userA.id) // 자동으로 현재 사용자 ID 설정됨
  })

  test('비로그인 사용자는 평가 생성 불가', async () => {
    // 로그아웃 상태
    await supabase.auth.signOut()

    const { data, error } = await supabase
      .from('ratings')
      .insert({
        politician_id: 1,
        score: 5
      })

    expect(error).toBeDefined() // RLS 에러 발생
    expect(data).toBeNull()
  })

  test('다른 사용자 ID로 평가 생성 불가', async () => {
    // 사용자 A로 로그인했지만 user_id를 B로 지정 시도
    const { error } = await supabase
      .from('ratings')
      .insert({
        user_id: userB.id, // 다른 사용자 ID
        politician_id: 1,
        score: 5
      })

    expect(error).toBeDefined() // WITH CHECK 위반
  })
})
```

### 4. UPDATE 정책 테스트

```typescript
describe('Ratings RLS - UPDATE', () => {
  test('본인 평가는 수정 가능', async () => {
    // 사용자 A가 자신의 평가 수정
    const { data, error } = await supabase
      .from('ratings')
      .update({ score: 4, comment: '수정함' })
      .eq('id', myRatingId)
      .select()
      .single()

    expect(error).toBeNull()
    expect(data.score).toBe(4)
  })

  test('타인 평가는 수정 불가', async () => {
    // 사용자 A가 사용자 B의 평가 수정 시도
    const { error } = await supabase
      .from('ratings')
      .update({ score: 1 })
      .eq('id', otherUserRatingId)

    expect(error).toBeDefined() // USING 조건 위반
  })

  test('user_id 변경 불가', async () => {
    // 본인 평가이지만 user_id 변경 시도
    const { error } = await supabase
      .from('ratings')
      .update({ user_id: userB.id })
      .eq('id', myRatingId)

    expect(error).toBeDefined() // WITH CHECK 위반
  })
})
```

### 5. DELETE 정책 테스트

```typescript
describe('Ratings RLS - DELETE', () => {
  test('본인 평가는 삭제 가능', async () => {
    const { error } = await supabase
      .from('ratings')
      .delete()
      .eq('id', myRatingId)

    expect(error).toBeNull()
  })

  test('타인 평가는 삭제 불가', async () => {
    const { error } = await supabase
      .from('ratings')
      .delete()
      .eq('id', otherUserRatingId)

    expect(error).toBeDefined() // USING 조건 위반
  })
})
```

---

## 🔒 보안 고려사항

### 주요 보안 특징

1. **인증 기반 권한 제어**
   - `auth.uid()`를 사용하여 현재 로그인 사용자 확인
   - 비로그인 사용자는 읽기만 가능

2. **소유권 검증**
   - 본인이 작성한 평가만 수정/삭제 가능
   - user_id 변조 방지

3. **투명성 보장**
   - 모든 평가는 공개 (SELECT true)
   - 정치인 평가의 신뢰성 확보

4. **다층 방어**
   - RLS + UNIQUE 제약조건 (1인 1평가)
   - API 레벨 검증 + DB 레벨 검증

### SQL Injection 방어

- Supabase Client는 자동으로 파라미터화된 쿼리 사용
- RLS 정책은 사용자 입력과 무관

### 성능 영향

- RLS는 모든 쿼리에 자동으로 WHERE 절 추가
- 인덱스 활용 필요 (P2D3에서 처리됨)
- `user_id`, `politician_id` 인덱스로 성능 최적화

---

## 📌 참고사항

**작업 완료 일시**: 대기중
**테스트/검토 결과**: 대기
**자동화 방식**: AI-only
**블로커**: 없음
**비고**:
- RLS는 Supabase 대시보드에서도 확인 가능
- `auth.uid()`는 JWT 토큰에서 자동 추출
- 관리자 계정은 RLS 우회 가능 (service_role key 사용 시)
- 프로덕션 환경에서는 anon key만 사용

---

**작성 방법론**: 13DGC-AODM v1.1
**AI-Only 원칙 준수**: ✅
