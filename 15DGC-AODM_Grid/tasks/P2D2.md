# P2D2 - ratings 테이블

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: Database (Supabase)
**담당 AI**: fullstack-developer
**상태**: 대기
**진도**: 0%

---

## 📋 작업 개요

시민들이 정치인을 평가할 수 있는 `ratings` 테이블을 생성합니다. 사용자별 1인 1평가 제한, 평점(1-5), 코멘트, 카테고리 등을 저장합니다.

---

## 🎯 작업 목표

- [ ] ratings 테이블 생성
- [ ] 1인 1평가 제약조건 (UNIQUE)
- [ ] 평점 범위 제약조건 (1-5)
- [ ] 외래키 설정 (users, politicians)
- [ ] 인덱스 추가
- [ ] RLS 정책 준비
- [ ] 마이그레이션 스크립트

---

## 📐 기술 사양

### Database
- Platform: Supabase (PostgreSQL 15+)
- ORM: Supabase Client
- Migration Tool: Supabase CLI

---

## 🔗 의존 작업

**선행 작업**: P1D2 (politicians 테이블)
**후속 작업**: P2B2 (시민 평가 API), P2B3 (평가 집계 로직)

---

## ✅ 완료 기준

1. ratings 테이블 생성 완료
2. 제약조건 설정 완료
3. 외래키 설정 완료
4. 인덱스 생성 완료
5. 마이그레이션 스크립트 작성 완료
6. 롤백 가능 확인

---

## 💻 구현 상세

### 1. 테이블 스키마

```sql
-- supabase/migrations/[timestamp]_create_ratings_table.sql

CREATE TABLE IF NOT EXISTS ratings (
  id BIGSERIAL PRIMARY KEY,

  -- 사용자 정보 (Supabase Auth)
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- 정치인 정보
  politician_id BIGINT NOT NULL REFERENCES politicians(id) ON DELETE CASCADE,

  -- 평가 내용
  score INTEGER NOT NULL CHECK (score >= 1 AND score <= 5),
  comment TEXT,
  category VARCHAR(50) DEFAULT 'overall',

  -- 타임스탬프
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- 1인 1평가 제약조건
  CONSTRAINT unique_user_politician UNIQUE(user_id, politician_id)
);

-- 코멘트 길이 제한 (선택사항)
ALTER TABLE ratings
ADD CONSTRAINT check_comment_length
CHECK (LENGTH(comment) <= 1000);

-- 테이블 설명
COMMENT ON TABLE ratings IS '시민의 정치인 평가 테이블';
COMMENT ON COLUMN ratings.score IS '평점 (1-5)';
COMMENT ON COLUMN ratings.category IS '평가 카테고리 (overall, policy, integrity, communication 등)';
```

### 2. 인덱스 생성

```sql
-- 정치인별 평가 조회 최적화
CREATE INDEX idx_ratings_politician_id
ON ratings(politician_id);

-- 사용자별 평가 조회 최적화
CREATE INDEX idx_ratings_user_id
ON ratings(user_id);

-- 최신 평가순 정렬 최적화
CREATE INDEX idx_ratings_created_at
ON ratings(created_at DESC);

-- 정치인 + 평점 복합 인덱스 (통계 쿼리 최적화)
CREATE INDEX idx_ratings_politician_score
ON ratings(politician_id, score);

-- 정치인 + 생성일 복합 인덱스 (시간순 정렬)
CREATE INDEX idx_ratings_politician_created
ON ratings(politician_id, created_at DESC);
```

### 3. 트리거 - updated_at 자동 업데이트

```sql
-- updated_at 자동 업데이트 트리거
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_ratings_updated_at
BEFORE UPDATE ON ratings
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### 4. 롤백 SQL

```sql
-- supabase/migrations/[timestamp]_rollback_create_ratings_table.sql

-- 트리거 제거
DROP TRIGGER IF EXISTS update_ratings_updated_at ON ratings;
DROP FUNCTION IF EXISTS update_updated_at_column();

-- 인덱스 제거
DROP INDEX IF EXISTS idx_ratings_politician_created;
DROP INDEX IF EXISTS idx_ratings_politician_score;
DROP INDEX IF EXISTS idx_ratings_created_at;
DROP INDEX IF EXISTS idx_ratings_user_id;
DROP INDEX IF EXISTS idx_ratings_politician_id;

-- 테이블 제거
DROP TABLE IF EXISTS ratings;
```

### 5. TypeScript 타입 정의

```typescript
// types/database.ts

export interface Rating {
  id: number
  user_id: string              // UUID (Supabase Auth)
  politician_id: number
  score: number                // 1-5
  comment: string | null
  category: string             // 'overall' | 'policy' | 'integrity' | 'communication'
  created_at: string
  updated_at: string
}

// API 요청 타입
export interface CreateRatingRequest {
  politician_id: number
  score: number
  comment?: string
  category?: string
}

export interface UpdateRatingRequest {
  score: number
  comment?: string
}

// API 응답 타입 (프로필 정보 포함)
export interface RatingWithProfile extends Rating {
  profiles: {
    username: string
    avatar_url: string | null
  }
}

// Supabase 자동 생성 타입
export type RatingsRow = Database['public']['Tables']['ratings']['Row']
export type RatingsInsert = Database['public']['Tables']['ratings']['Insert']
export type RatingsUpdate = Database['public']['Tables']['ratings']['Update']
```

### 6. 샘플 데이터

```sql
-- 개발/테스트용 샘플 데이터
INSERT INTO ratings (user_id, politician_id, score, comment, category)
VALUES
  ('550e8400-e29b-41d4-a716-446655440000', 1, 5, '훌륭한 정치인입니다.', 'overall'),
  ('550e8400-e29b-41d4-a716-446655440001', 1, 4, '정책이 좋습니다.', 'policy'),
  ('550e8400-e29b-41d4-a716-446655440002', 2, 3, '보통입니다.', 'overall');
```

---

## 📝 테스트 계획

### 단위 테스트
- [ ] 테이블 생성 확인
- [ ] 제약조건 동작 확인
  - [ ] 1인 1평가 제약 (중복 평가 시 에러)
  - [ ] 평점 범위 제약 (0 또는 6 입력 시 에러)
  - [ ] 외래키 제약 (존재하지 않는 정치인 ID 시 에러)
- [ ] 인덱스 생성 확인
- [ ] 트리거 동작 확인 (updated_at 자동 업데이트)

### 통합 테스트
- [ ] INSERT 쿼리 성공 확인
- [ ] UPDATE 쿼리 성공 확인
- [ ] DELETE 쿼리 성공 확인 (CASCADE 동작)
- [ ] 인덱스 사용 확인 (EXPLAIN ANALYZE)

### 검증 쿼리

```sql
-- 테이블 구조 확인
\d ratings

-- 제약조건 확인
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'ratings';

-- 인덱스 확인
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'ratings';

-- 샘플 데이터 조회
SELECT * FROM ratings LIMIT 5;

-- 1인 1평가 제약 테스트 (에러 발생 예상)
INSERT INTO ratings (user_id, politician_id, score)
VALUES ('550e8400-e29b-41d4-a716-446655440000', 1, 4);
-- ERROR: duplicate key value violates unique constraint "unique_user_politician"

-- 평점 범위 제약 테스트 (에러 발생 예상)
INSERT INTO ratings (user_id, politician_id, score)
VALUES ('550e8400-e29b-41d4-a716-446655440000', 2, 6);
-- ERROR: new row violates check constraint "ratings_score_check"
```

---

## 🔒 보안 고려사항

- RLS 정책은 P2E1에서 설정
- user_id는 Supabase Auth에서 자동으로 가져옴
- 본인의 평가만 수정/삭제 가능하도록 RLS 설정 필요
- comment는 XSS 방지를 위해 프론트엔드에서 sanitize 필요

---

## 📌 참고사항

**작업 완료 일시**: 대기중
**테스트/검토 결과**: 대기
**자동화 방식**: AI-only
**블로커**: 없음
**비고**:
- category는 향후 확장 가능 (정책, 청렴도, 소통 등)
- comment는 선택 사항 (NULL 허용)
- 1인 1평가는 UNIQUE 제약조건으로 DB 레벨에서 강제

---

**작성 방법론**: 15DGC-AODM v3.0
**AI-Only 원칙 준수**: ✅
