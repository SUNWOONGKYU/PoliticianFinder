# P2V2 - CI/CD 파이프라인

**Phase**: Phase 2 - 정치인 목록/상세
**영역**: DevOps
**담당 AI**: devops-troubleshooter
**상태**: 대기
**진도**: 0%

---

## 📋 작업 개요

GitHub Actions를 사용하여 CI/CD 파이프라인을 구축합니다. 코드 푸시 시 자동으로 린팅, 테스트, 빌드를 실행하고, 성공 시 자동 배포합니다.

---

## 🎯 작업 목표

- [ ] GitHub Actions 워크플로우 작성
- [ ] Lint 자동화
- [ ] 테스트 자동화
- [ ] 빌드 자동화
- [ ] E2E 테스트 자동화
- [ ] 자동 배포 설정
- [ ] PR 체크 설정

---

## 📐 기술 사양

### CI/CD
- Platform: GitHub Actions
- Test: Jest, Playwright
- Deploy: Vercel

---

## 🔗 의존 작업

**선행 작업**: P2V1 (Vercel 배포)
**후속 작업**: P3V2 (에러 트래킹 - Phase 3)

---

## ✅ 완료 기준

1. GitHub Actions 워크플로우 작성 완료
2. PR 체크 동작 확인
3. 테스트 자동화 확인
4. 자동 배포 동작 확인
5. 실패 시 알림 설정

---

## 💻 구현 상세

### 1. CI 워크플로우 (Lint + Test)

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript check
        run: npm run type-check

  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          BASE_URL: http://localhost:3000

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
```

### 2. CD 워크플로우 (자동 배포)

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Production
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
```

### 3. PR 체크 워크플로우

```yaml
# .github/workflows/pr-check.yml
name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    name: PR Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint check
        run: npm run lint

      - name: Type check
        run: npm run type-check

      - name: Run tests
        run: npm test

      - name: Build check
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Comment PR
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅ 통과' : '❌ 실패'
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: `## PR 체크 결과\n\n${status}\n\n모든 검증이 완료되었습니다.`
            })
```

### 4. 의존성 업데이트 자동화

```yaml
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10
    reviewers:
      - "your-username"
    labels:
      - "dependencies"
```

### 5. GitHub Secrets 설정

**Settings > Secrets and variables > Actions > New repository secret:**

```
NEXT_PUBLIC_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY
VERCEL_TOKEN
VERCEL_ORG_ID
VERCEL_PROJECT_ID
```

### 6. Branch Protection Rules

**Settings > Branches > Add rule:**

- Branch name pattern: `main`
- Require pull request reviews: 1 approval
- Require status checks to pass:
  - Lint
  - Unit & Integration Tests
  - Build
- Require branches to be up to date
- Include administrators: false

---

## 📝 워크플로우 실행 확인

```bash
# 1. feature 브랜치 생성 및 작업
git checkout -b feature/test-cicd
git add .
git commit -m "test: CI/CD 파이프라인 테스트"
git push origin feature/test-cicd

# 2. GitHub에서 PR 생성
# → CI 워크플로우 자동 실행

# 3. PR 머지
# → CD 워크플로우 자동 실행 (main 브랜치 배포)
```

---

## 🔒 보안 고려사항

- GitHub Secrets로 민감 정보 관리
- Vercel Token은 읽기 전용 권한만 부여
- PR에서 Secrets 노출 방지

---

## 📌 참고사항

**작업 완료 일시**: 대기중
**테스트/검토 결과**: 대기
**자동화 방식**: AI-only
**블로커**: 없음
**비고**: GitHub Actions는 public repo 무제한, private repo 월 2000분 무료

---

**작성 방법론**: 15DGC-AODM v3.0
**AI-Only 원칙 준수**: ✅
