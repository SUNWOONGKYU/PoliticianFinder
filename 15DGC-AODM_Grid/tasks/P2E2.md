# P2E2 - comments RLS ì„¤ì •

**Phase**: Phase 2 - ì •ì¹˜ì¸ ëª©ë¡/ìƒì„¸
**ì˜ì—­**: RLS Policies (Supabase)
**ë‹´ë‹¹ AI**: security-auditor
**ìƒíƒœ**: ì™„ë£Œ
**ì§„ë„**: 100%

---

## ğŸ“‹ ì‘ì—… ê°œìš”

Phase 3ì—ì„œ ì‚¬ìš©ë  comments í…Œì´ë¸”ì— ëŒ€í•œ Row Level Security ì •ì±…ì„ ë¯¸ë¦¬ ì„¤ì •í•©ë‹ˆë‹¤. ëŒ“ê¸€ì˜ ì¡°íšŒ, ìƒì„±, ìˆ˜ì •, ì‚­ì œ ê¶Œí•œì„ ì •ì˜í•©ë‹ˆë‹¤.

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

- [ ] RLS í™œì„±í™”
- [ ] SELECT ì •ì±… (ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ ê°€ëŠ¥)
- [ ] INSERT ì •ì±… (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ìƒì„±)
- [ ] UPDATE ì •ì±… (ë³¸ì¸ ëŒ“ê¸€ë§Œ ìˆ˜ì •)
- [ ] DELETE ì •ì±… (ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìë§Œ ì‚­ì œ)
- [ ] ì •ì±… í…ŒìŠ¤íŠ¸

---

## ğŸ“ ê¸°ìˆ  ì‚¬ì–‘

### Security
- Platform: Supabase RLS (Row Level Security)
- Auth: Supabase Auth (auth.uid())
- Database: PostgreSQL 15+

---

## ğŸ”— ì˜ì¡´ ì‘ì—…

**ì„ í–‰ ì‘ì—…**: P1D6 (comments í…Œì´ë¸” - Phase 1ì—ì„œ ìƒì„± ì˜ˆì •)
**í›„ì† ì‘ì—…**: P3F3 (ëŒ“ê¸€ ì»´í¬ë„ŒíŠ¸ - Phase 3)

---

## âœ… ì™„ë£Œ ê¸°ì¤€

1. RLS í™œì„±í™” ì™„ë£Œ
2. 4ê°œ ì •ì±… ìƒì„± ì™„ë£Œ
3. ë³¸ì¸ ëŒ“ê¸€ CRUD í…ŒìŠ¤íŠ¸ í†µê³¼
4. íƒ€ì¸ ëŒ“ê¸€ ìˆ˜ì • ì°¨ë‹¨ í™•ì¸
5. ê³„ì¸µ êµ¬ì¡° ëŒ“ê¸€ ê¶Œí•œ í™•ì¸ (ëŒ€ëŒ“ê¸€)
6. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸

---

## ğŸ’» êµ¬í˜„ ìƒì„¸

### 1. comments í…Œì´ë¸” êµ¬ì¡° (ì°¸ê³ )

```sql
-- Phase 1 ë˜ëŠ” Phase 3ì—ì„œ ìƒì„±ë  í…Œì´ë¸” êµ¬ì¡°
CREATE TABLE IF NOT EXISTS comments (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  post_id BIGINT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  parent_id BIGINT REFERENCES comments(id) ON DELETE CASCADE, -- ëŒ€ëŒ“ê¸€
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2. RLS í™œì„±í™”

```sql
-- supabase/migrations/[timestamp]_comments_rls.sql

-- RLS í™œì„±í™”
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;
```

### 3. SELECT ì •ì±… (ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ ê°€ëŠ¥)

```sql
-- ëª¨ë“  ì‚¬ìš©ì(ë¹„ë¡œê·¸ì¸ í¬í•¨)ê°€ ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Comments are viewable by everyone"
ON comments FOR SELECT
USING (true);
```

**ì´ìœ **:
- ëŒ“ê¸€ì€ ê³µê°œ ì •ë³´
- í† ë¡ ì˜ íˆ¬ëª…ì„± ë³´ì¥
- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìë„ ëŒ“ê¸€ ì½ê¸° ê°€ëŠ¥

### 4. INSERT ì •ì±… (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ìƒì„±)

```sql
-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥
CREATE POLICY "Authenticated users can create comments"
ON comments FOR INSERT
WITH CHECK (auth.uid() = user_id);
```

**ë³´ì•ˆ íŠ¹ì§•**:
- ë¡œê·¸ì¸ í•„ìˆ˜
- ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì´ë¦„ìœ¼ë¡œ ëŒ“ê¸€ ì‘ì„± ë¶ˆê°€

### 5. UPDATE ì •ì±… (ë³¸ì¸ ëŒ“ê¸€ë§Œ ìˆ˜ì •)

```sql
-- ë³¸ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Users can update their own comments"
ON comments FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);
```

**ì œí•œì‚¬í•­**:
- user_id, post_id, parent_id ë³€ê²½ ë¶ˆê°€
- contentë§Œ ìˆ˜ì • ê°€ëŠ¥

### 6. DELETE ì •ì±… (ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ìë§Œ ì‚­ì œ)

```sql
-- ë³¸ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€ ë˜ëŠ” ë³¸ì¸ ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Users can delete their own comments or comments on their posts"
ON comments FOR DELETE
USING (
  auth.uid() = user_id  -- ë³¸ì¸ ëŒ“ê¸€
  OR
  auth.uid() = (
    SELECT user_id FROM posts WHERE id = comments.post_id
  ) -- ë³¸ì¸ ê²Œì‹œê¸€ì˜ ëŒ“ê¸€
);
```

**ê¶Œí•œ êµ¬ì¡°**:
1. ëŒ“ê¸€ ì‘ì„±ì: ìì‹ ì˜ ëŒ“ê¸€ ì‚­ì œ ê°€ëŠ¥
2. ê²Œì‹œê¸€ ì‘ì„±ì: ìì‹ ì˜ ê²Œì‹œê¸€ì— ë‹¬ë¦° ëª¨ë“  ëŒ“ê¸€ ì‚­ì œ ê°€ëŠ¥ (ê´€ë¦¬ ê¶Œí•œ)

### 7. ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜ SQL

```sql
-- supabase/migrations/[timestamp]_comments_rls.sql

-- RLS í™œì„±í™”
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

-- SELECT: ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Comments are viewable by everyone"
ON comments FOR SELECT
USING (true);

-- INSERT: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ìƒì„±
CREATE POLICY "Authenticated users can create comments"
ON comments FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- UPDATE: ë³¸ì¸ ëŒ“ê¸€ë§Œ ìˆ˜ì •
CREATE POLICY "Users can update their own comments"
ON comments FOR UPDATE
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- DELETE: ë³¸ì¸ ëŒ“ê¸€ ë˜ëŠ” ë³¸ì¸ ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ì‚­ì œ ê°€ëŠ¥
CREATE POLICY "Users can delete their own comments or comments on their posts"
ON comments FOR DELETE
USING (
  auth.uid() = user_id
  OR
  auth.uid() = (SELECT user_id FROM posts WHERE id = comments.post_id)
);
```

### 8. ë¡¤ë°± SQL

```sql
-- supabase/migrations/[timestamp]_rollback_comments_rls.sql

-- ì •ì±… ì œê±°
DROP POLICY IF EXISTS "Users can delete their own comments or comments on their posts" ON comments;
DROP POLICY IF EXISTS "Users can update their own comments" ON comments;
DROP POLICY IF EXISTS "Authenticated users can create comments" ON comments;
DROP POLICY IF EXISTS "Comments are viewable by everyone" ON comments;

-- RLS ë¹„í™œì„±í™” (ê°œë°œ í™˜ê²½ì—ì„œë§Œ)
-- ALTER TABLE comments DISABLE ROW LEVEL SECURITY;
```

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ê³„íš

### 1. RLS í™œì„±í™” í™•ì¸

```sql
-- RLS ìƒíƒœ í™•ì¸
SELECT tablename, rowsecurity
FROM pg_tables
WHERE tablename = 'comments';

-- ì •ì±… ëª©ë¡ í™•ì¸
SELECT policyname, cmd, qual, with_check
FROM pg_policies
WHERE tablename = 'comments';
```

### 2. INSERT ì •ì±… í…ŒìŠ¤íŠ¸

```typescript
describe('Comments RLS - INSERT', () => {
  test('ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥', async () => {
    const { data, error } = await supabase
      .from('comments')
      .insert({
        post_id: 1,
        content: 'ì¢‹ì€ ê¸€ì…ë‹ˆë‹¤'
      })
      .select()
      .single()

    expect(error).toBeNull()
    expect(data).toBeDefined()
  })

  test('ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ìëŠ” ëŒ“ê¸€ ì‘ì„± ë¶ˆê°€', async () => {
    await supabase.auth.signOut()

    const { error } = await supabase
      .from('comments')
      .insert({
        post_id: 1,
        content: 'ëŒ“ê¸€'
      })

    expect(error).toBeDefined()
  })

  test('ëŒ€ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥', async () => {
    const { data, error } = await supabase
      .from('comments')
      .insert({
        post_id: 1,
        parent_id: commentId, // ë¶€ëª¨ ëŒ“ê¸€ ID
        content: 'ë‹µê¸€ì…ë‹ˆë‹¤'
      })
      .select()
      .single()

    expect(error).toBeNull()
    expect(data.parent_id).toBe(commentId)
  })
})
```

### 3. UPDATE ì •ì±… í…ŒìŠ¤íŠ¸

```typescript
describe('Comments RLS - UPDATE', () => {
  test('ë³¸ì¸ ëŒ“ê¸€ì€ ìˆ˜ì • ê°€ëŠ¥', async () => {
    const { data, error } = await supabase
      .from('comments')
      .update({ content: 'ìˆ˜ì •ëœ ë‚´ìš©' })
      .eq('id', myCommentId)
      .select()
      .single()

    expect(error).toBeNull()
    expect(data.content).toBe('ìˆ˜ì •ëœ ë‚´ìš©')
  })

  test('íƒ€ì¸ ëŒ“ê¸€ì€ ìˆ˜ì • ë¶ˆê°€', async () => {
    const { error } = await supabase
      .from('comments')
      .update({ content: 'í•´í‚¹ ì‹œë„' })
      .eq('id', otherUserCommentId)

    expect(error).toBeDefined()
  })
})
```

### 4. DELETE ì •ì±… í…ŒìŠ¤íŠ¸

```typescript
describe('Comments RLS - DELETE', () => {
  test('ë³¸ì¸ ëŒ“ê¸€ì€ ì‚­ì œ ê°€ëŠ¥', async () => {
    const { error } = await supabase
      .from('comments')
      .delete()
      .eq('id', myCommentId)

    expect(error).toBeNull()
  })

  test('íƒ€ì¸ ëŒ“ê¸€ì€ ì‚­ì œ ë¶ˆê°€', async () => {
    const { error } = await supabase
      .from('comments')
      .delete()
      .eq('id', otherUserCommentId)

    expect(error).toBeDefined()
  })

  test('ê²Œì‹œê¸€ ì‘ì„±ìëŠ” ìì‹ ì˜ ê²Œì‹œê¸€ ëŒ“ê¸€ ì‚­ì œ ê°€ëŠ¥', async () => {
    // postAuthorê°€ ë¡œê·¸ì¸í•œ ìƒíƒœ
    // otherUserê°€ ì‘ì„±í•œ ëŒ“ê¸€ì´ì§€ë§Œ postAuthorì˜ ê²Œì‹œê¸€ì— ë‹¬ë¦¼
    const { error } = await supabase
      .from('comments')
      .delete()
      .eq('id', commentOnMyPost)

    expect(error).toBeNull() // ì‚­ì œ ì„±ê³µ
  })
})
```

### 5. ëŒ€ëŒ“ê¸€ CASCADE í…ŒìŠ¤íŠ¸

```sql
-- ë¶€ëª¨ ëŒ“ê¸€ ì‚­ì œ ì‹œ ëŒ€ëŒ“ê¸€ë„ í•¨ê»˜ ì‚­ì œë˜ëŠ”ì§€ í™•ì¸
DELETE FROM comments WHERE id = parent_comment_id;

-- ëŒ€ëŒ“ê¸€ë„ í•¨ê»˜ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
SELECT COUNT(*) FROM comments WHERE parent_id = parent_comment_id;
-- ê²°ê³¼: 0
```

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### ì£¼ìš” ë³´ì•ˆ íŠ¹ì§•

1. **2ë‹¨ê³„ ì‚­ì œ ê¶Œí•œ**
   - ëŒ“ê¸€ ì‘ì„±ì: ìì‹ ì˜ ëŒ“ê¸€ ì‚­ì œ
   - ê²Œì‹œê¸€ ì‘ì„±ì: ìì‹ ì˜ ê²Œì‹œê¸€ì— ë‹¬ë¦° ëª¨ë“  ëŒ“ê¸€ ì‚­ì œ (ëª¨ìš•ì /ë¶€ì ì ˆí•œ ëŒ“ê¸€ ê´€ë¦¬)

2. **ê³„ì¸µ êµ¬ì¡° ì§€ì›**
   - parent_idë¥¼ í†µí•œ ëŒ€ëŒ“ê¸€ ì§€ì›
   - ON DELETE CASCADEë¡œ ë¶€ëª¨ ëŒ“ê¸€ ì‚­ì œ ì‹œ ìë™ ì •ë¦¬

3. **ì½˜í…ì¸  ë¬´ê²°ì„±**
   - user_id, post_id ë³€ê²½ ë¶ˆê°€
   - contentë§Œ ìˆ˜ì • ê°€ëŠ¥

4. **íˆ¬ëª…ì„±**
   - ëª¨ë“  ëŒ“ê¸€ ê³µê°œ
   - ê±´ì „í•œ í† ë¡  ë¬¸í™” ì¡°ì„±

### XSS ë°©ì–´

```typescript
// í”„ë¡ íŠ¸ì—”ë“œì—ì„œ XSS ë°©ì–´ í•„ìš”
import DOMPurify from 'dompurify'

function CommentDisplay({ comment }: { comment: Comment }) {
  const sanitizedContent = DOMPurify.sanitize(comment.content)

  return (
    <div dangerouslySetInnerHTML={{ __html: sanitizedContent }} />
  )
}
```

### Rate Limiting

```typescript
// API Routeì—ì„œ Rate Limiting ì ìš©
// 1ë¶„ì— ìµœëŒ€ 10ê°œ ëŒ“ê¸€ ì‘ì„± ì œí•œ
import rateLimit from '@/lib/rate-limit'

const limiter = rateLimit({
  interval: 60 * 1000, // 1ë¶„
  uniqueTokenPerInterval: 500
})

export async function POST(request: Request) {
  try {
    await limiter.check(request, 10, 'COMMENT_RATE_LIMIT')
    // ëŒ“ê¸€ ìƒì„± ë¡œì§
  } catch {
    return new Response('Too many requests', { status: 429 })
  }
}
```

---

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

**ì‘ì—… ì™„ë£Œ ì¼ì‹œ**: 2025-01-17
**í…ŒìŠ¤íŠ¸/ê²€í†  ê²°ê³¼**: RLS ì •ì±… ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ì™„ë£Œ, ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„± ì™„ë£Œ
**ìë™í™” ë°©ì‹**: AI-only
**ë¸”ë¡œì»¤**: P1D6 (comments í…Œì´ë¸” ìƒì„± ëŒ€ê¸°)
**ë¹„ê³ **:
- Phase 3ì—ì„œ ì‹¤ì œ ì‚¬ìš©
- Phase 2ì—ì„œ ë¯¸ë¦¬ ì„¤ì •í•˜ì—¬ Phase 3 ì‘ì—… ê°„ì†Œí™”
- ê²Œì‹œê¸€ ì‘ì„±ìì˜ ëŒ“ê¸€ ê´€ë¦¬ ê¶Œí•œì€ ì»¤ë®¤ë‹ˆí‹° ê´€ë¦¬ì— í•„ìˆ˜
- í–¥í›„ ê´€ë¦¬ì ì—­í•  ì¶”ê°€ ì‹œ ë³„ë„ ì •ì±… í•„ìš”

---

**ì‘ì„± ë°©ë²•ë¡ **: 15DGC-AODM v3.0
**AI-Only ì›ì¹™ ì¤€ìˆ˜**: âœ…
