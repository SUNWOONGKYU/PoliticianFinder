# P1S1 - HTTPS 및 보안 헤더 설정

## 작업 ID
P1S1

## 담당 영역
Security

## 작업 개요
HTTPS를 강제하고 보안 관련 HTTP 헤더를 설정하여 웹 애플리케이션의 보안을 강화합니다.

## 상세 설명
XSS, Clickjacking, MIME 스니핑 등의 공격을 방지하기 위한 보안 헤더를 설정하고, HTTPS를 강제합니다.

## 기술 스택
- Next.js Security Headers
- Vercel HTTPS
- CSP (Content Security Policy)

## 구현 사항
1. HTTPS 강제 리다이렉트
2. 보안 헤더 설정 (CSP, HSTS, X-Frame-Options 등)
3. CORS 설정
4. 쿠키 보안 설정
5. 보안 스캔 및 검증

## next.config.js 보안 헤더 설정
```javascript
// next.config.js
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=63072000; includeSubDomains; preload'
  },
  {
    key: 'X-Frame-Options',
    value: 'SAMEORIGIN'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin'
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()'
  },
  {
    key: 'Content-Security-Policy',
    value: ContentSecurityPolicy.replace(/\s{2,}/g, ' ').trim()
  }
]

const ContentSecurityPolicy = `
  default-src 'self';
  script-src 'self' 'unsafe-eval' 'unsafe-inline' *.vercel-insights.com;
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https: blob:;
  font-src 'self' data:;
  connect-src 'self' *.supabase.co *.vercel-insights.com;
  frame-src 'self';
  object-src 'none';
  base-uri 'self';
  form-action 'self';
  frame-ancestors 'none';
  upgrade-insecure-requests;
`

module.exports = {
  async headers() {
    return [
      {
        source: '/:path*',
        headers: securityHeaders,
      },
    ]
  },
}
```

## HTTPS 강제 리다이렉트 (Vercel 자동 처리)
Vercel은 자동으로 모든 HTTP 요청을 HTTPS로 리다이렉트합니다.

## 쿠키 보안 설정
```javascript
// API Route에서 쿠키 설정 시
res.setHeader('Set-Cookie', [
  `session=${token}; Path=/; HttpOnly; Secure; SameSite=Strict; Max-Age=86400`
])
```

## CORS 설정
```javascript
// pages/api/[...].js
export default async function handler(req, res) {
  // CORS 헤더 설정
  res.setHeader('Access-Control-Allow-Credentials', 'true')
  res.setHeader('Access-Control-Allow-Origin', process.env.NEXT_PUBLIC_APP_URL)
  res.setHeader('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE,OPTIONS')
  res.setHeader(
    'Access-Control-Allow-Headers',
    'X-Requested-With, Content-Type, Authorization'
  )

  // OPTIONS 요청 처리
  if (req.method === 'OPTIONS') {
    res.status(200).end()
    return
  }

  // 실제 로직
}
```

## 보안 헤더 설명

### 1. Strict-Transport-Security (HSTS)
- 브라우저가 항상 HTTPS로만 접속하도록 강제
- 중간자 공격 방지

### 2. X-Frame-Options
- Clickjacking 공격 방지
- 다른 사이트에서 iframe으로 삽입 차단

### 3. X-Content-Type-Options
- MIME 스니핑 방지
- 브라우저가 Content-Type을 무시하지 못하도록

### 4. Content-Security-Policy (CSP)
- XSS 공격 방지
- 허용된 소스에서만 리소스 로드

### 5. X-XSS-Protection
- 브라우저의 XSS 필터 활성화

### 6. Referrer-Policy
- 외부 사이트로 정보 유출 최소화

## 보안 검증 도구
1. **Mozilla Observatory**: https://observatory.mozilla.org/
2. **Security Headers**: https://securityheaders.com/
3. **SSL Labs**: https://www.ssllabs.com/ssltest/

## 테스트 체크리스트
```bash
# 보안 헤더 확인
curl -I https://your-domain.com

# CSP 위반 테스트
# 브라우저 콘솔에서 CSP 위반 로그 확인
```

## 보안 점검 항목
- [ ] HTTPS 강제 적용 (HTTP → HTTPS 리다이렉트)
- [ ] HSTS 헤더 설정
- [ ] X-Frame-Options 설정
- [ ] CSP 설정
- [ ] X-Content-Type-Options 설정
- [ ] 쿠키 Secure, HttpOnly, SameSite 플래그
- [ ] CORS 적절히 제한

## 성공 기준
- [ ] 모든 보안 헤더 설정 완료
- [ ] HTTPS 강제 적용 확인
- [ ] Mozilla Observatory A+ 등급
- [ ] Security Headers A 등급 이상
- [ ] CSP 위반 없음
- [ ] 쿠키 보안 플래그 적용

## 의존 작업
- P1A1 (Vercel 배포)

## 예상 소요 시간
2시간

## 참고 사항
- CSP는 점진적으로 강화 (처음엔 report-only 모드)
- Vercel은 자동으로 SSL 인증서 발급 및 갱신
- 외부 서비스(Google Fonts, Analytics 등) CSP에 추가 필요
- 개발 환경과 프로덕션 환경 CSP 분리 고려
