# P1T3 - API 통합 테스트

## 작업 ID
P1T3

## 담당 영역
Test & QA

## 작업 개요
Backend API Route와 Supabase 연동에 대한 통합 테스트를 작성합니다.

## 상세 설명
회원가입, 로그인, 프로필 조회/수정 등 API 엔드포인트의 정상 작동을 검증하는 통합 테스트를 구현합니다.

## 기술 스택
- Jest
- Supertest (API 테스트)
- Supabase Test Client
- MSW (Mock Service Worker)

## 구현 사항
1. API 테스트 환경 설정
2. 회원가입 API 테스트
3. 로그인 API 테스트
4. 프로필 조회 API 테스트
5. 프로필 수정 API 테스트
6. Supabase 클라이언트 모킹

## 설치 패키지
```bash
npm install --save-dev supertest msw
```

## API 테스트 예시

### 회원가입 API 테스트
```javascript
// __tests__/api/signup.test.js
import { createMocks } from 'node-mocks-http'
import signupHandler from '@/pages/api/auth/signup'

describe('/api/auth/signup', () => {
  it('유효한 데이터로 회원가입 성공', async () => {
    const { req, res } = createMocks({
      method: 'POST',
      body: {
        email: 'test@example.com',
        password: 'password123',
        name: '홍길동'
      }
    })

    await signupHandler(req, res)

    expect(res._getStatusCode()).toBe(200)
    expect(JSON.parse(res._getData())).toHaveProperty('user')
  })

  it('중복 이메일로 회원가입 실패', async () => {
    const { req, res } = createMocks({
      method: 'POST',
      body: {
        email: 'existing@example.com',
        password: 'password123'
      }
    })

    await signupHandler(req, res)

    expect(res._getStatusCode()).toBe(400)
  })
})
```

### Supabase 모킹
```javascript
// __mocks__/supabase.js
export const mockSupabase = {
  auth: {
    signUp: jest.fn(),
    signInWithPassword: jest.fn(),
    getUser: jest.fn(),
    signOut: jest.fn(),
  },
  from: jest.fn(() => ({
    select: jest.fn().mockReturnThis(),
    insert: jest.fn().mockReturnThis(),
    update: jest.fn().mockReturnThis(),
    delete: jest.fn().mockReturnThis(),
    eq: jest.fn().mockReturnThis(),
    single: jest.fn(),
  })),
}
```

## 테스트 시나리오
1. **회원가입 플로우**
   - 정상 회원가입
   - 중복 이메일 검증
   - 비밀번호 강도 검증

2. **로그인 플로우**
   - 정상 로그인
   - 잘못된 비밀번호
   - 존재하지 않는 사용자

3. **프로필 관리**
   - 프로필 조회
   - 프로필 수정
   - 권한 검증

## 성공 기준
- [ ] API 테스트 환경 설정 완료
- [ ] 회원가입 API 테스트 5개 이상 작성 및 통과
- [ ] 로그인 API 테스트 5개 이상 작성 및 통과
- [ ] 프로필 API 테스트 5개 이상 작성 및 통과
- [ ] Supabase 모킹 정상 작동
- [ ] 전체 API 테스트 통과

## 의존 작업
- P1T1 (Jest 테스트 환경 설정)
- P1B3~P1B6 (Backend API Routes)

## 예상 소요 시간
3시간

## 참고 사항
- 테스트 DB 환경 분리 (별도 Supabase 프로젝트 권장)
- 각 테스트 후 데이터 정리 (cleanup)
- 비동기 처리 주의
