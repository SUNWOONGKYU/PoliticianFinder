# P1A4 - 모니터링 및 로깅

## 작업 ID
P1A4

## 담당 영역
DevOps

## 작업 개요
애플리케이션의 성능, 에러, 사용자 행동을 모니터링하고 로깅하는 시스템을 구축합니다.

## 상세 설명
Vercel Analytics, Sentry, Supabase Logs를 통합하여 실시간 모니터링 및 에러 추적 체계를 구축합니다.

## 기술 스택
- Vercel Analytics
- Sentry (에러 추적)
- Supabase Logs
- Console 로깅

## 구현 사항
1. Vercel Analytics 설정
2. Sentry 에러 추적 설정
3. 구조화된 로깅 시스템
4. 성능 모니터링
5. 알림 설정

## 1. Vercel Analytics 설정

### 설치
```bash
npm install @vercel/analytics
```

### _app.js 통합
```javascript
// pages/_app.js
import { Analytics } from '@vercel/analytics/react'

function MyApp({ Component, pageProps }) {
  return (
    <>
      <Component {...pageProps} />
      <Analytics />
    </>
  )
}

export default MyApp
```

## 2. Sentry 에러 추적

### 설치
```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

### sentry.client.config.js
```javascript
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 1.0,
  environment: process.env.NODE_ENV,
  integrations: [
    new Sentry.BrowserTracing(),
    new Sentry.Replay({
      maskAllText: true,
      blockAllMedia: true,
    }),
  ],
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
})
```

### sentry.server.config.js
```javascript
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 1.0,
  environment: process.env.NODE_ENV,
})
```

### 에러 캡처 예시
```javascript
try {
  await someAsyncFunction()
} catch (error) {
  Sentry.captureException(error, {
    tags: {
      section: 'authentication',
    },
    extra: {
      userId: user?.id,
    },
  })
  console.error('Error:', error)
}
```

## 3. 구조화된 로깅 시스템

### utils/logger.js
```javascript
const LOG_LEVELS = {
  ERROR: 'ERROR',
  WARN: 'WARN',
  INFO: 'INFO',
  DEBUG: 'DEBUG',
}

class Logger {
  log(level, message, data = {}) {
    const timestamp = new Date().toISOString()
    const logEntry = {
      timestamp,
      level,
      message,
      ...data,
    }

    if (process.env.NODE_ENV === 'production') {
      // 프로덕션: 구조화된 JSON 로그
      console.log(JSON.stringify(logEntry))
    } else {
      // 개발: 읽기 쉬운 로그
      console.log(`[${timestamp}] [${level}] ${message}`, data)
    }

    // 에러는 Sentry로 전송
    if (level === LOG_LEVELS.ERROR) {
      if (typeof window !== 'undefined') {
        Sentry?.captureMessage(message, {
          level: 'error',
          extra: data,
        })
      }
    }
  }

  error(message, data) {
    this.log(LOG_LEVELS.ERROR, message, data)
  }

  warn(message, data) {
    this.log(LOG_LEVELS.WARN, message, data)
  }

  info(message, data) {
    this.log(LOG_LEVELS.INFO, message, data)
  }

  debug(message, data) {
    if (process.env.NODE_ENV !== 'production') {
      this.log(LOG_LEVELS.DEBUG, message, data)
    }
  }
}

export const logger = new Logger()
```

### 사용 예시
```javascript
import { logger } from '@/utils/logger'

logger.info('User logged in', { userId: user.id, email: user.email })
logger.error('Failed to fetch data', { error: error.message, endpoint: '/api/politicians' })
logger.warn('Slow query detected', { duration: 3000, query: 'SELECT * FROM politicians' })
```

## 4. 성능 모니터링

### Web Vitals 측정
```javascript
// pages/_app.js
import { sendToAnalytics } from '@/utils/analytics'

export function reportWebVitals(metric) {
  if (metric.label === 'web-vital') {
    sendToAnalytics(metric)
  }
}
```

### utils/analytics.js
```javascript
export function sendToAnalytics(metric) {
  const body = JSON.stringify(metric)
  
  if (navigator.sendBeacon) {
    navigator.sendBeacon('/api/analytics', body)
  } else {
    fetch('/api/analytics', {
      body,
      method: 'POST',
      keepalive: true,
    })
  }
}
```

## 5. Supabase Logs 활용

Supabase Dashboard → Logs에서:
- API 요청 로그
- 데이터베이스 쿼리 로그
- 에러 로그
- 실시간 모니터링

## 6. 알림 설정

### Sentry 알림
- 새로운 에러 발생 시
- 에러 빈도 급증 시
- 배포 후 에러 발생 시

### Vercel 알림
- 배포 성공/실패
- 빌드 실패
- 도메인 이슈

## 환경 변수 추가
```bash
# .env.local
NEXT_PUBLIC_SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
SENTRY_AUTH_TOKEN=your-auth-token
```

## 대시보드 구성
1. Vercel Dashboard: 배포, 성능, 트래픽
2. Sentry Dashboard: 에러, 스택 트레이스, 사용자 영향
3. Supabase Dashboard: 데이터베이스 성능, API 요청

## 성공 기준
- [ ] Vercel Analytics 설치 및 작동
- [ ] Sentry 설정 완료 및 에러 캡처 테스트
- [ ] 구조화된 로깅 시스템 구현
- [ ] Web Vitals 측정 및 리포팅
- [ ] 알림 설정 완료
- [ ] 테스트 에러 발생 시 Sentry에 기록됨

## 의존 작업
- P1A1 (Vercel 배포)
- P1A2 (환경 변수 관리)

## 예상 소요 시간
2.5시간

## 참고 사항
- Sentry 무료 티어: 월 5,000 이벤트
- Vercel Analytics: 무료 (기본 기능)
- 민감한 정보는 로그에서 제외
- 프로덕션 로그는 JSON 형식으로 구조화
